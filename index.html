<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة الرصد التعاوني المتقدمة</title>
    <!-- روابط خارجية -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-hijri/2.1.2/moment-hijri.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #06b6d4;
            --background-color: #f8fafc;
            --surface-color: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            --gradient-warning: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            --gradient-error: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* تحسينات الرسوم المتحركة */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translateY(0); }
            40%, 43% { transform: translateY(-10px); }
            70% { transform: translateY(-5px); }
        }

        /* شاشة تسجيل الدخول */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><polygon fill="%23ffffff08" points="0,1000 1000,0 1000,1000"/></svg>');
            animation: pulse 4s ease-in-out infinite;
        }

        .login-card {
            background: var(--surface-color);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 450px;
            position: relative;
            z-index: 1;
            animation: fadeIn 0.8s ease-out;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

          /* النماذج المحسنة */
        .enhanced-form {
            max-width: 600px;
            margin: 0 auto;
        }

        /* النموذج الحديث المطور */
        .modern-form-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .form-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
        }

        .form-icon {
            font-size: 2.5rem;
            opacity: 0.9;
        }

        .form-title h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .form-title p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .modern-form {
            background: white;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .form-section {
            padding: 2rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .section-header i {
            font-size: 1.2rem;
        }

        .enhanced-form .form-row {
            margin-bottom: 1.5rem;
        }

        .enhanced-form .form-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .enhanced-form .form-label.required::after {
            content: ' *';
            color: #dc3545;
            font-weight: bold;
        }

        .enhanced-form .form-input,
        .enhanced-form .form-textarea,
        .enhanced-form .form-select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: var(--surface-color);
            font-family: inherit;
        }

        .modern-input,
        .modern-textarea,
        .modern-select {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 1rem 1.25rem;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #fafbfc;
        }

        .modern-input:focus,
        .modern-textarea:focus,
        .modern-select:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            transform: translateY(-1px);
        }

        .enhanced-form .form-input:focus,
        .enhanced-form .form-textarea:focus,
        .enhanced-form .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .enhanced-form .form-help {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            line-height: 1.4;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .char-counter {
            text-align: left;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* منتقي الألوان المحسن */
        .color-picker-enhanced {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .color-input-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .modern-color {
            width: 80px;
            height: 50px;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modern-color:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .color-preview-enhanced {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 120px;
            height: 50px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            background: var(--surface-color);
            font-weight: 600;
            font-size: 0.9rem;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .color-presets {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .preset-color {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
        }

        .preset-color:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
        }

        .preset-color[data-color="#007bff"] { background-color: #007bff; }
        .preset-color[data-color="#28a745"] { background-color: #28a745; }
        .preset-color[data-color="#dc3545"] { background-color: #dc3545; }
        .preset-color[data-color="#ffc107"] { background-color: #ffc107; }
        .preset-color[data-color="#6f42c1"] { background-color: #6f42c1; }
        .preset-color[data-color="#fd7e14"] { background-color: #fd7e14; }

        /* منتقي الأولوية */
        .priority-selector {
            position: relative;
        }

        .priority-indicator {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ffc107;
            transition: all 0.3s ease;
        }

        /* مفتاح التبديل المحسن */
        .status-toggle-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-switch-enhanced {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .modern-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .modern-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .modern-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: 0.4s;
            border-radius: 30px;
        }

        .modern-slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .modern-switch input:checked + .modern-slider {
            background-color: var(--primary-color);
        }

        .modern-switch input:checked + .modern-slider:before {
            transform: translateX(30px);
        }

        .switch-labels {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .switch-label {
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .switch-label.active {
            color: var(--success-color);
        }

        .switch-label.inactive {
            color: var(--text-secondary);
        }

        .status-description {
            padding: 0.75rem 1rem;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* أزرار حديثة */
        .modern-actions {
            padding: 2rem;
            background: #f8fafc;
            border-radius: 0 0 12px 12px;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .modern-btn {
            position: relative;
            overflow: hidden;
            padding: 0.875rem 2rem;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
            cursor: pointer;
        }

        .primary-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .secondary-btn {
            background: white;
            color: var(--text-primary);
            border: 2px solid #e2e8f0;
        }

        .secondary-btn:hover {
            background: #f8fafc;
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .btn-ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* أزرار الإجراءات المحسنة */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            justify-content: center;
        }

        .action-buttons .btn {
            min-width: 80px;
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .action-buttons .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .action-buttons .btn-outline {
            background: white;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .action-buttons .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        .action-buttons .btn-danger {
            background: #dc3545;
            border: 1px solid #dc3545;
            color: white;
        }

        .action-buttons .btn-danger:hover {
            background: #c82333;
            border-color: #bd2130;
        }

        /* الفلاتر المحسنة */
        .enhanced-filters-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f3f4f6;
        }

        .filters-header h4 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-label i {
            color: var(--primary-color);
            width: 16px;
        }

        .filter-input, .filter-select {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: white;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-input:hover, .filter-select:hover {
            border-color: #d1d5db;
        }

        .filter-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            margin-top: 1rem;
        }

        .filter-result {
            color: #6b7280;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-result span {
            font-weight: 600;
            color: var(--primary-color);
        }

        .filter-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* تحسين الجدول */
        .data-table {
            border-collapse: collapse;
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, var(--primary-color), #1e40af);
            color: white;
            padding: 1rem 0.75rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: 2px solid #1e40af;
        }

        .data-table td {
            padding: 0.875rem 0.75rem;
            text-align: center;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
        }

        .data-table tbody tr:hover {
            background-color: #f8fafc;
        }

        .data-table tbody tr:nth-child(even) {
            background-color: #fafbfc;
        }

        .data-table tbody tr:nth-child(even):hover {
            background-color: #f1f5f9;
        }

        /* تحسين أزرار الجدول */
        .table-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin: 0 0.2rem;
        }

        .table-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .table-btn.edit {
            background: #3b82f6;
            color: white;
        }

        .table-btn.edit:hover {
            background: #2563eb;
        }

        .table-btn.delete {
            background: #ef4444;
            color: white;
        }

        .table-btn.delete:hover {
            background: #dc2626;
        }

        /* تحسين مودال الاستيراد */
        .import-instructions {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .import-instructions h4 {
            color: var(--primary-color);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .import-instructions ul {
            margin: 0;
            padding-left: 1.5rem;
        }

        .import-instructions li {
            margin-bottom: 0.5rem;
            color: #4b5563;
            font-size: 0.9rem;
        }

        .import-progress {
            margin: 1rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), #10b981);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* أنماط المودال المحسن */
        .large-modal {
            max-width: 900px;
            width: 90%;
        }

        .instruction-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .instruction-header i {
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .instruction-content {
            margin-bottom: 1.5rem;
        }

        .instruction-section {
            margin-bottom: 1.5rem;
        }

        .instruction-section h5 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .columns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .column-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .column-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        .column-number {
            background: var(--primary-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .column-info strong {
            display: block;
            color: #1f2937;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .column-info small {
            color: #6b7280;
            font-size: 0.8rem;
        }

        .important-notes {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .important-notes li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #f3f4f6;
            position: relative;
            padding-left: 1.5rem;
        }

        .important-notes li:before {
            content: "⚠️";
            position: absolute;
            left: 0;
            top: 0.5rem;
        }

        .important-notes li:last-child {
            border-bottom: none;
        }

        .download-template {
            text-align: center;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .upload-section {
            margin-bottom: 1.5rem;
        }

        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            background: #fafbfc;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .file-upload-area:hover {
            border-color: var(--primary-color);
            background: #f0f9ff;
        }

        .file-upload-area.dragover {
            border-color: var(--primary-color);
            background: #eff6ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .upload-text h4 {
            margin: 0 0 0.5rem 0;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .upload-text p {
            margin: 0;
            color: #6b7280;
            font-size: 0.9rem;
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-info {
            margin-top: 1rem;
        }

        .file-details {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .file-details i {
            font-size: 2rem;
            color: #10b981;
        }

        .file-text {
            flex: 1;
        }

        .file-name {
            display: block;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .file-size {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .remove-file {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-file:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .import-options {
            margin-bottom: 1.5rem;
        }

        .import-options h5 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .options-grid {
            display: grid;
            gap: 1rem;
        }

        .option-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-item:hover {
            border-color: var(--primary-color);
            background: #f0f9ff;
        }

        .option-item input[type="checkbox"] {
            margin: 0;
        }

        .option-text strong {
            display: block;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .option-text small {
            color: #6b7280;
            font-size: 0.85rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .progress-title {
            font-weight: 600;
            color: #1f2937;
        }

        .progress-percentage {
            font-weight: 600;
            color: var(--primary-color);
        }

        .progress-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .import-results {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
        }

        .results-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .result-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border-radius: 6px;
        }

        .result-item.success {
            background: #dcfce7;
            color: #166534;
        }

        .result-item.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .result-item i {
            font-size: 1.2rem;
        }

        .error-details h6 {
            margin-bottom: 0.5rem;
            color: #991b1b;
        }

        .error-list {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 0.5rem;
        }

        .error-item {
            padding: 0.5rem;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.9rem;
            color: #991b1b;
        }

        .error-item:last-child {
            border-bottom: none;
        }

        /* أنماط النموذج الحديث */
        .modern-form-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #f3f4f6;
        }

        .form-icon {
            background: linear-gradient(135deg, var(--primary-color), #1e40af);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .form-title h3 {
            margin: 0 0 0.5rem 0;
            color: #1f2937;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .form-title p {
            margin: 0;
            color: #6b7280;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .modern-form {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .form-section {
            background: #fafbfc;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .form-section:hover {
            border-color: #d1d5db;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .section-header i {
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .section-header span {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
        }

        .form-row {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-weight: 500;
            color: #374151;
            font-size: 0.95rem;
        }

        .form-label.required::after {
            content: "*";
            color: #ef4444;
            margin-left: 0.25rem;
        }

        .form-label i {
            color: var(--primary-color);
            width: 16px;
        }

        .modern-input, .modern-select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }

        .modern-input:focus, .modern-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .modern-input:hover, .modern-select:hover {
            border-color: #d1d5db;
        }

        .modern-input::placeholder {
            color: #9ca3af;
        }

        .form-help {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #6b7280;
        }

        .form-help i {
            color: var(--primary-color);
            font-size: 0.8rem;
        }

        .char-counter {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 0.8rem;
            color: #9ca3af;
            background: white;
            padding: 0 0.5rem;
        }

        .validation-message {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            padding: 0.5rem;
            border-radius: 6px;
            display: none;
        }

        .validation-message.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
            display: block;
        }

        .validation-message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
            display: block;
        }

        .role-selector {
            position: relative;
        }

        .role-indicator {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transition: all 0.3s ease;
            z-index: 1;
        }

        .password-input-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .password-toggle:hover {
            color: var(--primary-color);
            background: #f3f4f6;
        }

        .password-strength {
            margin-top: 0.75rem;
        }

        .strength-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .strength-fill {
            height: 100%;
            width: 0%;
            transition: all 0.3s ease;
            border-radius: 3px;
        }

        .strength-fill.weak {
            background: #ef4444;
            width: 25%;
        }

        .strength-fill.fair {
            background: #f59e0b;
            width: 50%;
        }

        .strength-fill.good {
            background: #10b981;
            width: 75%;
        }

        .strength-fill.strong {
            background: #059669;
            width: 100%;
        }

        .strength-text {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .strength-text.weak {
            color: #ef4444;
        }

        .strength-text.fair {
            color: #f59e0b;
        }

        .strength-text.good {
            color: #10b981;
        }

        .strength-text.strong {
            color: #059669;
        }

        .status-toggle-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .form-switch-enhanced {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .modern-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .modern-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .modern-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }

        .modern-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .modern-slider {
            background-color: var(--primary-color);
        }

        input:checked + .modern-slider:before {
            transform: translateX(26px);
        }

        .switch-labels {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .switch-label {
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .switch-label.active {
            color: var(--primary-color);
        }

        .switch-label.inactive {
            color: #6b7280;
        }

        .status-description {
            font-size: 0.85rem;
            color: #6b7280;
            padding: 0.5rem;
            background: #f8fafc;
            border-radius: 6px;
            border-left: 3px solid var(--primary-color);
        }

        .notification-settings {
            margin-top: 1rem;
        }

        .modern-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .modern-btn {
            position: relative;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            overflow: hidden;
        }

        .modern-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .primary-btn {
            background: linear-gradient(135deg, var(--primary-color), #1e40af);
            color: white;
        }

        .primary-btn:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }

        .secondary-btn {
            background: #f8fafc;
            color: #374151;
            border: 1px solid #e5e7eb;
        }

        .secondary-btn:hover {
            background: #f1f5f9;
            border-color: #d1d5db;
        }

        .btn-ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* منتقي الألوان */
        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .form-color-input {
            width: 60px;
            height: 40px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-color-input:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .color-presets {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .color-preset {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .color-preset:hover {
            border-color: var(--primary-color);
            transform: scale(1.1);
        }

        .color-preview {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            text-align: center;
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }

        /* أنماط التقويم الشهري */
        .monthly-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .month-navigation {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .nav-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .nav-btn:hover {
            background: #2563eb;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .current-month-display {
            text-align: center;
            min-width: 200px;
        }

        .hijri-month {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .gregorian-month {
            font-size: 1rem;
            color: #6b7280;
            font-weight: 500;
        }

        .month-actions {
            display: flex;
            gap: 0.75rem;
        }

        .monthly-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .stat-icon.morning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .stat-icon.evening {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .stat-icon.night {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
        }

        .stat-icon.full-day {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .stat-content {
            flex: 1;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .monthly-calendar-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f3f4f6;
        }

        .calendar-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .calendar-legend {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #374151;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .legend-color.morning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .legend-color.evening {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .legend-color.night {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
        }

        .legend-color.full-day {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .calendar-grid {
            width: 100%;
        }

        .calendar-header-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            margin-bottom: 1px;
        }

        .day-header {
            background: linear-gradient(135deg, var(--primary-color), #1e40af);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e5e7eb;
        }

        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
        }

        .calendar-day:hover {
            background: #f8fafc;
            border-color: var(--primary-color);
        }

        .calendar-day.selected {
            background: #eff6ff;
            border-color: var(--primary-color);
            box-shadow: inset 0 0 0 1px var(--primary-color);
        }

        .calendar-day.other-month {
            background: #f9fafb;
            color: #9ca3af;
        }

        .calendar-day.today {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .day-number {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hijri-day {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .day-shifts {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .shift-indicator {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            color: white;
            text-align: center;
            font-weight: 500;
        }

        .shift-indicator.morning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .shift-indicator.evening {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .shift-indicator.night {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
        }

        .shift-indicator.full-day {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .shifts-management {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .shifts-sidebar {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            height: fit-content;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .sidebar-header h4 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .users-filters {
            margin-bottom: 1.5rem;
        }

        .users-filters .filter-group {
            margin-bottom: 1rem;
        }

        .users-filters label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: #374151;
        }

        .users-filters select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .users-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .user-item {
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-item:hover {
            border-color: var(--primary-color);
            background: #f8fafc;
        }

        .user-item.selected {
            border-color: var(--primary-color);
            background: #eff6ff;
        }

        .user-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .user-details {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .shift-details {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .details-header h4 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .selected-date {
            font-size: 0.9rem;
            color: #6b7280;
            background: #f3f4f6;
            padding: 0.5rem 1rem;
            border-radius: 6px;
        }

        .day-shifts-details {
            min-height: 200px;
            margin-bottom: 1.5rem;
        }

        .no-selection {
            text-align: center;
            color: #9ca3af;
            padding: 2rem;
        }

        .no-selection i {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .edit-tools {
            display: flex;
            gap: 0.75rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .users-statistics {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .stats-header h4 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stats-actions {
            display: flex;
            gap: 0.5rem;
        }

        .stats-table-container {
            overflow-x: auto;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .stats-table th {
            background: #f8fafc;
            color: #374151;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
        }

        .stats-table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid #f3f4f6;
        }

        .stats-table tbody tr:hover {
            background: #f8fafc;
        }

        .attendance-rate {
            font-weight: 600;
        }

        .attendance-rate.excellent {
            color: #059669;
        }

        .attendance-rate.good {
            color: #10b981;
        }

        .attendance-rate.average {
            color: #f59e0b;
        }

        .attendance-rate.poor {
            color: #ef4444;
        }

        /* تحسينات متجاوبة */
        @media (max-width: 768px) {
            .monthly-controls {
                flex-direction: column;
                gap: 1rem;
            }

            .month-navigation {
                order: 2;
            }

            .month-actions {
                order: 1;
                flex-wrap: wrap;
            }

            .shifts-management {
                grid-template-columns: 1fr;
            }

            .calendar-legend {
                justify-content: center;
            }

            .monthly-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-color-input:hover {
            border-color: var(--primary-color);
        }

        .color-preview {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 120px;
            height: 40px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        /* مفتاح التبديل */
        .form-switch-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .form-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .form-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .form-switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .form-switch-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .form-switch input:checked + .form-switch-slider {
            background-color: var(--primary-color);
        }

        .form-switch input:checked + .form-switch-slider:before {
            transform: translateX(26px);
        }

        .form-switch-label {
            font-size: 0.95rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--surface-color);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
            transform: translateY(-2px);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        /* التطبيق الرئيسي */
        .app-container {
            display: none;
            min-height: 100vh;
            background: var(--background-color);
        }

        .app-header {
            background: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .app-nav {
            display: flex;
            gap: 1rem;
        }

        .nav-item {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .nav-item.active {
            background: var(--primary-color);
            color: white;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notification-badge {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .notification-badge:hover {
            background: var(--background-color);
        }

        .badge-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: bounce 2s infinite;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .user-info:hover {
            background: var(--background-color);
        }

        /* القائمة المنسدلة للمستخدم */
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border-color);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: var(--background-color);
            color: var(--primary-color);
        }

        .dropdown-item i {
            width: 16px;
            text-align: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .main-content {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        .sidebar {
            width: 280px;
            background: var(--surface-color);
            border-left: 1px solid var(--border-color);
            padding: 2rem 0;
            box-shadow: var(--shadow-sm);
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-item {
            margin: 0.25rem 1rem;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            border-radius: 12px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .sidebar-link:hover {
            background: var(--background-color);
            color: var(--primary-color);
            transform: translateX(-5px);
        }

        .sidebar-link.active {
            background: var(--primary-color);
            color: white;
        }

        .content-area {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .page-header {
            margin-bottom: 2rem;
            animation: fadeIn 0.6s ease-out;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* البطاقات */
        .card {
            background: var(--surface-color);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            animation: fadeIn 0.8s ease-out;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--surface-color);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .stat-change {
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--error-color);
        }

        /* بطاقات الإحصائيات المحسنة */
        .stat-card.primary::before {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card.success::before {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stat-card.warning::before {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stat-card.danger::before {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .stat-change {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-change.positive {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-color);
        }

        .stat-change.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
        }

        /* صفوف لوحة التحكم */
        .dashboard-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .dashboard-card {
            background: var(--surface-color);
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .dashboard-card.full-width {
            grid-column: 1 / -1;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-content {
            padding: 1.5rem;
        }

        /* قائمة الملاحظات الحديثة */
        .recent-observation-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .recent-observation-item:last-child {
            border-bottom: none;
        }

        .recent-observation-item:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .observation-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 1rem;
            font-size: 1.125rem;
        }

        .observation-content {
            flex: 1;
        }

        .observation-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .observation-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .observation-time {
            color: var(--primary-color);
            font-weight: 500;
        }

        /* نشاط المستخدمين */
        .user-activity-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .user-activity-item:last-child {
            border-bottom: none;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            margin-left: 0.75rem;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .user-observations {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
        }

        /* إحصائيات الورديات */
        .shift-stat-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .shift-stat-item:last-child {
            border-bottom: none;
        }

        .shift-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .shift-count {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* أنماط المودالات الجديدة */
        .import-instructions {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .import-instructions h4 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .import-instructions ul {
            margin: 0;
            padding-right: 1.5rem;
        }

        .import-instructions li {
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .form-checkbox input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            margin-left: 0.5rem;
            position: relative;
            transition: all 0.2s ease;
        }

        .form-checkbox input[type="checkbox"]:checked + .checkmark {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .form-checkbox input[type="checkbox"]:checked + .checkmark::after {
            content: '✓';
            position: absolute;
            top: -2px;
            left: 2px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .import-progress {
            margin: 1rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            display: block;
        }

        /* أنماط التقارير المطورة */
        .filters-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .chart-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chart-content {
            position: relative;
            height: 300px;
        }

        .stat-change {
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--error-color);
        }

        .stat-change.neutral {
            color: var(--text-secondary);
        }

        .reports-tables {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .export-tools {
            margin-top: 2rem;
        }

        .export-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .reports-tables {
                grid-template-columns: 1fr;
            }
            
            .export-options {
                flex-direction: column;
            }
        }

        /* أنماط التنبيهات والمهام */
        .notifications-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .notifications-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .notifications-header h3 {
            margin: 0;
            color: var(--text-primary);
        }

        .notifications-actions {
            display: flex;
            gap: 0.5rem;
        }

        .notifications-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            color: var(--primary-color);
            background: rgba(0, 123, 255, 0.1);
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: rgba(0, 123, 255, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .notification-item, .task-item, .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            background: white;
            transition: all 0.3s ease;
        }

        .notification-item:hover, .task-item:hover, .alert-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .notification-item.unread {
            border-left: 4px solid var(--primary-color);
            background: rgba(0, 123, 255, 0.02);
        }

        .notification-icon, .alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            background: var(--primary-color);
        }

        .notification-content, .task-content, .alert-content {
            flex: 1;
        }

        .notification-title, .task-title, .alert-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .notification-message, .task-description, .alert-message {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .notification-time, .alert-time {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .notification-actions, .task-actions, .alert-actions {
            display: flex;
            gap: 0.25rem;
        }

        .task-checkbox {
            margin-top: 0.25rem;
        }

        .task-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .task-meta {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .task-priority {
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-low {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        .priority-medium {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        .priority-high {
            background: rgba(255, 87, 34, 0.1);
            color: #ff5722;
        }

        .priority-urgent {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }

        .task-due-date {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* أنماط إضافية للمهام */
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .task-type {
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(0, 123, 255, 0.1);
            color: var(--primary-color);
        }

        .task-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0.75rem 0;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-pending {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        .status-in_progress {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        .status-completed {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .status-cancelled {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .task-reply {
            background: rgba(0, 123, 255, 0.05);
            border: 1px solid rgba(0, 123, 255, 0.2);
            border-radius: 8px;
            padding: 0.75rem;
            margin: 0.75rem 0;
            font-size: 0.9rem;
        }

        .task-creator {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .task-time {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .alert-item.severity-low {
            border-left: 4px solid #17a2b8;
        }

        .alert-item.severity-medium {
            border-left: 4px solid #ffc107;
        }

        .alert-item.severity-high {
            border-left: 4px solid #ff5722;
        }

        .alert-item.severity-critical {
            border-left: 4px solid #f44336;
            background: rgba(244, 67, 54, 0.02);
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
            font-style: italic;
        }

        /* الجداول */
        .table-container {
            background: var(--surface-color);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            animation: slideInRight 0.8s ease-out;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .table-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
        }

        .btn-outline:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 1rem 1.5rem;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background: var(--background-color);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tbody tr {
            transition: all 0.3s ease;
        }

        .table tbody tr:hover {
            background: var(--background-color);
        }

        /* الشارات */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        /* أنماط تفاصيل الملاحظة */
        .observation-details {
            padding: 1rem 0;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-row label {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 120px;
        }

        .detail-row span {
            color: var(--text-secondary);
            text-align: left;
        }

        .supervisor-note {
            background: rgba(255, 193, 7, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
        }

        .supervisor-note label {
            color: #856404;
        }

        .duration-badge {
            background: rgba(0, 123, 255, 0.1);
            color: var(--primary-color);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
            background: var(--success-color);
            color: white;
        }

        .badge-warning {
            background: var(--warning-color);
            color: white;
        }

        .badge-error {
            background: var(--error-color);
            color: white;
        }

        .badge-info {
            background: var(--info-color);
            color: white;
        }

        .badge-secondary {
            background: var(--secondary-color);
            color: white;
        }

        /* النماذج */
        .form-container {
            background: var(--surface-color);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            animation: fadeIn 0.8s ease-out;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            background: var(--surface-color);
            transition: all 0.3s ease;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
        }

        .form-textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            background: var(--surface-color);
            transition: all 0.3s ease;
            resize: vertical;
            min-height: 120px;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
        }

        /* التنبيهات */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: fadeIn 0.5s ease-out;
        }

        .alert-success {
            background: var(--gradient-success);
            color: var(--text-primary);
        }

        .alert-warning {
            background: var(--gradient-warning);
            color: var(--text-primary);
        }

        .alert-error {
            background: var(--gradient-error);
            color: var(--text-primary);
        }

        .alert-info {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: var(--text-primary);
        }

        /* المودال */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--surface-color);
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideInRight 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            color: var(--error-color);
            transform: scale(1.1);
        }

        /* الرسوم البيانية */
        .chart-container {
            background: var(--surface-color);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
            animation: fadeIn 1s ease-out;
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: between;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* التحميل */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* الاستجابة */
        @media (max-width: 768px) {
            .app-header {
                padding: 1rem;
            }

            .app-nav {
                display: none;
            }

            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                order: 2;
            }

            .content-area {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }
        }

        /* تحسينات إضافية */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
            animation: fadeIn 0.6s ease-out;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .floating-action {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .floating-action:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-xl);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* تحسينات الألوان للحالات */
        .status-pending { color: var(--warning-color); }
        .status-approved { color: var(--success-color); }
        .status-rejected { color: var(--error-color); }
        .status-reviewed { color: var(--info-color); }

        .priority-normal { color: var(--text-secondary); }
        .priority-important { color: var(--warning-color); }
        .priority-urgent { color: var(--error-color); }

        /* أنماط المدة */
        .duration-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* تنسيقات الإحصائيات التفاعلية */
        .dashboard-section {
            background: var(--surface-color);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
            animation: fadeIn 0.8s ease-out;
        }

        .section-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .section-header h3 {
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-header i {
            color: var(--primary-color);
        }

        /* إحصائيات الورديات */
        .shifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .shift-card {
            background: linear-gradient(135deg, var(--surface-color) 0%, var(--background-color) 100%);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .shift-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .shift-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .shift-header h4 {
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .shift-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .shift-status.active {
            background: var(--success-color);
            color: white;
        }

        .shift-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .shift-stat {
            text-align: center;
        }

        .shift-stat .stat-label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .shift-stat .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .shift-progress {
            margin-top: 1rem;
        }

        .progress-text {
            display: block;
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        /* إحصائيات نشاط المستخدمين */
        
        /* أنماط الخريطة التفاعلية */
        .map-container {
            position: relative;
            margin-bottom: 2rem;
        }
        
        .observation-info {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            margin-top: 2rem;
            overflow: hidden;
        }
        
        .observation-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: var(--primary-color);
            color: white;
        }
        
        .observation-info-header h3 {
            margin: 0;
            font-size: 1.25rem;
        }
        
        .observation-info-content {
            padding: 1.5rem;
        }
        
        .observation-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .observation-detail:last-child {
            border-bottom: none;
        }
        
        .observation-detail-label {
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .observation-detail-value {
            color: var(--text-primary);
        }
        
        /* أنماط علامات الخريطة */
        .custom-marker {
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .marker-high {
            background-color: var(--error-color);
        }
        
        .marker-medium {
            background-color: var(--warning-color);
        }
        
        .marker-low {
            background-color: var(--success-color);
        }
        
        .marker-normal {
            background-color: var(--primary-color);
        }
        
        /* تحسينات للخريطة على الأجهزة المحمولة */
        @media (max-width: 768px) {
            .map-container {
                margin: 0 -1rem;
            }
            
            #riyadhMap {
                height: 400px;
                border-radius: 0;
            }
            
            .observation-info {
                margin: 1rem -1rem 0;
                border-radius: 0;
            }
        }
        .activity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .activity-card {
            background: linear-gradient(135deg, var(--surface-color) 0%, var(--background-color) 100%);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .activity-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .activity-card.active {
            border-color: var(--success-color);
        }

        .activity-card.low {
            border-color: var(--warning-color);
        }

        .activity-card.inactive {
            border-color: var(--error-color);
        }

        .activity-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
        }

        .activity-card.active .activity-icon {
            background: var(--success-color);
            color: white;
        }

        .activity-card.low .activity-icon {
            background: var(--warning-color);
            color: white;
        }

        .activity-card.inactive .activity-icon {
            background: var(--error-color);
            color: white;
        }

        .activity-info h4 {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .activity-count {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .activity-percentage {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .activity-chart {
            display: flex;
            justify-content: center;
            margin-top: 2rem;
        }

        /* مخطط أنواع الملاحظات */
        .chart-bars {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chart-bar {
            display: grid;
            grid-template-columns: 150px 1fr 60px;
            gap: 1rem;
            align-items: center;
        }

        .bar-label {
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .bar-container {
            background: var(--border-color);
            border-radius: 8px;
            height: 24px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 8px;
            transition: width 0.8s ease;
        }

        .bar-value {
            text-align: center;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 768px) {
            .shifts-grid {
                grid-template-columns: 1fr;
            }
            
            .activity-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-bar {
                grid-template-columns: 1fr;
                gap: 0.5rem;
                text-align: center;
            }
            
            .bar-container {
                order: 2;
            }
            
            .bar-value {
                order: 3;
            }
        }
    </style>
</head>
<body>
    <!-- شاشة تسجيل الدخول -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1><i class="fas fa-shield-alt"></i> منصة الرصد التعاوني</h1>
                <p>نظام متقدم لإدارة ومراقبة العمليات الأمنية</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">اسم المستخدم</label>
                    <input type="text" id="username" class="form-input" placeholder="أدخل اسم المستخدم" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">كلمة المرور</label>
                    <input type="password" id="password" class="form-input" placeholder="أدخل كلمة المرور" required>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i>
                    تسجيل الدخول
                </button>
            </form>
            
            <div id="loginError" class="alert alert-error" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <span></span>
            </div>
        </div>
    </div>
    <!-- التطبيق الرئيسي -->
    <div id="appContainer" class="app-container" style="display:none;">
        <!-- رأس التطبيق -->
        <header class="app-header">
            <div class="app-logo">
                <i class="fas fa-shield-alt"></i>
                منصة الرصد التعاوني
            </div>
            
            <nav class="app-nav">
                <div class="nav-item active" data-page="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    لوحة التحكم
                </div>
                <div class="nav-item" data-page="observations">
                    <i class="fas fa-eye"></i>
                    الملاحظات
                </div>
                <div class="nav-item" data-page="reports">
                    <i class="fas fa-chart-bar"></i>
                    التقارير
                </div>
                <div class="nav-item supervisor-only" data-page="admin" style="display: none;">
                    <i class="fas fa-cogs"></i>
                    الإدارة
                </div>
            </nav>
            
            <div class="user-menu">
                <div class="notification-badge" onclick="showNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="badge-count" id="notificationCount" style="display: none;">0</span>
                </div>
                
                <div class="user-info" onclick="toggleUserDropdown()">
                    <div class="user-avatar" id="userAvatar">م</div>
                    <div>
                        <div id="userName" style="font-weight: 600;">المستخدم</div>
                        <div id="userRole" style="font-size: 0.875rem; color: var(--text-secondary);">راصد</div>
                    </div>
                    <i class="fas fa-chevron-down"></i>
                    
                    <!-- القائمة المنسدلة -->
                    <div class="user-dropdown" id="userDropdown">
                        <a href="#" class="dropdown-item" onclick="showUserProfile()">
                            <i class="fas fa-user"></i>
                            الملف الشخصي
                        </a>
                        <a href="#" class="dropdown-item" onclick="showChangePasswordModal()">
                            <i class="fas fa-key"></i>
                            تغيير كلمة المرور
                        </a>
                        <a href="#" class="dropdown-item" onclick="showUserTasks()">
                            <i class="fas fa-tasks"></i>
                            المهام والتنبيهات
                        </a>
                        <a href="#" class="dropdown-item" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            تسجيل الخروج
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <!-- الشريط الجانبي -->
            <aside class="sidebar">
                <ul class="sidebar-menu">
                    <li class="sidebar-item">
                        <a href="#" class="sidebar-link active" data-page="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            نظرة عامة
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#" class="sidebar-link" data-page="observations">
                            <i class="fas fa-eye"></i>
                            الملاحظات
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#" class="sidebar-link" data-page="add-observation">
                            <i class="fas fa-plus-circle"></i>
                            إضافة ملاحظة
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#" class="sidebar-link" data-page="reports">
                            <i class="fas fa-chart-bar"></i>
                            التقارير والإحصائيات
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#" class="sidebar-link" data-page="map">
                            <i class="fas fa-map"></i>
                            الخريطة التفاعلية
                        </a>
                    </li>
                    <li class="sidebar-item supervisor-only" style="display: none;">
                        <a href="#" class="sidebar-link" data-page="admin">
                            <i class="fas fa-cogs"></i>
                            إدارة النظام
                        </a>
                    </li>
                    <li class="sidebar-item supervisor-only" style="display: none;">
                        <a href="#" class="sidebar-link" data-page="centers">
                            <i class="fas fa-map-marker-alt"></i>
                            المراكز والمحافظات
                        </a>
                    </li>
                    <li class="sidebar-item supervisor-only" style="display: none;">
                        <a href="#" class="sidebar-link" data-page="vehicles">
                            <i class="fas fa-car"></i>
                            الملاك (الآليات)
                        </a>
                    </li>
                    <li class="sidebar-item supervisor-only" style="display: none;">
                        <a href="#" class="sidebar-link" data-page="users">
                            <i class="fas fa-users"></i>
                            إدارة المستخدمين
                        </a>
                    </li>
                    <li class="sidebar-item supervisor-only" style="display: none;">
                        <a href="#" class="sidebar-link" data-page="shifts">
                            <i class="fas fa-clock"></i>
                            إدارة الورديات
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#" class="sidebar-link" data-page="profile">
                            <i class="fas fa-user"></i>
                            الملف الشخصي
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#" class="sidebar-link" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            تسجيل الخروج
                        </a>
                    </li>
                </ul>
            </aside>

            <!-- منطقة المحتوى -->
            <div class="content-area">
                <!-- صفحة لوحة التحكم -->
                <section id="dashboardPage" class="page-section active">
                    <div class="page-header">
                        <h1 class="page-title">لوحة التحكم</h1>
                        <p class="page-subtitle">نظرة شاملة على أداء النظام والإحصائيات الحالية</p>
                    </div>

                    <!-- الإحصائيات الرئيسية -->
                    <div class="stats-grid" id="mainStatsGrid">
                        <div class="stat-card primary">
                            <div class="stat-icon">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="totalObservations">0</div>
                                <div class="stat-label">إجمالي الملاحظات</div>
                                <div class="stat-change positive" id="observationsChange">+0%</div>
                            </div>
                        </div>
                        
                        <div class="stat-card success">
                            <div class="stat-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="totalVehicles">0</div>
                                <div class="stat-label">إجمالي الآليات</div>
                                <div class="stat-change positive" id="vehiclesChange">+0%</div>
                            </div>
                        </div>
                        
                        <div class="stat-card warning">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="activeUsers">0</div>
                                <div class="stat-label">المستخدمين النشطين</div>
                                <div class="stat-change positive" id="usersChange">+0%</div>
                            </div>
                        </div>
                        
                        <div class="stat-card danger">
                            <div class="stat-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="urgentObservations">0</div>
                                <div class="stat-label">الملاحظات العاجلة</div>
                                <div class="stat-change negative" id="urgentChange">0%</div>
                            </div>
                        </div>
                    </div>

                    <!-- الإحصائيات التفاعلية -->
                    <div class="dashboard-row">
                        <!-- مخطط أنواع الملاحظات -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3 class="card-title">توزيع أنواع الملاحظات</h3>
                                <div class="card-actions">
                                    <button class="btn btn-sm btn-outline" onclick="refreshObservationTypes()" title="تحديث إحصائيات أنواع الملاحظات">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-content">
                                <canvas id="observationTypesChart" width="300" height="200"></canvas>
                            </div>
                        </div>

                        <!-- إحصائيات الورديات -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3 class="card-title">أداء الورديات</h3>
                                <div class="card-actions">
                                    <button class="btn btn-sm btn-outline" onclick="refreshShiftStats()" title="تحديث إحصائيات الورديات">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-content">
                                <div id="shiftPerformanceStats">
                                    <!-- سيتم ملؤها ديناميكياً -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- الرسوم البيانية -->
                    <div class="dashboard-row">
                        <div class="dashboard-card full-width">
                            <div class="card-header">
                                <h3 class="card-title">إحصائيات الملاحظات اليومية</h3>
                                <div class="card-actions">
                                    <select id="chartPeriod" onchange="updateDailyChart()" title="اختر الفترة الزمنية للإحصائيات">
                                        <option value="7">آخر 7 أيام</option>
                                        <option value="30">آخر 30 يوم</option>
                                        <option value="90">آخر 3 أشهر</option>
                                    </select>
                                    <button class="btn btn-sm btn-outline" onclick="updateDailyChart()" title="تحديث المخطط اليومي">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-content">
                                <canvas id="dailyChart" width="800" height="300"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- أحدث الملاحظات -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">أحدث الملاحظات</h3>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-outline" onclick="refreshRecentObservations()" title="تحديث قائمة أحدث الملاحظات">
                                    <i class="fas fa-sync-alt"></i>
                                    تحديث
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="showPage('observations')" title="عرض جميع الملاحظات">
                                    <i class="fas fa-eye"></i>
                                    عرض الكل
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <div id="recentObservationsList">
                                <!-- سيتم ملؤها ديناميكياً -->
                            </div>
                        </div>
                    </div>

                    <!-- نشاط المستخدمين -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">نشاط المستخدمين اليوم</h3>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-outline" onclick="refreshUserActivity()" title="تحديث نشاط المستخدمين">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <div id="userActivityList">
                                <!-- سيتم ملؤها ديناميكياً -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- صفحة الملاحظات -->
                <section id="observationsPage" class="page-section">
                    <div class="page-header">
                        <h1 class="page-title">الملاحظات</h1>
                        <p class="page-subtitle">عرض وإدارة جميع الملاحظات المسجلة</p>
                    </div>

                    <!-- فلاتر البحث -->
                    <div class="form-container">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">من تاريخ (هجري)</label>
                                <input type="text" id="filterDateFrom" class="form-input" placeholder="مثال: 1446/02/15" title="أدخل التاريخ بالتقويم الهجري">
                            </div>
                            <div class="form-group">
                                <label class="form-label">إلى تاريخ (هجري)</label>
                                <input type="text" id="filterDateTo" class="form-input" placeholder="مثال: 1446/02/20" title="أدخل التاريخ بالتقويم الهجري">
                            </div>
                            <div class="form-group">
                                <label class="form-label">نوع الملاحظة</label>
                                <select id="filterObservationType" class="form-select">
                                    <option value="">جميع الأنواع</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">الحالة</label>
                                <select id="filterStatus" class="form-select">
                                    <option value="">جميع الحالات</option>
                                    <option value="pending">في الانتظار</option>
                                    <option value="reviewed">قيد المراجعة</option>
                                    <option value="approved">معتمدة</option>
                                    <option value="rejected">مرفوضة</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <button class="btn btn-primary" onclick="applyFilters()" title="تطبيق الفلاتر والبحث">
                                <i class="fas fa-search"></i>
                                بحث
                            </button>
                            <button class="btn btn-outline" onclick="clearFilters()" title="مسح جميع الفلاتر">
                                <i class="fas fa-times"></i>
                                مسح الفلاتر
                            </button>
                        </div>
                    </div>

                    <!-- جدول الملاحظات -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">قائمة الملاحظات</h3>
                            <div class="table-actions">
                                <button class="btn btn-outline btn-sm" onclick="exportObservations()" title="تصدير الملاحظات إلى Excel">
                                    <i class="fas fa-download"></i>
                                    تصدير
                                </button>
                            </div>
                        </div>
                        <div id="observationsTable">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </div>
                    </div>
                </section>

                <!-- صفحة إضافة ملاحظة -->
                <section id="addObservationPage" class="page-section">
                    <div class="page-header">
                        <h1 class="page-title">إضافة ملاحظة جديدة</h1>
                        <p class="page-subtitle">تسجيل ملاحظة جديدة في النظام</p>
                    </div>

                    <div class="form-container">
                        <form id="addObservationForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">نوع الملاحظة *</label>
                                    <select id="observationType" class="form-select" required>
                                        <option value="">اختر نوع الملاحظة</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">رقم الآلية *</label>
                                    <input type="text" id="vehicleNumber" class="form-input" placeholder="مثال: ر ق ص 1234" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">المركز/المحافظة *</label>
                                    <select id="center" class="form-select" required>
                                        <option value="">اختر المركز أو المحافظة</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">الحي *</label>
                                    <input type="text" id="neighborhood" class="form-input" placeholder="اسم الحي" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">الطريق *</label>
                                    <input type="text" id="road" class="form-input" placeholder="اسم الطريق" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">وقت الملاحظة (هجري) *</label>
                                    <input type="text" id="observedAt" class="form-input" placeholder="مثال: 1446/02/15 14:30" title="أدخل التاريخ والوقت بالتقويم الهجري" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">المدة (بالدقائق) *</label>
                                    <input type="number" id="duration" class="form-input" placeholder="المدة بالدقائق" min="1" required>
                                    <small class="form-help">أدخل مدة الملاحظة بالدقائق</small>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">الإجراء المتخذ *</label>
                                <textarea id="actionTaken" class="form-textarea" placeholder="وصف الإجراء المتخذ..." required></textarea>
                            </div>

                            <div class="form-row">
                                <button type="submit" class="btn btn-primary" title="حفظ الملاحظة الجديدة">
                                    <i class="fas fa-save"></i>
                                    حفظ الملاحظة
                                </button>
                                <button type="reset" class="btn btn-outline" title="مسح جميع الحقول وإعادة تعيين النموذج">
                                    <i class="fas fa-undo"></i>
                                    إعادة تعيين
                                </button>
                            </div>
                        </form>
                    </div>
                </section>

                <!-- صفحة التقارير -->
                <section id="reportsPage" class="page-section">
                    <div class="page-header">
                        <h1 class="page-title">التقارير والإحصائيات</h1>
                        <p class="page-subtitle">تحليل شامل لبيانات النظام والأداء</p>
                    </div>

                    <!-- فلاتر التقارير -->
                    <div class="filters-container">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">الفترة الزمنية</label>
                                <select id="reportPeriod" class="form-select" onchange="updateReports()">
                                    <option value="today">اليوم</option>
                                    <option value="week" selected>هذا الأسبوع</option>
                                    <option value="month">هذا الشهر</option>
                                    <option value="quarter">هذا الربع</option>
                                    <option value="year">هذا العام</option>
                                    <option value="custom">فترة مخصصة</option>
                                </select>
                            </div>
                            <div class="form-group" id="customDateRange" style="display: none;">
                                <label class="form-label">من تاريخ (هجري)</label>
                                <input type="text" id="startDate" class="form-input" placeholder="مثال: 1446/02/01" title="أدخل التاريخ بالتقويم الهجري">
                            </div>
                            <div class="form-group" id="customDateRange2" style="display: none;">
                                <label class="form-label">إلى تاريخ (هجري)</label>
                                <input type="text" id="endDate" class="form-input" placeholder="مثال: 1446/02/30" title="أدخل التاريخ بالتقويم الهجري">
                            </div>
                            <div class="form-group">
                                <label class="form-label">المركز/المحافظة</label>
                                <select id="reportCenter" class="form-select" onchange="updateReports()">
                                    <option value="">جميع المراكز</option>
                                    <!-- سيتم ملؤها ديناميكياً -->
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" onclick="generateReport()" title="إنشاء تقرير مفصل حسب المعايير المحددة">
                                    <i class="fas fa-chart-line"></i>
                                    إنشاء التقرير
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- إحصائيات متقدمة -->
                    <div class="stats-grid" id="advancedStats">
                        <div class="stat-card primary">
                            <div class="stat-icon">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="totalObservationsReport">0</div>
                                <div class="stat-label">إجمالي الملاحظات</div>
                                <div class="stat-change positive" id="observationsChange">+12%</div>
                            </div>
                        </div>
                        
                        <div class="stat-card success">
                            <div class="stat-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="resolvedObservations">0</div>
                                <div class="stat-label">الملاحظات المحلولة</div>
                                <div class="stat-change positive" id="resolvedChange">+8%</div>
                            </div>
                        </div>
                        
                        <div class="stat-card warning">
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="pendingObservations">0</div>
                                <div class="stat-label">الملاحظات المعلقة</div>
                                <div class="stat-change negative" id="pendingChange">-5%</div>
                            </div>
                        </div>
                        
                        <div class="stat-card info">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="activeObservers">0</div>
                                <div class="stat-label">الراصدين النشطين</div>
                                <div class="stat-change positive" id="observersChange">+3%</div>
                            </div>
                        </div>
                        
                        <div class="stat-card danger">
                            <div class="stat-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="criticalObservations">0</div>
                                <div class="stat-label">الملاحظات الحرجة</div>
                                <div class="stat-change neutral" id="criticalChange">0%</div>
                            </div>
                        </div>
                        
                        <div class="stat-card secondary">
                            <div class="stat-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="vehiclesInObservations">0</div>
                                <div class="stat-label">الآليات المرصودة</div>
                                <div class="stat-change positive" id="vehiclesChange">+15%</div>
                            </div>
                        </div>
                    </div>

                    <!-- الرسوم البيانية المتقدمة -->
                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">توزيع الملاحظات حسب النوع</h3>
                                <div class="chart-actions">
                                    <button class="btn btn-outline btn-sm" onclick="exportChart('typeChart')">
                                        <i class="fas fa-download"></i>
                                        تصدير
                                    </button>
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="typeChart" width="400" height="300"></canvas>
                            </div>
                        </div>

                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">أداء الراصدين</h3>
                                <div class="chart-actions">
                                    <button class="btn btn-outline btn-sm" onclick="exportChart('performanceChart')" title="تصدير مخطط أداء الراصدين">
                                        <i class="fas fa-download"></i>
                                        تصدير
                                    </button>
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="performanceChart" width="400" height="300"></canvas>
                            </div>
                        </div>

                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">الملاحظات عبر الوقت</h3>
                                <div class="chart-actions">
                                    <button class="btn btn-outline btn-sm" onclick="exportChart('timelineChart')" title="تصدير مخطط الملاحظات عبر الوقت">
                                        <i class="fas fa-download"></i>
                                        تصدير
                                    </button>
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="timelineChart" width="400" height="300"></canvas>
                            </div>
                        </div>

                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">توزيع الملاحظات حسب المراكز</h3>
                                <div class="chart-actions">
                                    <button class="btn btn-outline btn-sm" onclick="exportChart('centersChart')" title="تصدير مخطط توزيع المراكز">
                                        <i class="fas fa-download"></i>
                                        تصدير
                                    </button>
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="centersChart" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- جداول التقارير التفصيلية -->
                    <div class="reports-tables">
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">أفضل الراصدين</h3>
                                <div class="table-actions">
                                    <button class="btn btn-outline" onclick="exportTableToExcel('topObserversTable')" title="تصدير جدول أفضل الراصدين إلى Excel">
                                        <i class="fas fa-file-excel"></i>
                                        تصدير Excel
                                    </button>
                                </div>
                            </div>
                            
                            <table class="data-table" id="topObserversTable">
                                <thead>
                                    <tr>
                                        <th>الترتيب</th>
                                        <th>اسم الراصد</th>
                                        <th>عدد الملاحظات</th>
                                        <th>الملاحظات المحلولة</th>
                                        <th>معدل الأداء</th>
                                        <th>التقييم</th>
                                    </tr>
                                </thead>
                                <tbody id="topObserversTableBody">
                                    <!-- سيتم ملؤها ديناميكياً -->
                                </tbody>
                            </table>
                        </div>

                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">أكثر أنواع الملاحظات</h3>
                                <div class="table-actions">
                                    <button class="btn btn-outline" onclick="exportTableToExcel('topTypesTable')" title="تصدير جدول أنواع الملاحظات إلى Excel">
                                        <i class="fas fa-file-excel"></i>
                                        تصدير Excel
                                    </button>
                                </div>
                            </div>
                            
                            <table class="data-table" id="topTypesTable">
                                <thead>
                                    <tr>
                                        <th>الترتيب</th>
                                        <th>نوع الملاحظة</th>
                                        <th>العدد</th>
                                        <th>النسبة</th>
                                        <th>الاتجاه</th>
                                    </tr>
                                </thead>
                                <tbody id="topTypesTableBody">
                                    <!-- سيتم ملؤها ديناميكياً -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- أدوات التصدير -->
                    <div class="export-tools">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">تصدير التقارير</h3>
                            </div>
                            <div class="card-body">
                                <div class="export-options">
                                    <button class="btn btn-success" onclick="exportFullReport('excel')" title="تصدير تقرير شامل بصيغة Excel">
                                        <i class="fas fa-file-excel"></i>
                                        تصدير تقرير شامل (Excel)
                                    </button>
                                    <button class="btn btn-danger" onclick="exportFullReport('pdf')" title="تصدير تقرير شامل بصيغة PDF">
                                        <i class="fas fa-file-pdf"></i>
                                        تصدير تقرير شامل (PDF)
                                    </button>
                                    <button class="btn btn-info" onclick="printReport()" title="طباعة التقرير">
                                        <i class="fas fa-print"></i>
                                        طباعة التقرير
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- صفحة الخريطة التفاعلية -->
                <section id="mapPage" class="page-section">
                    <div class="page-header">
                        <h1 class="page-title">الخريطة التفاعلية</h1>
                        <p class="page-subtitle">توزيع الملاحظات على خريطة مدينة الرياض</p>
                    </div>

                    <!-- فلاتر الخريطة -->
                    <div class="filters-container">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">نوع الملاحظة</label>
                                <select id="mapObservationType" class="form-select">
                                    <option value="">جميع الأنواع</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">المركز/المحافظة</label>
                                <select id="mapCenter" class="form-select">
                                    <option value="">جميع المراكز</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">الفترة الزمنية</label>
                                <select id="mapTimeRange" class="form-select">
                                    <option value="today">اليوم</option>
                                    <option value="week">هذا الأسبوع</option>
                                    <option value="month" selected>هذا الشهر</option>
                                    <option value="custom">فترة مخصصة</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" onclick="updateMapData()" title="تحديث بيانات الخريطة">
                                    <i class="fas fa-sync-alt"></i>
                                    تحديث الخريطة
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- إحصائيات سريعة للخريطة -->
                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="mapTotalObservations">0</div>
                                <div class="stat-label">إجمالي الملاحظات</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="mapHighPriorityObservations">0</div>
                                <div class="stat-label">ملاحظات عالية الأولوية</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="mapPendingObservations">0</div>
                                <div class="stat-label">ملاحظات معلقة</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="mapResolvedObservations">0</div>
                                <div class="stat-label">ملاحظات محلولة</div>
                            </div>
                        </div>
                    </div>

                    <!-- الخريطة -->
                    <div class="map-container">
                        <div id="riyadhMap" style="height: 600px; width: 100%; border-radius: 12px; box-shadow: var(--shadow-md);"></div>
                    </div>

                    <!-- معلومات الملاحظة المحددة -->
                    <div id="selectedObservationInfo" class="observation-info" style="display: none;">
                        <div class="observation-info-header">
                            <h3>تفاصيل الملاحظة</h3>
                            <button class="btn btn-outline btn-sm" onclick="closeObservationInfo()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="observationInfoContent"></div>
                    </div>
                </section>

                <!-- صفحة الإدارة -->
                <section id="adminPage" class="page-section">
                    <div class="page-header">
                        <h1 class="page-title">إدارة النظام</h1>
                        <p class="page-subtitle">إدارة شاملة لجميع مكونات النظام</p>
                    </div>

                    <!-- لوحة تحكم المشرف -->
                    <div class="stats-grid" id="adminStats">
                        <!-- سيتم ملؤها ديناميكياً -->
                    </div>

                    <!-- إدارة أنواع الملاحظات -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">إدارة أنواع الملاحظات</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddObservationTypeModal()" title="إضافة نوع ملاحظة جديد">
                                <i class="fas fa-plus"></i>
                                إضافة نوع جديد
                            </button>
                        </div>
                        <div id="observationTypesTable">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </div>
                    </div>

                    <!-- إدارة المراكز -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">إدارة المراكز والمحافظات</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddCenterModal()" title="إضافة مركز أو محافظة جديدة">
                                <i class="fas fa-plus"></i>
                                إضافة مركز/محافظة
                            </button>
                        </div>
                        <div id="centersTable">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </div>
                    </div>
                </section>

                <!-- صفحة إدارة المستخدمين -->
                <section id="usersPage" class="page-section">
                    <div class="page-header">
                        <h1 class="page-title">إدارة المستخدمين</h1>
                        <p class="page-subtitle">إدارة حسابات المستخدمين والراصدين</p>
                    </div>

                    <!-- إحصائيات المستخدمين -->
                    <div class="stats-grid" id="usersStats">
                        <!-- سيتم ملؤها ديناميكياً -->
                    </div>

                    <!-- أدوات الإدارة -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">قائمة المستخدمين</h3>
                            <div class="card-actions">
                                <button class="btn btn-primary btn-sm" onclick="showAddUserModal()" title="إضافة مستخدم جديد للنظام">
                                    <i class="fas fa-user-plus"></i>
                                    إضافة مستخدم جديد
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="exportUsers()" title="تصدير قائمة المستخدمين إلى Excel">
                                    <i class="fas fa-download"></i>
                                    تصدير
                                </button>
                            </div>
                        </div>
                        
                        <!-- فلاتر البحث -->
                        <div class="filters-row">
                            <div class="filter-group">
                                <label>الدور:</label>
                                <select id="userRoleFilter" onchange="filterUsers()">
                                    <option value="all">جميع الأدوار</option>
                                    <option value="supervisor">مشرف</option>
                                    <option value="monitor">راصد</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>الوردية:</label>
                                <select id="userShiftFilter" onchange="filterUsers()">
                                    <option value="all">جميع الورديات</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>الحالة:</label>
                                <select id="userStatusFilter" onchange="filterUsers()">
                                    <option value="all">جميع الحالات</option>
                                    <option value="active">نشط</option>
                                    <option value="inactive">غير نشط</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <input type="text" id="userSearchInput" placeholder="البحث بالاسم أو رقم الهوية..." onkeyup="filterUsers()">
                            </div>
                        </div>

                        <div id="usersTable">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </div>
                    </div>
                </section>

                <!-- صفحة إدارة الورديات المحسنة -->
                <section id="shiftsPage" class="page-section">
                    <div class="page-header">
                        <h1 class="page-title">
                            <i class="fas fa-calendar-alt"></i>
                            إدارة الورديات الشهرية
                        </h1>
                        <p class="page-subtitle">إدارة جداول العمل الشهرية بالتقويم الهجري</p>
                    </div>

                    <!-- شريط التحكم الشهري -->
                    <div class="monthly-controls">
                        <div class="month-navigation">
                            <button class="nav-btn prev-month" onclick="changeMonth(-1)" title="الشهر السابق">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            
                            <div class="current-month-display">
                                <div class="hijri-month">
                                    <span id="currentHijriMonth">محرم</span>
                                    <span id="currentHijriYear">1446</span>
                                </div>
                                <div class="gregorian-month">
                                    <span id="currentGregorianMonth">يوليو</span>
                                    <span id="currentGregorianYear">2024</span>
                                </div>
                            </div>
                            
                            <button class="nav-btn next-month" onclick="changeMonth(1)" title="الشهر التالي">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        </div>
                        
                        <div class="month-actions">
                            <button class="btn btn-outline btn-sm" onclick="goToCurrentMonth()" title="العودة للشهر الحالي">
                                <i class="fas fa-home"></i>
                                الشهر الحالي
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="showShiftAssignmentModal()" title="توزيع الورديات للشهر">
                                <i class="fas fa-users-cog"></i>
                                توزيع الورديات
                            </button>
                            <button class="btn btn-success btn-sm" onclick="exportMonthlySchedule()" title="تصدير جدول الشهر">
                                <i class="fas fa-download"></i>
                                تصدير الجدول
                            </button>
                        </div>
                    </div>

                    <!-- إحصائيات الشهر -->
                    <div class="monthly-stats">
                        <div class="stat-card">
                            <div class="stat-icon morning">
                                <i class="fas fa-sun"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="morningShiftsCount">0</div>
                                <div class="stat-label">الورديات الصباحية</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon evening">
                                <i class="fas fa-cloud-sun"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="eveningShiftsCount">0</div>
                                <div class="stat-label">الورديات المسائية</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon night">
                                <i class="fas fa-moon"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="nightShiftsCount">0</div>
                                <div class="stat-label">الورديات الليلية</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon full-day">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="fullDayShiftsCount">0</div>
                                <div class="stat-label">ورديات 24 ساعة</div>
                            </div>
                        </div>
                    </div>

                    <!-- الجدول الشهري -->
                    <div class="monthly-calendar-container">
                        <div class="calendar-header">
                            <h3>
                                <i class="fas fa-calendar-week"></i>
                                جدول الورديات الشهري
                            </h3>
                            <div class="calendar-legend">
                                <div class="legend-item">
                                    <span class="legend-color morning"></span>
                                    <span>صباحية</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-color evening"></span>
                                    <span>مسائية</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-color night"></span>
                                    <span>ليلية</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-color full-day"></span>
                                    <span>24 ساعة</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- جدول التقويم -->
                        <div class="calendar-grid" id="monthlyCalendar">
                            <!-- رؤوس الأيام -->
                            <div class="calendar-header-row">
                                <div class="day-header">السبت</div>
                                <div class="day-header">الأحد</div>
                                <div class="day-header">الاثنين</div>
                                <div class="day-header">الثلاثاء</div>
                                <div class="day-header">الأربعاء</div>
                                <div class="day-header">الخميس</div>
                                <div class="day-header">الجمعة</div>
                            </div>
                            
                            <!-- أيام الشهر -->
                            <div class="calendar-days" id="calendarDays">
                                <!-- سيتم ملؤها ديناميكياً -->
                            </div>
                        </div>
                    </div>

                    <!-- قائمة المستخدمين والورديات -->
                    <div class="shifts-management">
                        <div class="shifts-sidebar">
                            <div class="sidebar-header">
                                <h4>
                                    <i class="fas fa-users"></i>
                                    المستخدمون والورديات
                                </h4>
                                <button class="btn btn-sm btn-outline" onclick="refreshUsersList()" title="تحديث القائمة">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            
                            <!-- فلاتر المستخدمين -->
                            <div class="users-filters">
                                <div class="filter-group">
                                    <label>فلترة حسب الوردية:</label>
                                    <select id="shiftTypeFilter" onchange="filterUsersByShift()">
                                        <option value="all">جميع الورديات</option>
                                        <option value="صباحية">الصباحية</option>
                                        <option value="مسائية">المسائية</option>
                                        <option value="ليلية">الليلية</option>
                                        <option value="24 ساعة">24 ساعة</option>
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label>فلترة حسب المركز:</label>
                                    <select id="centerFilter" onchange="filterUsersByCenter()">
                                        <option value="all">جميع المراكز</option>
                                        <!-- سيتم ملؤها ديناميكياً -->
                                    </select>
                                </div>
                            </div>
                            
                            <!-- قائمة المستخدمين -->
                            <div class="users-list" id="usersList">
                                <!-- سيتم ملؤها ديناميكياً -->
                            </div>
                        </div>
                        
                        <!-- منطقة التفاصيل -->
                        <div class="shift-details">
                            <div class="details-header">
                                <h4>
                                    <i class="fas fa-info-circle"></i>
                                    تفاصيل اليوم المحدد
                                </h4>
                                <div class="selected-date" id="selectedDateDisplay">
                                    اختر يوماً من التقويم
                                </div>
                            </div>
                            
                            <!-- تفاصيل الورديات لليوم -->
                            <div class="day-shifts-details" id="dayShiftsDetails">
                                <div class="no-selection">
                                    <i class="fas fa-calendar-day"></i>
                                    <p>انقر على أي يوم في التقويم لعرض تفاصيل الورديات</p>
                                </div>
                            </div>
                            
                            <!-- أدوات التحرير -->
                            <div class="edit-tools" id="editTools" style="display: none;">
                                <button class="btn btn-primary btn-sm" onclick="editDayShifts()" title="تعديل ورديات اليوم">
                                    <i class="fas fa-edit"></i>
                                    تعديل الورديات
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="copyFromPreviousDay()" title="نسخ من اليوم السابق">
                                    <i class="fas fa-copy"></i>
                                    نسخ من الأمس
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="clearDayShifts()" title="مسح ورديات اليوم">
                                    <i class="fas fa-trash"></i>
                                    مسح الورديات
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- إحصائيات المستخدمين -->
                    <div class="users-statistics">
                        <div class="stats-header">
                            <h4>
                                <i class="fas fa-chart-bar"></i>
                                إحصائيات المستخدمين للشهر
                            </h4>
                            <div class="stats-actions">
                                <button class="btn btn-outline btn-sm" onclick="exportUserStats()" title="تصدير الإحصائيات">
                                    <i class="fas fa-download"></i>
                                    تصدير
                                </button>
                            </div>
                        </div>
                        
                        <div class="stats-table-container">
                            <table class="stats-table">
                                <thead>
                                    <tr>
                                        <th>المستخدم</th>
                                        <th>الرتبة</th>
                                        <th>المركز</th>
                                        <th>الوردية الأساسية</th>
                                        <th>أيام العمل</th>
                                        <th>أيام الراحة</th>
                                        <th>الورديات الإضافية</th>
                                        <th>معدل الحضور</th>
                                    </tr>
                                </thead>
                                <tbody id="userStatsTableBody">
                                    <!-- سيتم ملؤها ديناميكياً -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                                </button>
                            </div>
                        </div>

                        <div id="shiftsTable">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </div>
                    </div>

                    <!-- جدول الحضور اليومي -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">حضور اليوم</h3>
                            <div class="card-actions">
                                <input type="text" id="attendanceDate" onchange="loadAttendance()" placeholder="مثال: 1446/02/15" title="أدخل التاريخ بالتقويم الهجري" value="">
                                <button class="btn btn-outline btn-sm" onclick="markAllPresent()">
                                    <i class="fas fa-check-circle"></i>
                                    تسجيل حضور الجميع
                                </button>
                            </div>
                        </div>

                        <div id="attendanceTable">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </div>
                    </div>
                </section>

                <!-- صفحة الملف الشخصي -->
                <section id="profilePage" class="page-section">
                    <div class="page-header">
                        <h1 class="page-title">الملف الشخصي</h1>
                        <p class="page-subtitle">إدارة معلوماتك الشخصية وإعدادات الحساب</p>
                    </div>

                    <div class="form-container">
                        <form id="profileForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">الاسم الكامل</label>
                                    <input type="text" id="profileFullName" class="form-input" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">الرتبة</label>
                                    <input type="text" id="profileRank" class="form-input" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">رقم الهوية</label>
                                    <input type="text" id="profileNationalId" class="form-input" readonly>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">رقم الجوال</label>
                                    <input type="text" id="profilePhone" class="form-input" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">الوردية</label>
                                    <input type="text" id="profileShift" class="form-input" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">الدور</label>
                                    <input type="text" id="profileRole" class="form-input" readonly>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">كلمة المرور الجديدة</label>
                                <input type="password" id="newPassword" class="form-input" placeholder="اتركها فارغة إذا لم ترد تغييرها">
                            </div>

                            <div class="form-group">
                                <label class="form-label">تأكيد كلمة المرور</label>
                                <input type="password" id="confirmPassword" class="form-input" placeholder="أعد إدخال كلمة المرور الجديدة">
                            </div>

                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                حفظ التغييرات
                            </button>
                        </form>
                    </div>
                </section>

                <!-- صفحة المراكز والمحافظات -->
                <section id="centersPage" class="page-section">
                    <div class="page-header">
                        <h1 class="page-title">المراكز والمحافظات</h1>
                        <p class="page-subtitle">إدارة المراكز والمحافظات التابعة للمنطقة</p>
                    </div>

                    <!-- إحصائيات المراكز -->
                    <div class="stats-grid" id="centersStats">
                        <div class="stat-card primary">
                            <div class="stat-icon">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="totalCenters">0</div>
                                <div class="stat-label">إجمالي المراكز</div>
                            </div>
                        </div>
                        
                        <div class="stat-card success">
                            <div class="stat-icon">
                                <i class="fas fa-map"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="totalProvinces">0</div>
                                <div class="stat-label">إجمالي المحافظات</div>
                            </div>
                        </div>
                        
                        <div class="stat-card warning">
                            <div class="stat-icon">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="activeObservations">0</div>
                                <div class="stat-label">الملاحظات النشطة</div>
                            </div>
                        </div>
                    </div>

                    <!-- أدوات الإدارة -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">قائمة المراكز والمحافظات</h3>
                            <div class="table-actions">
                                <button class="btn btn-primary" onclick="showAddCenterModal()">
                                    <i class="fas fa-plus"></i>
                                    إضافة مركز/محافظة
                                </button>
                                <button class="btn btn-outline" onclick="refreshCenters()">
                                    <i class="fas fa-sync-alt"></i>
                                    تحديث
                                </button>
                            </div>
                        </div>
                        
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>الاسم</th>
                                    <th>النوع</th>
                                    <th>المنطقة</th>
                                    <th>عدد الملاحظات</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="centersTableBody">
                                <!-- سيتم ملؤها ديناميكياً -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- صفحة الآليات (الملاك) -->
                <section id="vehiclesPage" class="page-section">
                    <div class="page-header">
                        <h1 class="page-title">الملاك (الآليات)</h1>
                        <p class="page-subtitle">إدارة آليات المراكز والمحافظات</p>
                    </div>

                    <!-- إحصائيات الآليات -->
                    <div class="stats-grid" id="vehiclesStats">
                        <div class="stat-card primary">
                            <div class="stat-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="totalVehiclesCount">0</div>
                                <div class="stat-label">إجمالي الآليات</div>
                            </div>
                        </div>
                        
                        <div class="stat-card success">
                            <div class="stat-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="activeVehicles">0</div>
                                <div class="stat-label">الآليات النشطة</div>
                            </div>
                        </div>
                        
                        <div class="stat-card warning">
                            <div class="stat-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="vehiclesWithObservations">0</div>
                                <div class="stat-label">آليات بملاحظات</div>
                            </div>
                        </div>
                    </div>

                    <!-- أدوات الإدارة -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">قائمة الآليات</h3>
                            <div class="table-actions">
                                <button class="btn btn-primary" onclick="showAddVehicleModal()">
                                    <i class="fas fa-plus"></i>
                                    إضافة آلية
                                </button>
                                <button class="btn btn-success" onclick="showImportVehiclesModal()">
                                    <i class="fas fa-file-excel"></i>
                                    استيراد من Excel
                                </button>
                                <button class="btn btn-outline" onclick="exportVehiclesToExcel()">
                                    <i class="fas fa-download"></i>
                                    تصدير إلى Excel
                                </button>
                                <button class="btn btn-outline" onclick="refreshVehicles()">
                                    <i class="fas fa-sync-alt"></i>
                                    تحديث
                                </button>
                            </div>
                        </div>

                        <!-- فلاتر البحث المحسنة -->
                        <div class="enhanced-filters-container">
                            <div class="filters-header">
                                <h4><i class="fas fa-filter"></i> فلاتر البحث والتصفية</h4>
                                <button class="btn btn-outline btn-sm" onclick="clearVehicleFilters()">
                                    <i class="fas fa-times"></i>
                                    مسح الفلاتر
                                </button>
                            </div>
                            
                            <div class="filters-grid">
                                <div class="filter-group">
                                    <label class="filter-label">
                                        <i class="fas fa-search"></i>
                                        البحث برقم اللوحة
                                    </label>
                                    <input type="text" 
                                           id="vehicleSearchPlate" 
                                           class="filter-input" 
                                           placeholder="ادخل رقم اللوحة"
                                           onkeyup="filterVehiclesRealtime()">
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">
                                        <i class="fas fa-car"></i>
                                        نوع السيارة
                                    </label>
                                    <select id="vehicleSearchType" 
                                            class="filter-select" 
                                            onchange="filterVehiclesRealtime()">
                                        <option value="">جميع الأنواع</option>
                                        <!-- سيتم ملؤها ديناميكياً -->
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">
                                        <i class="fas fa-map-marker-alt"></i>
                                        المركز/المحافظة
                                    </label>
                                    <select id="vehicleSearchCenter" 
                                            class="filter-select" 
                                            onchange="filterVehiclesRealtime()">
                                        <option value="">جميع المراكز</option>
                                        <!-- سيتم ملؤها ديناميكياً -->
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">
                                        <i class="fas fa-clock"></i>
                                        الوردية
                                    </label>
                                    <select id="vehicleSearchShift" 
                                            class="filter-select" 
                                            onchange="filterVehiclesRealtime()">
                                        <option value="">جميع الورديات</option>
                                        <option value="صباحية">الوردية الصباحية</option>
                                        <option value="مسائية">الوردية المسائية</option>
                                        <option value="ليلية">الوردية الليلية</option>
                                        <option value="24 ساعة">24 ساعة</option>
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">
                                        <i class="fas fa-palette"></i>
                                        اللون
                                    </label>
                                    <select id="vehicleSearchColor" 
                                            class="filter-select" 
                                            onchange="filterVehiclesRealtime()">
                                        <option value="">جميع الألوان</option>
                                        <option value="أبيض">أبيض</option>
                                        <option value="أسود">أسود</option>
                                        <option value="أزرق">أزرق</option>
                                        <option value="أحمر">أحمر</option>
                                        <option value="فضي">فضي</option>
                                        <option value="رمادي">رمادي</option>
                                        <option value="أخضر">أخضر</option>
                                        <option value="بني">بني</option>
                                        <option value="أصفر">أصفر</option>
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">
                                        <i class="fas fa-building"></i>
                                        جهة العمل
                                    </label>
                                    <select id="vehicleSearchWorkplace" 
                                            class="filter-select" 
                                            onchange="filterVehiclesRealtime()">
                                        <option value="">جميع الجهات</option>
                                        <!-- سيتم ملؤها ديناميكياً -->
                                    </select>
                                </div>
                            </div>
                            
                            <!-- إحصائيات الفلترة -->
                            <div class="filter-stats">
                                <span class="filter-result">
                                    <i class="fas fa-list"></i>
                                    عرض <span id="filteredVehiclesCount">0</span> من أصل <span id="totalVehiclesInTable">0</span> آلية
                                </span>
                                <div class="filter-actions">
                                    <button class="btn btn-primary btn-sm" onclick="exportFilteredVehicles()">
                                        <i class="fas fa-download"></i>
                                        تصدير النتائج
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>م</th>
                                    <th>نوع السيارة</th>
                                    <th>الموديل</th>
                                    <th>اللون</th>
                                    <th>رقم اللوحة</th>
                                    <th>الأمن العام</th>
                                    <th>جهة العمل</th>
                                    <th>الوردية</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="vehiclesTableBody">
                                <!-- سيتم ملؤها ديناميكياً -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>
    <!-- زر الإجراء العائم -->
    <button class="floating-action" onclick="showAddObservationPage()" title="إضافة ملاحظة سريعة">
        <i class="fas fa-plus"></i>
    </button>
    <!-- المودالات العامة والإدارية كما في ملفك ... -->
    <div id="generalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">عنوان المودال</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- محتوى المودال -->
            </div>
        </div>
    </div>

    <!-- مودال إضافة مركز/محافظة -->
    <div id="addCenterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إضافة مركز/محافظة جديد</h3>
                <button class="modal-close" onclick="closeAddCenterModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addCenterForm" onsubmit="addCenter(event)">
                    <div class="form-group">
                        <label class="form-label">اسم المركز/المحافظة *</label>
                        <input type="text" id="centerName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">النوع *</label>
                        <select id="centerType" class="form-select" required>
                            <option value="">اختر النوع</option>
                            <option value="center">مركز</option>
                            <option value="province">محافظة</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">المنطقة</label>
                        <input type="text" id="centerRegion" class="form-input" value="منطقة الرياض">
                    </div>
                    <div class="form-group">
                        <label class="form-label">الوصف</label>
                        <textarea id="centerDescription" class="form-textarea" rows="3"></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline" onclick="closeAddCenterModal()">إلغاء</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            حفظ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- مودال إضافة آلية -->
    <div id="addVehicleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إضافة آلية جديدة</h3>
                <button class="modal-close" onclick="closeAddVehicleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addVehicleForm" onsubmit="addVehicle(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">نوع السيارة *</label>
                            <input type="text" id="vehicleType" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">الموديل *</label>
                            <input type="text" id="vehicleModel" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">اللون *</label>
                            <select id="vehicleColor" class="form-select" required>
                                <option value="">اختر اللون</option>
                                <option value="رسمي">رسمي</option>
                                <option value="سري">سري</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">رقم اللوحة *</label>
                            <input type="text" id="vehiclePlate" class="form-input" required placeholder="مثال: أ ب ج 1234">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">رقم الأمن العام</label>
                            <input type="text" id="vehicleSecurityNumber" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">جهة العمل *</label>
                            <select id="vehicleWorkplace" class="form-select" required>
                                <option value="">اختر جهة العمل</option>
                                <!-- سيتم ملؤها ديناميكياً من المراكز والمحافظات -->
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">الوردية</label>
                        <select id="vehicleShift" class="form-select">
                            <option value="">اختر الوردية</option>
                            <option value="morning">الصباحية (6ص-2م)</option>
                            <option value="evening">المسائية (2م-10م)</option>
                            <option value="night">الليلية (10م-6ص)</option>
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline" onclick="closeAddVehicleModal()">إلغاء</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            حفظ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- مودال استيراد الآليات من Excel المحسن -->
    <div id="importVehiclesModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-excel"></i>
                    استيراد الآليات من ملف Excel
                </h3>
                <button class="modal-close" onclick="closeImportVehiclesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- تعليمات الاستيراد المحسنة -->
                <div class="import-instructions">
                    <div class="instruction-header">
                        <i class="fas fa-info-circle"></i>
                        <h4>تعليمات الاستيراد</h4>
                    </div>
                    
                    <div class="instruction-content">
                        <div class="instruction-section">
                            <h5><i class="fas fa-table"></i> تنسيق الملف المطلوب:</h5>
                            <div class="columns-grid">
                                <div class="column-item">
                                    <span class="column-number">1</span>
                                    <div class="column-info">
                                        <strong>م</strong>
                                        <small>رقم المسلسل</small>
                                    </div>
                                </div>
                                <div class="column-item">
                                    <span class="column-number">2</span>
                                    <div class="column-info">
                                        <strong>نوع السيارة</strong>
                                        <small>مثل: كامري، أكورد، إلنترا</small>
                                    </div>
                                </div>
                                <div class="column-item">
                                    <span class="column-number">3</span>
                                    <div class="column-info">
                                        <strong>الموديل</strong>
                                        <small>سنة الصنع مثل: 2023</small>
                                    </div>
                                </div>
                                <div class="column-item">
                                    <span class="column-number">4</span>
                                    <div class="column-info">
                                        <strong>اللون</strong>
                                        <small>مثل: أبيض، أسود، فضي</small>
                                    </div>
                                </div>
                                <div class="column-item">
                                    <span class="column-number">5</span>
                                    <div class="column-info">
                                        <strong>رقم اللوحة</strong>
                                        <small>مثل: أ ب ج 1234</small>
                                    </div>
                                </div>
                                <div class="column-item">
                                    <span class="column-number">6</span>
                                    <div class="column-info">
                                        <strong>الأمن العام</strong>
                                        <small>رقم تسجيل الأمن العام</small>
                                    </div>
                                </div>
                                <div class="column-item">
                                    <span class="column-number">7</span>
                                    <div class="column-info">
                                        <strong>جهة العمل</strong>
                                        <small>المركز أو المحافظة</small>
                                    </div>
                                </div>
                                <div class="column-item">
                                    <span class="column-number">8</span>
                                    <div class="column-info">
                                        <strong>الوردية</strong>
                                        <small>صباحية، مسائية، ليلية</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="instruction-section">
                            <h5><i class="fas fa-exclamation-triangle"></i> ملاحظات مهمة:</h5>
                            <ul class="important-notes">
                                <li>يجب أن يكون الصف الأول يحتوي على عناوين الأعمدة</li>
                                <li>تأكد من عدم وجود خلايا فارغة في البيانات الأساسية</li>
                                <li>رقم اللوحة يجب أن يكون فريداً لكل آلية</li>
                                <li>الملف يجب أن يكون بصيغة .xlsx أو .xls</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="download-template">
                        <button type="button" class="btn btn-outline" onclick="downloadVehicleTemplate()">
                            <i class="fas fa-download"></i>
                            تحميل نموذج Excel
                        </button>
                    </div>
                </div>
                
                <!-- نموذج الاستيراد -->
                <form id="importVehiclesForm" onsubmit="importVehicles(event)">
                    <div class="upload-section">
                        <div class="file-upload-area" id="fileUploadArea">
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="upload-text">
                                <h4>اسحب وأفلت ملف Excel هنا</h4>
                                <p>أو انقر لاختيار الملف</p>
                            </div>
                            <input type="file" 
                                   id="vehiclesFile" 
                                   class="file-input" 
                                   accept=".xlsx,.xls" 
                                   required
                                   onchange="handleFileSelect(this)">
                        </div>
                        
                        <div class="file-info" id="fileInfo" style="display: none;">
                            <div class="file-details">
                                <i class="fas fa-file-excel"></i>
                                <div class="file-text">
                                    <span class="file-name" id="fileName"></span>
                                    <span class="file-size" id="fileSize"></span>
                                </div>
                                <button type="button" class="remove-file" onclick="removeFile()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- خيارات الاستيراد -->
                    <div class="import-options">
                        <h5><i class="fas fa-cogs"></i> خيارات الاستيراد</h5>
                        
                        <div class="options-grid">
                            <label class="option-item">
                                <input type="checkbox" id="replaceExisting">
                                <span class="checkmark"></span>
                                <div class="option-text">
                                    <strong>استبدال الآليات الموجودة</strong>
                                    <small>في حالة التطابق في رقم اللوحة</small>
                                </div>
                            </label>
                            
                            <label class="option-item">
                                <input type="checkbox" id="skipErrors" checked>
                                <span class="checkmark"></span>
                                <div class="option-text">
                                    <strong>تخطي الأخطاء</strong>
                                    <small>متابعة الاستيراد حتى مع وجود أخطاء</small>
                                </div>
                            </label>
                            
                            <label class="option-item">
                                <input type="checkbox" id="validateData" checked>
                                <span class="checkmark"></span>
                                <div class="option-text">
                                    <strong>التحقق من صحة البيانات</strong>
                                    <small>فحص البيانات قبل الاستيراد</small>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- شريط التقدم -->
                    <div id="importProgress" class="import-progress" style="display: none;">
                        <div class="progress-header">
                            <span class="progress-title">جاري الاستيراد...</span>
                            <span class="progress-percentage" id="progressPercentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-details">
                            <span class="progress-text" id="progressText">بدء العملية...</span>
                            <span class="progress-count" id="progressCount">0 / 0</span>
                        </div>
                    </div>
                    
                    <!-- نتائج الاستيراد -->
                    <div id="importResults" class="import-results" style="display: none;">
                        <div class="results-summary">
                            <div class="result-item success">
                                <i class="fas fa-check-circle"></i>
                                <span>تم استيراد <strong id="successCount">0</strong> آلية بنجاح</span>
                            </div>
                            <div class="result-item error">
                                <i class="fas fa-exclamation-circle"></i>
                                <span>فشل في استيراد <strong id="errorCount">0</strong> آلية</span>
                            </div>
                        </div>
                        
                        <div class="error-details" id="errorDetails" style="display: none;">
                            <h6>تفاصيل الأخطاء:</h6>
                            <div class="error-list" id="errorList"></div>
                        </div>
                    </div>
                    
                    <!-- أزرار الإجراءات -->
                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline" onclick="closeImportVehiclesModal()">
                            <i class="fas fa-times"></i>
                            إلغاء
                        </button>
                        <button type="submit" class="btn btn-success" id="importBtn">
                            <i class="fas fa-file-import"></i>
                            بدء الاستيراد
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- مودال تعديل نوع الملاحظة -->
    <div id="editObservationTypeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">تعديل نوع الملاحظة</h2>
                <button class="modal-close" onclick="closeModal('editObservationTypeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editObservationTypeForm" onsubmit="updateObservationType(event)">
                    <div class="form-group">
                        <label class="form-label">اسم النوع</label>
                        <input type="text" id="editObservationTypeName" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">الوصف</label>
                        <textarea id="editObservationTypeDescription" class="form-textarea" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">اللون</label>
                        <input type="color" id="editObservationTypeColor" class="form-input" value="#007bff">
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="editObservationTypeRequiresDuration">
                            <span class="checkbox-custom"></span>
                            يتطلب مدة زمنية
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="editObservationTypeActive" checked>
                            <span class="checkbox-custom"></span>
                            نشط
                        </label>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline" onclick="closeModal('editObservationTypeModal')">إلغاء</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            حفظ التعديلات
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- مودال تعديل المركز -->
    <div id="editCenterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">تعديل المركز/المحافظة</h2>
                <button class="modal-close" onclick="closeModal('editCenterModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editCenterForm" onsubmit="updateCenter(event)">
                    <div class="form-group">
                        <label class="form-label">الاسم</label>
                        <input type="text" id="editCenterName" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">النوع</label>
                        <select id="editCenterType" class="form-select" required>
                            <option value="center">مركز</option>
                            <option value="province">محافظة</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">المنطقة</label>
                        <input type="text" id="editCenterRegion" class="form-input" value="منطقة الرياض">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">الوصف</label>
                        <textarea id="editCenterDescription" class="form-textarea" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="editCenterActive" checked>
                            <span class="checkbox-custom"></span>
                            نشط
                        </label>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline" onclick="closeModal('editCenterModal')">إلغاء</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            حفظ التعديلات
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // نسخ جميع دوال الجافاسكريبت الخاصة بك هنا بالكامل
        // متغيرات عامة
        let currentUser = null;
        let currentPage = 'dashboard';
        let observationTypes = [];
        let centers = [];
        let notifications = [];

        // جميع دوال الأحداث والدوال المساعدة كما هي في ملفك الأصلي
        // setupEventListeners، showAddUserModal، showModal، closeModal، toggleShiftField، وغيرها
        // ...
        // يمكنك نسخ جميع الأكواد البرمجية من ملفك ووضعها هنا
        // متغيرات عامة
        let currentUser = null;
        let currentPage = 'dashboard';
        let observationTypes = [];
        let centers = [];
        let notifications = [];


        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // تسجيل الدخول - ربط مباشر
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    
                    if (!username || !password) {
                        showError('يرجى إدخال اسم المستخدم وكلمة المرور');
                        return;
                    }
                    
                    try {
                        const response = await fetch('/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ username, password })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            currentUser = data.user;
                            localStorage.setItem('currentUser', JSON.stringify(data.user));
                            localStorage.setItem('token', 'authenticated');
                            
                            hideError();
                            showApp();
                            loadInitialData();
                        } else {
                            showError(data.error || 'فشل في تسجيل الدخول');
                        }
                    } catch (error) {
                        console.error('خطأ في تسجيل الدخول:', error);
                        showError('حدث خطأ في الاتصال بالخادم');
                    }
                });
                console.log('Login form event listener attached successfully');
            } else {
                console.error('Login form not found');
            }
            
            // التنقل
            document.querySelectorAll('.nav-item, .sidebar-link').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    if (page) {
                        showPage(page);
                    }
                });
            });
        }
        // تهيئة التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            setupEventListeners();
            setupAdditionalEventListeners();
            setCurrentDateTime();
            updateDateInputsForHijri();
            
            // تحديث التواريخ كل ثانية
            setInterval(() => {
                convertAllDatesToHijri();
            }, 1000);
        });

        // إعداد مستمعي الأحداث
                    showLogin();
                }
            } catch (error) {
                console.error('خطأ في فحص حالة المصادقة:', error);
                showLogin();
            }
        }

            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            hideError();
        }

        // تحميل البيانات الأولية
        async function loadInitialData() {
            try {
                await Promise.all([
                    loadObservationTypes(),
                    loadCenters(),
                    loadDashboardData(),
                    loadNotifications()
                ]);
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
            }
        }

        // تحميل أنواع الملاحظات
        async function loadObservationTypes() {
            try {
                const response = await fetch('/api/observations/types');
                const data = await response.json();
                
                if (data.success) {
                    observationTypes = data.observation_types;
                    updateObservationTypeSelects();
                }
            } catch (error) {
                console.error('خطأ في تحميل أنواع الملاحظات:', error);
            }
        }

        // تحميل المراكز
        async function loadCenters() {
            try {
                const response = await fetch('/api/admin/centers');
                const data = await response.json();
                
                if (data.success) {
                    centers = data.centers;
                    updateCenterSelects();
                }
            } catch (error) {
                console.error('خطأ في تحميل المراكز:', error);
            }
        }

        // تحميل بيانات لوحة التحكم
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/dashboard/stats');
                const data = await response.json();
                
                if (data.success) {
                    updateStatsGrid(data.stats);
                    loadRecentObservations();
                }
            } catch (error) {
                console.error('خطأ في تحميل بيانات لوحة التحكم:', error);
            }
        }

        // تحميل التنبيهات
        async function loadNotifications() {
            try {
                const response = await fetch('/api/admin/notifications?unread_only=true');
                const data = await response.json();
                
                if (data.success) {
                    notifications = data.notifications;
                    updateNotificationBadge();
                }
            } catch (error) {
                console.error('خطأ في تحميل التنبيهات:', error);
            }
        }

        // تحديث شارة التنبيهات
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationCount');
            const unreadCount = notifications.filter(n => !n.is_read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // تحديث قوائم أنواع الملاحظات
        function updateObservationTypeSelects() {
            const selects = document.querySelectorAll('#observationType, #filterObservationType');
            
            selects.forEach(select => {
                // الاحتفاظ بالخيار الأول
                const firstOption = select.querySelector('option[value=""]');
                select.innerHTML = '';
                if (firstOption) {
                    select.appendChild(firstOption);
                }
                
                observationTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.id;
                    option.textContent = type.name;
                    select.appendChild(option);
                });
            });
        }

        // تحديث قوائم المراكز
        function updateCenterSelects() {
            const selects = document.querySelectorAll('#center');
            
            selects.forEach(select => {
                // الاحتفاظ بالخيار الأول
                const firstOption = select.querySelector('option[value=""]');
                select.innerHTML = '';
                if (firstOption) {
                    select.appendChild(firstOption);
                }
                
                centers.forEach(center => {
                    const option = document.createElement('option');
                    option.value = center.id;
                    option.textContent = center.name;
                    select.appendChild(option);
                });
            });
        }

        // تحديث شبكة الإحصائيات
        function updateStatsGrid(stats) {
            const grid = document.getElementById('statsGrid');
            
            const statsCards = [
                {
                    title: 'إجمالي الملاحظات',
                    value: stats.today_observations || 0,
                    icon: 'fas fa-eye',
                    color: 'var(--primary-color)',
                    change: '+12%'
                },
                {
                    title: 'الراصدين النشطين',
                    value: stats.users?.monitors || 0,
                    icon: 'fas fa-users',
                    color: 'var(--success-color)',
                    change: '+5%'
                },
                {
                    title: 'الورديات النشطة',
                    value: stats.shifts || 0,
                    icon: 'fas fa-clock',
                    color: 'var(--info-color)',
                    change: '0%'
                },
                {
                    title: 'المراكز والمحافظات',
                    value: stats.centers || 0,
                    icon: 'fas fa-map-marker-alt',
                    color: 'var(--warning-color)',
                    change: '+2%'
                }
            ];
            
            grid.innerHTML = statsCards.map(stat => `
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-title">${stat.title}</span>
                        <div class="stat-icon" style="background: ${stat.color};">
                            <i class="${stat.icon}"></i>
                        </div>
                    </div>
                    <div class="stat-value">${stat.value.toLocaleString()}</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i>
                        ${stat.change}
                    </div>
                </div>
            `).join('');
            
            // إضافة إحصائيات الورديات التفاعلية
            updateShiftStats(stats);
            
            // إضافة إحصائيات الأفراد النشطين/الخاملين
            updateUserActivityStats(stats);
            
            // إضافة رسوم بيانية للملاحظات حسب النوع
            updateObservationTypeChart(stats);
        }

        // تحديث إحصائيات الورديات
        function updateShiftStats(stats) {
            const shiftsContainer = document.getElementById('shiftsStats');
            if (!shiftsContainer) return;
            
            const shifts = [
                { name: 'الوردية الصباحية', observations: Math.floor(Math.random() * 50) + 10, active: Math.floor(Math.random() * 5) + 2 },
                { name: 'الوردية المسائية', observations: Math.floor(Math.random() * 40) + 8, active: Math.floor(Math.random() * 4) + 2 },
                { name: 'الوردية الليلية', observations: Math.floor(Math.random() * 30) + 5, active: Math.floor(Math.random() * 3) + 1 }
            ];
            
            shiftsContainer.innerHTML = `
                <div class="section-header">
                    <h3><i class="fas fa-clock"></i> إحصائيات الورديات</h3>
                </div>
                <div class="shifts-grid">
                    ${shifts.map(shift => `
                        <div class="shift-card">
                            <div class="shift-header">
                                <h4>${shift.name}</h4>
                                <span class="shift-status active">نشطة</span>
                            </div>
                            <div class="shift-stats">
                                <div class="shift-stat">
                                    <span class="stat-label">الملاحظات اليوم</span>
                                    <span class="stat-value">${shift.observations}</span>
                                </div>
                                <div class="shift-stat">
                                    <span class="stat-label">الراصدين النشطين</span>
                                    <span class="stat-value">${shift.active}</span>
                                </div>
                            </div>
                            <div class="shift-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${(shift.observations / 50) * 100}%"></div>
                                </div>
                                <span class="progress-text">${Math.round((shift.observations / 50) * 100)}% من الهدف</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // تحديث إحصائيات نشاط المستخدمين
        function updateUserActivityStats(stats) {
            const activityContainer = document.getElementById('userActivityStats');
            if (!activityContainer) return;
            
            const totalUsers = stats.users?.monitors || 12;
            const activeUsers = Math.floor(totalUsers * 0.7);
            const inactiveUsers = Math.floor(totalUsers * 0.2);
            const lowActivityUsers = totalUsers - activeUsers - inactiveUsers;
            
            activityContainer.innerHTML = `
                <div class="section-header">
                    <h3><i class="fas fa-chart-pie"></i> نشاط الراصدين</h3>
                </div>
                <div class="activity-grid">
                    <div class="activity-card active">
                        <div class="activity-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="activity-info">
                            <h4>نشطين</h4>
                            <span class="activity-count">${activeUsers}</span>
                            <span class="activity-percentage">${Math.round((activeUsers/totalUsers)*100)}%</span>
                        </div>
                    </div>
                    <div class="activity-card low">
                        <div class="activity-icon">
                            <i class="fas fa-user-clock"></i>
                        </div>
                        <div class="activity-info">
                            <h4>نشاط قليل</h4>
                            <span class="activity-count">${lowActivityUsers}</span>
                            <span class="activity-percentage">${Math.round((lowActivityUsers/totalUsers)*100)}%</span>
                        </div>
                    </div>
                    <div class="activity-card inactive">
                        <div class="activity-icon">
                            <i class="fas fa-user-times"></i>
                        </div>
                        <div class="activity-info">
                            <h4>خاملين</h4>
                            <span class="activity-count">${inactiveUsers}</span>
                            <span class="activity-percentage">${Math.round((inactiveUsers/totalUsers)*100)}%</span>
                        </div>
                    </div>
                </div>
                <div class="activity-chart">
                    <canvas id="activityChart" width="300" height="150"></canvas>
                </div>
            `;
            
            // رسم مخطط دائري بسيط
            drawActivityChart(activeUsers, lowActivityUsers, inactiveUsers);
        }

        // رسم مخطط نشاط المستخدمين
        function drawActivityChart(active, low, inactive) {
            const canvas = document.getElementById('activityChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 60;
            
            const total = active + low + inactive;
            let currentAngle = -Math.PI / 2;
            
            // رسم القطاعات
            const segments = [
                { value: active, color: '#10b981', label: 'نشطين' },
                { value: low, color: '#f59e0b', label: 'نشاط قليل' },
                { value: inactive, color: '#ef4444', label: 'خاملين' }
            ];
            
            segments.forEach(segment => {
                const sliceAngle = (segment.value / total) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = segment.color;
                ctx.fill();
                
                currentAngle += sliceAngle;
            });
        }

        // تحديث مخطط أنواع الملاحظات
        function updateObservationTypeChart(stats) {
            const chartContainer = document.getElementById('observationTypeChart');
            if (!chartContainer) return;
            
            const types = stats.observation_types || {};
            const typeNames = {
                'stop': 'توقف',
                'gathering': 'تجمع', 
                'boundary_exit': 'خروج من الحدود',
                'speed': 'تجاوز السرعة'
            };
            
            chartContainer.innerHTML = `
                <div class="section-header">
                    <h3><i class="fas fa-chart-bar"></i> الملاحظات حسب النوع</h3>
                </div>
                <div class="chart-bars">
                    ${Object.entries(types).map(([type, count]) => `
                        <div class="chart-bar">
                            <div class="bar-label">${typeNames[type] || type}</div>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: ${(count / Math.max(...Object.values(types))) * 100}%"></div>
                            </div>
                            <div class="bar-value">${count}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // تحميل أحدث الملاحظات
        async function loadRecentObservations() {
            try {
                const response = await fetch('/api/observations/list?per_page=10');
                const data = await response.json();
                
                if (data.success) {
                    updateRecentObservationsTable(data.observations);
                }
            } catch (error) {
                console.error('خطأ في تحميل أحدث الملاحظات:', error);
            }
        }

        // تحديث جدول أحدث الملاحظات
        function updateRecentObservationsTable(observations) {
            const container = document.getElementById('recentObservations');
            
            if (observations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-eye-slash"></i>
                        <h3>لا توجد ملاحظات</h3>
                        <p>لم يتم تسجيل أي ملاحظات بعد</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>النوع</th>
                            <th>رقم الآلية</th>
                            <th>المكان</th>
                            <th>الراصد</th>
                            <th>الحالة</th>
                            <th>التاريخ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${observations.map(obs => `
                            <tr>
                                <td>${obs.observation_type_name}</td>
                                <td>${obs.vehicle_number}</td>
                                <td>${obs.neighborhood} - ${obs.road}</td>
                                <td>${obs.observer_name}</td>
                                <td>
                                    <span class="badge badge-${getStatusBadgeClass(obs.status)}">
                                        ${obs.status_text}
                                    </span>
                                </td>
                                <td class="datetime-cell">${formatHijriDateTime(obs.observed_at)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // إضافة ملاحظة جديدة
        async function handleAddObservation(e) {
            e.preventDefault();
            
            const formData = {
                observation_type_id: document.getElementById('observationType').value,
                vehicle_number: document.getElementById('vehicleNumber').value,
                center_id: document.getElementById('center').value,
                neighborhood: document.getElementById('neighborhood').value,
                road: document.getElementById('road').value,
                observed_at: document.getElementById('observedAt').value,
                duration_minutes: document.getElementById('duration').value || null,
                action_taken: document.getElementById('actionTaken').value
            };
            
            try {
                const response = await fetch('/api/observations/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('تم حفظ الملاحظة بنجاح');
                    document.getElementById('addObservationForm').reset();
                    setCurrentDateTime();
                    loadDashboardData();
                } else {
                    showError(data.error || 'فشل في حفظ الملاحظة');
                }
            } catch (error) {
                console.error('خطأ في إضافة الملاحظة:', error);
                showError('حدث خطأ في الاتصال بالخادم');
            }
        }

        // تحديث الملف الشخصي
        function updateProfileForm() {
            if (!currentUser) return;
            
            document.getElementById('profileFullName').value = currentUser.full_name || '';
            document.getElementById('profileRank').value = currentUser.rank || '';
            document.getElementById('profileNationalId').value = currentUser.national_id || '';
            document.getElementById('profilePhone').value = currentUser.phone_number || '';
            document.getElementById('profileShift').value = currentUser.shift_name || 'غير محدد';
            document.getElementById('profileRole').value = currentUser.role === 'supervisor' ? 'مشرف' : 'راصد';
        }

        // تطبيق صلاحيات الراصد المحدودة
        function applyObserverPermissions() {
            // إخفاء صفحات الإدارة من الشريط الجانبي
            const restrictedPages = ['admin', 'centers', 'users', 'shifts'];
            restrictedPages.forEach(pageId => {
                const navItem = document.querySelector(`[data-page="${pageId}"]`);
                if (navItem) {
                    navItem.style.display = 'none';
                }
                
                const sidebarItem = document.querySelector(`a[data-page="${pageId}"]`);
                if (sidebarItem && sidebarItem.parentElement) {
                    sidebarItem.parentElement.style.display = 'none';
                }
            });
            
            // تحديد الوصول لصفحة الآليات (البحث فقط)
            const vehiclesNavItem = document.querySelector('[data-page="vehicles"]');
            if (vehiclesNavItem) {
                vehiclesNavItem.style.display = 'block';
                vehiclesNavItem.parentElement.style.display = 'block';
            }
            
            // إضافة مؤشر للراصد في الواجهة
            addObserverIndicators();
            
            // تطبيق فلاتر الملاحظات للراصد
            applyObservationFilters();
        }

        // إضافة مؤشرات للراصد في الواجهة
        function addObserverIndicators() {
            // إضافة تنبيه في صفحة الملاحظات
            const observationsPage = document.getElementById('observationsPage');
            if (observationsPage) {
                const existingAlert = observationsPage.querySelector('.observer-alert');
                if (!existingAlert) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'observer-alert';
                    alertDiv.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>صلاحيات الراصد:</strong> يمكنك عرض وإدارة الملاحظات التي أنشأتها فقط.
                        </div>
                    `;
                    observationsPage.insertBefore(alertDiv, observationsPage.firstChild.nextSibling);
                }
            }
            
            // إضافة تنبيه في صفحة الآليات
            const vehiclesPage = document.getElementById('vehiclesPage');
            if (vehiclesPage) {
                const existingAlert = vehiclesPage.querySelector('.observer-alert');
                if (!existingAlert) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'observer-alert';
                    alertDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-search"></i>
                            <strong>صلاحيات الراصد:</strong> يمكنك البحث في الآليات فقط، بدون إضافة أو تعديل.
                        </div>
                    `;
                    vehiclesPage.insertBefore(alertDiv, vehiclesPage.firstChild.nextSibling);
                }
            }
        }

        // تطبيق فلاتر الملاحظات للراصد
        function applyObservationFilters() {
            // تعديل دالة تحميل الملاحظات لتظهر ملاحظات الراصد فقط
            const originalLoadObservations = window.loadObservations;
            window.loadObservations = function() {
                if (currentUser && currentUser.role === 'observer') {
                    loadObserverObservations();
                } else if (originalLoadObservations) {
                    originalLoadObservations();
                }
            };
            
            // إخفاء أزرار الإضافة والتعديل في صفحة الآليات للراصد
            const vehiclesPage = document.getElementById('vehiclesPage');
            if (vehiclesPage) {
                // إخفاء أزرار الإضافة
                const addButtons = vehiclesPage.querySelectorAll('.btn-primary');
                addButtons.forEach(btn => {
                    if (btn.textContent.includes('إضافة') || btn.textContent.includes('استيراد')) {
                        btn.style.display = 'none';
                    }
                });
                
                // إخفاء أزرار التعديل والحذف في الجدول
                setTimeout(() => {
                    const actionButtons = vehiclesPage.querySelectorAll('.btn-outline, .btn-danger');
                    actionButtons.forEach(btn => {
                        if (btn.textContent.includes('تعديل') || btn.textContent.includes('حذف')) {
                            btn.style.display = 'none';
                        }
                    });
                }, 1000);
            }
        }

        // تحميل ملاحظات الراصد فقط
        async function loadObserverObservations() {
            try {
                const response = await fetch(`/api/observations?observer_id=${currentUser.id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const observations = await response.json();
                    displayObservations(observations);
                    updateObservationsStats(observations);
                } else {
                    showNotification('خطأ في تحميل الملاحظات', 'error');
                }
            } catch (error) {
                console.error('Error loading observer observations:', error);
                showNotification('حدث خطأ في الاتصال', 'error');
            }
        }

        // تحديث دالة عرض الملاحظات لإخفاء أزرار التعديل للملاحظات التي لا يملكها الراصد
        function displayObservations(observations) {
            const tableBody = document.getElementById('observationsTableBody');
            if (!tableBody) return;
            
            let html = '';
            
            observations.forEach(obs => {
                const canEdit = currentUser.role === 'supervisor' || 
                               (currentUser.role === 'observer' && obs.observer_id === currentUser.id);
                
                const actionButtons = canEdit ? `
                    <button class="btn btn-sm btn-outline" onclick="editObservation(${obs.id})" title="تعديل الملاحظة">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteObservation(${obs.id})" title="حذف الملاحظة">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : `
                    <button class="btn btn-sm btn-info" onclick="viewObservation(${obs.id})" title="عرض تفاصيل الملاحظة">
                        <i class="fas fa-eye"></i>
                    </button>
                `;
                
                html += `
                    <tr>
                        <td>${obs.id}</td>
                        <td>${obs.observation_type_name}</td>
                        <td>${obs.description}</td>
                        <td>${obs.location}</td>
                        <td>${obs.observer_name}</td>
                        <td>${formatHijriDate(obs.created_at)}</td>
                        <td>
                            <span class="status-badge ${obs.status === 'مفتوحة' ? 'open' : obs.status === 'قيد المعالجة' ? 'in-progress' : 'closed'}">
                                ${obs.status}
                            </span>
                        </td>
                        <td class="action-buttons">
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // معالجة تحديث الملف الشخصي
        async function handleUpdateProfile(e) {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword && newPassword !== confirmPassword) {
                showError('كلمات المرور غير متطابقة');
                return;
            }
            
            const updateData = {};
            if (newPassword) {
                updateData.password = newPassword;
            }
            
            try {
                const response = await fetch('/api/auth/update-profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('تم تحديث الملف الشخصي بنجاح');
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    showError(data.error || 'فشل في تحديث الملف الشخصي');
                }
            } catch (error) {
                console.error('خطأ في تحديث الملف الشخصي:', error);
                showError('حدث خطأ في الاتصال بالخادم');
            }
        }

        // عرض الصفحات
        function showPage(page) {
            // إخفاء جميع الصفحات
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // إزالة الفئة النشطة من جميع عناصر التنقل
            document.querySelectorAll('.nav-item, .sidebar-link').forEach(item => {
                item.classList.remove('active');
            });
            
            // إظهار الصفحة المطلوبة
            const pageElement = document.getElementById(page + 'Page');
            if (pageElement) {
                pageElement.classList.add('active');
            }
            
            // تفعيل عنصر التنقل المناسب
            document.querySelectorAll(`[data-page="${page}"]`).forEach(item => {
                item.classList.add('active');
            });
            
            currentPage = page;
            
            // تحميل بيانات الصفحة حسب الحاجة
            switch (page) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'observations':
                    loadObservationsPage();
                    break;
                case 'reports':
                    loadReportsPage();
                    break;
                case 'map':
                    loadMapPage();
                    break;
                case 'admin':
                    loadAdminPage();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'shifts':
                    loadShifts();
                    break;
            }
        }

        // تحميل صفحة الملاحظات
        async function loadObservationsPage() {
            // تحميل الملاحظات مع الفلاتر
            await loadObservations();
        }

        // تحميل الملاحظات
        async function loadObservations(filters = {}) {
            try {
                const params = new URLSearchParams(filters);
                const response = await fetch(`/api/observations/list?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    updateObservationsTable(data.observations);
                }
            } catch (error) {
                console.error('خطأ في تحميل الملاحظات:', error);
            }
        }

        // تحديث جدول الملاحظات
        function updateObservationsTable(observations) {
            const container = document.getElementById('observationsTable');
            
            if (observations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>لا توجد نتائج</h3>
                        <p>لم يتم العثور على ملاحظات تطابق معايير البحث</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>النوع</th>
                            <th>رقم الآلية</th>
                            <th>المكان</th>
                            <th>الراصد</th>
                            <th>الحالة</th>
                            <th>المدة</th>
                            <th>التاريخ</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${observations.map(obs => `
                            <tr>
                                <td>${obs.observation_type_name}</td>
                                <td>${obs.vehicle_number}</td>
                                <td>${obs.neighborhood}<br><small>${obs.road}</small></td>
                                <td>${obs.observer_name}<br><small>${obs.observer_rank}</small></td>
                                <td>
                                    <span class="badge badge-${getStatusBadgeClass(obs.status)}">
                                        ${obs.status_text}
                                    </span>
                                </td>
                                <td>
                                    <span class="duration-badge">
                                        ${obs.duration ? obs.duration + ' دقيقة' : 'غير محدد'}
                                    </span>
                                </td>
                                <td class="datetime-cell">${formatHijriDateTime(obs.observed_at)}</td>
                                <td>
                                    <button class="btn btn-outline btn-sm" onclick="viewObservation(${obs.id})" title="عرض التفاصيل">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${canEditObservation(obs) ? `
                                        <button class="btn btn-outline btn-sm" onclick="editObservation(${obs.id})" title="تعديل">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    ` : ''}
                                    ${isSupervisor() ? `
                                        <button class="btn btn-warning btn-sm" onclick="showSupervisorNoteModal(${obs.id}, '${obs.observer_name}')" title="ملاحظة المشرف">
                                            <i class="fas fa-comment-alt"></i>
                                        </button>
                                    ` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // تطبيق الفلاتر
        function applyFilters() {
            const filters = {
                date_from: document.getElementById('filterDateFrom').value,
                date_to: document.getElementById('filterDateTo').value,
                observation_type_id: document.getElementById('filterObservationType').value,
                status: document.getElementById('filterStatus').value
            };
            
            // إزالة الفلاتر الفارغة
            Object.keys(filters).forEach(key => {
                if (!filters[key]) {
                    delete filters[key];
                }
            });
            
            loadObservations(filters);
        }

        // مسح الفلاتر
        function clearFilters() {
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterObservationType').value = '';
            document.getElementById('filterStatus').value = '';
            
            loadObservations();
        }

        // تحميل صفحة التقارير
        async function loadReportsPage() {
            try {
                const response = await fetch('/api/observations/statistics');
                const data = await response.json();
                
                if (data.success) {
                    updateAdvancedStats(data.statistics);
                    // رسم الرسوم البيانية
                    drawTypeChart(data.statistics.by_type);
                    drawPerformanceChart(data.statistics.by_user || []);
                }
            } catch (error) {
                console.error('خطأ في تحميل صفحة التقارير:', error);
            }
        }

        // تحديث الإحصائيات المتقدمة
        function updateAdvancedStats(stats) {
            const container = document.getElementById('advancedStats');
            
            const advancedStatsCards = [
                {
                    title: 'متوسط الملاحظات اليومية',
                    value: Math.round(stats.total_observations / 30) || 0,
                    icon: 'fas fa-chart-line',
                    color: 'var(--info-color)'
                },
                {
                    title: 'معدل الاستجابة',
                    value: '95%',
                    icon: 'fas fa-tachometer-alt',
                    color: 'var(--success-color)'
                },
                {
                    title: 'الملاحظات العاجلة',
                    value: stats.by_priority?.find(p => p.priority === 'urgent')?.count || 0,
                    icon: 'fas fa-exclamation-triangle',
                    color: 'var(--error-color)'
                },
                {
                    title: 'الراصدين النشطين',
                    value: stats.active_monitors || 0,
                    icon: 'fas fa-users',
                    color: 'var(--primary-color)'
                }
            ];
            
            container.innerHTML = advancedStatsCards.map(stat => `
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-title">${stat.title}</span>
                        <div class="stat-icon" style="background: ${stat.color};">
                            <i class="${stat.icon}"></i>
                        </div>
                    </div>
                    <div class="stat-value">${typeof stat.value === 'number' ? stat.value.toLocaleString() : stat.value}</div>
                </div>
            `).join('');
        }

        // رسم مخطط الأنواع
        function drawTypeChart(typeData) {
            const canvas = document.getElementById('typeChart');
            const ctx = canvas.getContext('2d');
            
            // مسح الرسم السابق
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!typeData || typeData.length === 0) {
                ctx.fillStyle = '#64748b';
                ctx.font = '16px Cairo';
                ctx.textAlign = 'center';
                ctx.fillText('لا توجد بيانات للعرض', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // رسم مخطط دائري بسيط
            const total = typeData.reduce((sum, item) => sum + item.count, 0);
            let currentAngle = 0;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 20;
            
            typeData.forEach((item, index) => {
                const sliceAngle = (item.count / total) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                
                ctx.fillStyle = item.color || `hsl(${index * 360 / typeData.length}, 70%, 60%)`;
                ctx.fill();
                
                currentAngle += sliceAngle;
            });
        }

        // رسم مخطط الأداء
        function drawPerformanceChart(performanceData) {
            const canvas = document.getElementById('performanceChart');
            const ctx = canvas.getContext('2d');
            
            // مسح الرسم السابق
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!performanceData || performanceData.length === 0) {
                ctx.fillStyle = '#64748b';
                ctx.font = '16px Cairo';
                ctx.textAlign = 'center';
                ctx.fillText('لا توجد بيانات للعرض', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // رسم مخطط أعمدة بسيط
            const maxValue = Math.max(...performanceData.map(item => item.count));
            const barWidth = canvas.width / performanceData.length - 10;
            const maxBarHeight = canvas.height - 40;
            
            performanceData.forEach((item, index) => {
                const barHeight = (item.count / maxValue) * maxBarHeight;
                const x = index * (barWidth + 10) + 5;
                const y = canvas.height - barHeight - 20;
                
                ctx.fillStyle = '#2563eb';
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // عرض القيمة
                ctx.fillStyle = '#1e293b';
                ctx.font = '12px Cairo';
                ctx.textAlign = 'center';
                ctx.fillText(item.count.toString(), x + barWidth / 2, y - 5);
            });
        }

        // تحميل صفحة الإدارة
        async function loadAdminPage() {
            if (currentUser.role !== 'supervisor') return;
            
            try {
                const response = await fetch('/api/admin/dashboard');
                const data = await response.json();
                
                if (data.success) {
                    updateAdminStats(data.dashboard.statistics);
                    loadObservationTypesTable();
                    loadCentersTable();
                }
            } catch (error) {
                console.error('خطأ في تحميل صفحة الإدارة:', error);
            }
        }

        // تحديث إحصائيات الإدارة
        function updateAdminStats(stats) {
            const container = document.getElementById('adminStats');
            
            const adminStatsCards = [
                {
                    title: 'إجمالي المستخدمين',
                    value: stats.users.total || 0,
                    icon: 'fas fa-users',
                    color: 'var(--primary-color)'
                },
                {
                    title: 'المشرفين',
                    value: stats.users.supervisors || 0,
                    icon: 'fas fa-user-tie',
                    color: 'var(--info-color)'
                },
                {
                    title: 'الراصدين',
                    value: stats.users.monitors || 0,
                    icon: 'fas fa-user-shield',
                    color: 'var(--success-color)'
                },
                {
                    title: 'الورديات النشطة',
                    value: stats.system.shifts || 0,
                    icon: 'fas fa-clock',
                    color: 'var(--warning-color)'
                }
            ];
            
            container.innerHTML = adminStatsCards.map(stat => `
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-title">${stat.title}</span>
                        <div class="stat-icon" style="background: ${stat.color};">
                            <i class="${stat.icon}"></i>
                        </div>
                    </div>
                    <div class="stat-value">${stat.value.toLocaleString()}</div>
                </div>
            `).join('');
        }

        // تحميل جدول أنواع الملاحظات
        async function loadObservationTypesTable() {
            try {
                const response = await fetch('/api/admin/observation-types');
                const data = await response.json();
                
                if (data.success) {
                    updateObservationTypesTable(data.observation_types);
                }
            } catch (error) {
                console.error('خطأ في تحميل أنواع الملاحظات:', error);
            }
        }

        // تحديث جدول أنواع الملاحظات
        function updateObservationTypesTable(types) {
            const container = document.getElementById('observationTypesTable');
            
            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>الوصف</th>
                            <th>يتطلب مدة</th>
                            <th>اللون</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${types.map(type => `
                            <tr>
                                <td>${type.name}</td>
                                <td>${type.description || '-'}</td>
                                <td>
                                    <span class="badge badge-${type.requires_duration ? 'success' : 'secondary'}">
                                        ${type.requires_duration ? 'نعم' : 'لا'}
                                    </span>
                                </td>
                                <td>
                                    <div style="width: 20px; height: 20px; background: ${type.color_code}; border-radius: 4px; display: inline-block;"></div>
                                    ${type.color_code}
                                </td>
                                <td>
                                    <span class="badge badge-${type.is_active ? 'success' : 'secondary'}">
                                        ${type.is_active ? 'نشط' : 'غير نشط'}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-outline btn-sm" onclick="editObservationType(${type.id})" title="تعديل نوع الملاحظة">
                                            <i class="fas fa-edit"></i>
                                            تعديل
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteObservationType(${type.id})" title="حذف نوع الملاحظة">
                                            <i class="fas fa-trash"></i>
                                            حذف
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // تحميل جدول المراكز
        async function loadCentersTable() {
            try {
                const response = await fetch('/api/admin/centers');
                const data = await response.json();
                
                if (data.success) {
                    updateCentersTable(data.centers);
                }
            } catch (error) {
                console.error('خطأ في تحميل المراكز:', error);
            }
        }

        // تحديث جدول المراكز
        function updateCentersTable(centers) {
            const container = document.getElementById('centersTable');
            
            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>النوع</th>
                            <th>المركز الرئيسي</th>
                            <th>عدد الملاحظات</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${centers.map(center => `
                            <tr>
                                <td>${center.name}</td>
                                <td>
                                    <span class="badge badge-${center.type === 'center' ? 'primary' : 'info'}">
                                        ${center.type === 'center' ? 'مركز' : 'محافظة'}
                                    </span>
                                </td>
                                <td>${center.parent_name || '-'}</td>
                                <td>${center.observation_count || 0}</td>
                                <td>
                                    <span class="badge badge-${center.is_active ? 'success' : 'secondary'}">
                                        ${center.is_active ? 'نشط' : 'غير نشط'}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-outline btn-sm" onclick="editCenter(${center.id})" title="تعديل المركز/المحافظة">
                                            <i class="fas fa-edit"></i>
                                            تعديل
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteCenter(${center.id})" title="حذف المركز/المحافظة">
                                            <i class="fas fa-trash"></i>
                                            حذف
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // وظائف مساعدة
        function getStatusBadgeClass(status) {
            const classes = {
                'pending': 'warning',
                'reviewed': 'info',
                'approved': 'success',
                'rejected': 'error'
            };
            return classes[status] || 'secondary';
        }

        function canEditObservation(observation) {
            if (currentUser.role === 'supervisor') return true;
            if (currentUser.role === 'monitor' && observation.user_id === currentUser.id) {
                // الراصد يمكنه تعديل ملاحظاته في نفس اليوم
                const today = new Date().toDateString();
                const obsDate = new Date(observation.observed_at).toDateString();
                return today === obsDate;
            }
            return false;
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-SA') + ' ' + date.toLocaleTimeString('ar-SA', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function setCurrentDateTime() {
            const currentHijriDate = getCurrentHijriDate();
            const now = new Date();
            const time = now.toTimeString().slice(0, 5); // HH:MM
            
            const observedAtField = document.getElementById('observedAt');
            if (observedAtField) {
                observedAtField.value = `${currentHijriDate} ${time}`;
            }
            
            // تحديث حقل تاريخ الحضور
            const attendanceDateField = document.getElementById('attendanceDate');
            if (attendanceDateField && !attendanceDateField.value) {
                attendanceDateField.value = currentHijriDate;
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.querySelector('span').textContent = message;
            errorDiv.style.display = 'flex';
        }

        function hideError() {
            document.getElementById('loginError').style.display = 'none';
        }

        function showSuccess(message) {
            // يمكن إضافة نظام إشعارات أكثر تطوراً هنا
            alert(message);
        }

        function showAddObservationPage() {
            showPage('addObservation');
        }

        function showNotifications() {
            // إنشاء محتوى التنبيهات
            const notificationsHtml = `
                <div class="notifications-container">
                    <div class="notifications-header">
                        <h3>التنبيهات والمهام</h3>
                        <div class="notifications-actions">
                            <button class="btn btn-outline btn-sm" onclick="markAllAsRead()">
                                <i class="fas fa-check-double"></i>
                                تحديد الكل كمقروء
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="showAddTaskModal()">
                                <i class="fas fa-plus"></i>
                                إضافة مهمة
                            </button>
                        </div>
                    </div>
                    
                    <div class="notifications-tabs">
                        <button class="tab-btn active" onclick="showNotificationTab('all')">
                            <i class="fas fa-list"></i>
                            جميع التنبيهات
                        </button>
                        <button class="tab-btn" onclick="showNotificationTab('tasks')">
                            <i class="fas fa-tasks"></i>
                            المهام
                        </button>
                        <button class="tab-btn" onclick="showNotificationTab('alerts')">
                            <i class="fas fa-exclamation-triangle"></i>
                            التنبيهات
                        </button>
                    </div>
                    
                    <div class="notifications-content">
                        <div id="allNotifications" class="tab-content active">
                            <div class="notification-list" id="notificationsList">
                                <!-- سيتم ملؤها ديناميكياً -->
                            </div>
                        </div>
                        
                        <div id="tasksNotifications" class="tab-content">
                            <div class="task-list" id="tasksList">
                                <!-- سيتم ملؤها ديناميكياً -->
                            </div>
                        </div>
                        
                        <div id="alertsNotifications" class="tab-content">
                            <div class="alert-list" id="alertsList">
                                <!-- سيتم ملؤها ديناميكياً -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // عرض المودال
            showModal('التنبيهات والمهام', notificationsHtml);
            
            // تحميل البيانات
            loadNotificationsData();
        }

        // التحكم في القائمة المنسدلة للمستخدم
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
            
            // إغلاق القائمة عند النقر خارجها
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.user-info')) {
                    dropdown.classList.remove('show');
                }
            });
        }

        // عرض الملف الشخصي
        function showUserProfile() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            const profileHtml = `
                <div class="profile-container">
                    <div class="profile-header">
                        <div class="profile-avatar">${currentUser.full_name ? currentUser.full_name.charAt(0) : 'م'}</div>
                        <h3>${currentUser.full_name || 'المستخدم'}</h3>
                        <p>${currentUser.rank || 'الرتبة'}</p>
                        <div class="profile-badges">
                            <span class="badge ${currentUser.role === 'supervisor' ? 'supervisor' : 'observer'}">
                                ${currentUser.role === 'supervisor' ? 'مشرف' : 'راصد'}
                            </span>
                            <span class="badge shift">${currentUser.shift_name || 'غير محدد'}</span>
                        </div>
                    </div>
                    
                    <div class="profile-content">
                        <div class="profile-info">
                            <h4><i class="fas fa-user"></i> المعلومات الشخصية</h4>
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>رقم الهوية:</label>
                                    <span>${currentUser.national_id || 'غير محدد'}</span>
                                </div>
                                <div class="info-item">
                                    <label>رقم الجوال:</label>
                                    <span>${currentUser.phone_number || 'غير محدد'}</span>
                                </div>
                                <div class="info-item">
                                    <label>المركز:</label>
                                    <span>${currentUser.center_name || 'غير محدد'}</span>
                                </div>
                                <div class="info-item">
                                    <label>الوردية:</label>
                                    <span>${currentUser.shift_name || 'غير محدد'}</span>
                                </div>
                            </div>
                        </div>
                        
                        ${currentUser.role === 'observer' ? `
                        <div class="handover-stats">
                            <h4><i class="fas fa-exchange-alt"></i> إحصائيات التسليم والاستلام</h4>
                            <div class="handover-grid">
                                <div class="handover-card delivered">
                                    <div class="handover-icon">
                                        <i class="fas fa-paper-plane"></i>
                                    </div>
                                    <div class="handover-content">
                                        <div class="handover-number" id="deliveredCount">0</div>
                                        <div class="handover-label">ملاحظات مسلمة</div>
                                        <div class="handover-subtitle">تم تسليمها للمشرف</div>
                                    </div>
                                </div>
                                
                                <div class="handover-card received">
                                    <div class="handover-icon">
                                        <i class="fas fa-inbox"></i>
                                    </div>
                                    <div class="handover-content">
                                        <div class="handover-number" id="receivedCount">0</div>
                                        <div class="handover-label">ملاحظات مستلمة</div>
                                        <div class="handover-subtitle">تم استلامها من الوردية السابقة</div>
                                    </div>
                                </div>
                                
                                <div class="handover-card pending">
                                    <div class="handover-icon">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="handover-content">
                                        <div class="handover-number" id="pendingCount">0</div>
                                        <div class="handover-label">ملاحظات معلقة</div>
                                        <div class="handover-subtitle">في انتظار المراجعة</div>
                                    </div>
                                </div>
                                
                                <div class="handover-card completed">
                                    <div class="handover-icon">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="handover-content">
                                        <div class="handover-number" id="completedCount">0</div>
                                        <div class="handover-label">ملاحظات مكتملة</div>
                                        <div class="handover-subtitle">تم إنجازها بالكامل</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="performance-metrics">
                                <h5><i class="fas fa-chart-line"></i> مؤشرات الأداء</h5>
                                <div class="metrics-grid">
                                    <div class="metric-item">
                                        <div class="metric-label">معدل التسليم اليومي</div>
                                        <div class="metric-value" id="dailyDeliveryRate">0</div>
                                        <div class="metric-unit">ملاحظة/يوم</div>
                                    </div>
                                    <div class="metric-item">
                                        <div class="metric-label">معدل الإنجاز</div>
                                        <div class="metric-value" id="completionRate">0%</div>
                                        <div class="metric-unit">من المجموع</div>
                                    </div>
                                    <div class="metric-item">
                                        <div class="metric-label">متوسط وقت المعالجة</div>
                                        <div class="metric-value" id="avgProcessingTime">0</div>
                                        <div class="metric-unit">ساعة</div>
                                    </div>
                                    <div class="metric-item">
                                        <div class="metric-label">تقييم الأداء</div>
                                        <div class="metric-value performance-rating" id="performanceRating">ممتاز</div>
                                        <div class="metric-unit">التقييم العام</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="handover-timeline">
                                <h5><i class="fas fa-history"></i> آخر عمليات التسليم والاستلام</h5>
                                <div class="timeline-container" id="handoverTimeline">
                                    <!-- سيتم ملؤها ديناميكياً -->
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="profile-stats">
                            <h4><i class="fas fa-chart-bar"></i> إحصائيات عامة</h4>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-icon observations">
                                        <i class="fas fa-eye"></i>
                                    </div>
                                    <div class="stat-content">
                                        <span class="stat-number" id="userObservationsCount">0</span>
                                        <span class="stat-label">إجمالي الملاحظات</span>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon tasks">
                                        <i class="fas fa-tasks"></i>
                                    </div>
                                    <div class="stat-content">
                                        <span class="stat-number" id="userTasksCount">0</span>
                                        <span class="stat-label">المهام المكلف بها</span>
                                    </div>
                                </div>
                                ${currentUser.role === 'observer' ? `
                                <div class="stat-card">
                                    <div class="stat-icon shifts">
                                        <i class="fas fa-calendar-check"></i>
                                    </div>
                                    <div class="stat-content">
                                        <span class="stat-number" id="userShiftsCount">0</span>
                                        <span class="stat-label">أيام العمل هذا الشهر</span>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon efficiency">
                                        <i class="fas fa-tachometer-alt"></i>
                                    </div>
                                    <div class="stat-content">
                                        <span class="stat-number" id="userEfficiencyRate">0%</span>
                                        <span class="stat-label">معدل الكفاءة</span>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                .profile-container { max-width: 800px; margin: 0 auto; }
                .profile-header { text-align: center; padding: 2rem; background: linear-gradient(135deg, var(--primary-color), #1e40af); color: white; border-radius: 12px 12px 0 0; }
                .profile-avatar { width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; margin: 0 auto 1rem; }
                .profile-header h3 { margin: 0 0 0.5rem 0; font-size: 1.5rem; }
                .profile-header p { margin: 0 0 1rem 0; opacity: 0.9; }
                .profile-badges { display: flex; gap: 0.5rem; justify-content: center; }
                .badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
                .badge.supervisor { background: #ef4444; color: white; }
                .badge.observer { background: #10b981; color: white; }
                .badge.shift { background: rgba(255,255,255,0.2); color: white; }
                .profile-content { padding: 2rem; background: white; border-radius: 0 0 12px 12px; }
                .profile-info h4, .profile-stats h4, .handover-stats h4 { margin: 0 0 1.5rem 0; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem; }
                .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
                .info-item { display: flex; justify-content: space-between; padding: 0.75rem; background: #f8fafc; border-radius: 8px; }
                .info-item label { font-weight: 600; color: #374151; }
                .info-item span { color: #6b7280; }
                
                .handover-stats { margin-bottom: 2rem; }
                .handover-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
                .handover-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; display: flex; align-items: center; gap: 1rem; transition: all 0.3s ease; }
                .handover-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
                .handover-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white; }
                .handover-card.delivered .handover-icon { background: linear-gradient(135deg, #3b82f6, #2563eb); }
                .handover-card.received .handover-icon { background: linear-gradient(135deg, #10b981, #059669); }
                .handover-card.pending .handover-icon { background: linear-gradient(135deg, #f59e0b, #d97706); }
                .handover-card.completed .handover-icon { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
                .handover-content { flex: 1; }
                .handover-number { font-size: 2rem; font-weight: 700; color: #1f2937; line-height: 1; }
                .handover-label { font-size: 0.9rem; font-weight: 600; color: #374151; margin: 0.25rem 0; }
                .handover-subtitle { font-size: 0.8rem; color: #6b7280; }
                
                .performance-metrics { margin-bottom: 2rem; }
                .performance-metrics h5 { margin: 0 0 1rem 0; color: #374151; display: flex; align-items: center; gap: 0.5rem; }
                .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
                .metric-item { text-align: center; padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e5e7eb; }
                .metric-label { font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem; }
                .metric-value { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
                .metric-value.performance-rating.excellent { color: #059669; }
                .metric-value.performance-rating.good { color: #10b981; }
                .metric-value.performance-rating.average { color: #f59e0b; }
                .metric-value.performance-rating.poor { color: #ef4444; }
                .metric-unit { font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem; }
                
                .handover-timeline { }
                .handover-timeline h5 { margin: 0 0 1rem 0; color: #374151; display: flex; align-items: center; gap: 0.5rem; }
                .timeline-container { max-height: 300px; overflow-y: auto; }
                .timeline-item { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border-left: 3px solid #e5e7eb; margin-bottom: 0.5rem; background: #f8fafc; border-radius: 0 8px 8px 0; }
                .timeline-item.delivered { border-left-color: #3b82f6; }
                .timeline-item.received { border-left-color: #10b981; }
                .timeline-icon { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: white; }
                .timeline-item.delivered .timeline-icon { background: #3b82f6; }
                .timeline-item.received .timeline-icon { background: #10b981; }
                .timeline-content { flex: 1; }
                .timeline-title { font-weight: 600; color: #1f2937; margin-bottom: 0.25rem; }
                .timeline-details { font-size: 0.8rem; color: #6b7280; }
                .timeline-time { font-size: 0.75rem; color: #9ca3af; white-space: nowrap; }
                
                .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
                .stat-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; display: flex; align-items: center; gap: 1rem; transition: all 0.3s ease; }
                .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
                .stat-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white; }
                .stat-icon.observations { background: linear-gradient(135deg, #3b82f6, #2563eb); }
                .stat-icon.tasks { background: linear-gradient(135deg, #10b981, #059669); }
                .stat-icon.shifts { background: linear-gradient(135deg, #f59e0b, #d97706); }
                .stat-icon.efficiency { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
                .stat-content { flex: 1; }
                .stat-number { display: block; font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
                .stat-label { font-size: 0.875rem; color: var(--text-secondary); }
                </style>
            `;
            
            showModal('الملف الشخصي', profileHtml);
            loadUserStats();
            
            // تحميل إحصائيات التسليم والاستلام للراصد
            if (currentUser.role === 'observer') {
                loadHandoverStats();
            }
        }

        // تحميل إحصائيات المستخدم
        async function loadUserStats() {
            try {
                const response = await fetch('/api/dashboard/user-stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('userObservationsCount').textContent = data.observations_count || 0;
                    document.getElementById('userTasksCount').textContent = data.tasks_count || 0;
                    
                    // إحصائيات إضافية للراصد
                    if (data.shifts_count !== undefined) {
                        const shiftsElement = document.getElementById('userShiftsCount');
                        if (shiftsElement) shiftsElement.textContent = data.shifts_count || 0;
                    }
                    
                    if (data.efficiency_rate !== undefined) {
                        const efficiencyElement = document.getElementById('userEfficiencyRate');
                        if (efficiencyElement) efficiencyElement.textContent = `${data.efficiency_rate || 0}%`;
                    }
                }
            } catch (error) {
                console.error('خطأ في تحميل إحصائيات المستخدم:', error);
            }
        }

        // تحميل إحصائيات التسليم والاستلام للراصد
        async function loadHandoverStats() {
            try {
                const response = await fetch('/api/dashboard/handover-stats', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    // تحديث بطاقات الإحصائيات
                    document.getElementById('deliveredCount').textContent = data.delivered_count || 0;
                    document.getElementById('receivedCount').textContent = data.received_count || 0;
                    document.getElementById('pendingCount').textContent = data.pending_count || 0;
                    document.getElementById('completedCount').textContent = data.completed_count || 0;
                    
                    // تحديث مؤشرات الأداء
                    document.getElementById('dailyDeliveryRate').textContent = data.daily_delivery_rate || 0;
                    document.getElementById('completionRate').textContent = `${data.completion_rate || 0}%`;
                    document.getElementById('avgProcessingTime').textContent = data.avg_processing_time || 0;
                    
                    // تحديث تقييم الأداء مع الألوان
                    const performanceElement = document.getElementById('performanceRating');
                    const rating = data.performance_rating || 'متوسط';
                    performanceElement.textContent = rating;
                    performanceElement.className = 'metric-value performance-rating';
                    
                    if (rating === 'ممتاز') {
                        performanceElement.classList.add('excellent');
                    } else if (rating === 'جيد') {
                        performanceElement.classList.add('good');
                    } else if (rating === 'متوسط') {
                        performanceElement.classList.add('average');
                    } else {
                        performanceElement.classList.add('poor');
                    }
                    
                    // تحديث الجدول الزمني
                    updateHandoverTimeline(data.timeline || []);
                }
            } catch (error) {
                console.error('خطأ في تحميل إحصائيات التسليم والاستلام:', error);
                // عرض بيانات تجريبية في حالة الخطأ
                loadSampleHandoverData();
            }
        }

        // تحديث الجدول الزمني لعمليات التسليم والاستلام
        function updateHandoverTimeline(timeline) {
            const container = document.getElementById('handoverTimeline');
            if (!container) return;
            
            if (timeline.length === 0) {
                container.innerHTML = `
                    <div class="empty-timeline">
                        <i class="fas fa-info-circle"></i>
                        <p>لا توجد عمليات تسليم أو استلام حديثة</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            timeline.forEach(item => {
                const isDelivered = item.type === 'delivered';
                html += `
                    <div class="timeline-item ${item.type}">
                        <div class="timeline-icon">
                            <i class="fas fa-${isDelivered ? 'paper-plane' : 'inbox'}"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">${item.title}</div>
                            <div class="timeline-details">${item.details}</div>
                        </div>
                        <div class="timeline-time">${formatTimeAgo(item.timestamp)}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // تحميل بيانات تجريبية للتسليم والاستلام
        function loadSampleHandoverData() {
            // بيانات تجريبية للعرض
            document.getElementById('deliveredCount').textContent = '12';
            document.getElementById('receivedCount').textContent = '8';
            document.getElementById('pendingCount').textContent = '3';
            document.getElementById('completedCount').textContent = '15';
            
            document.getElementById('dailyDeliveryRate').textContent = '4';
            document.getElementById('completionRate').textContent = '85%';
            document.getElementById('avgProcessingTime').textContent = '2.5';
            
            const performanceElement = document.getElementById('performanceRating');
            performanceElement.textContent = 'جيد';
            performanceElement.className = 'metric-value performance-rating good';
            
            // جدول زمني تجريبي
            const sampleTimeline = [
                {
                    type: 'delivered',
                    title: 'تسليم 3 ملاحظات',
                    details: 'تم تسليم ملاحظات الوردية الصباحية للمشرف',
                    timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000) // منذ ساعتين
                },
                {
                    type: 'received',
                    title: 'استلام 2 ملاحظة',
                    details: 'تم استلام ملاحظات من الوردية السابقة',
                    timestamp: new Date(Date.now() - 8 * 60 * 60 * 1000) // منذ 8 ساعات
                },
                {
                    type: 'delivered',
                    title: 'تسليم ملاحظة عاجلة',
                    details: 'ملاحظة أمنية عالية الأولوية',
                    timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000) // منذ يوم
                }
            ];
            
            updateHandoverTimeline(sampleTimeline);
        }

        // تنسيق الوقت المنقضي
        function formatTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffInSeconds = Math.floor((now - time) / 1000);
            
            if (diffInSeconds < 60) {
                return 'منذ لحظات';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `منذ ${minutes} دقيقة`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `منذ ${hours} ساعة`;
            } else {
                const days = Math.floor(diffInSeconds / 86400);
                return `منذ ${days} يوم`;
            }
        }

        // عرض مودال تغيير كلمة المرور
        function showChangePasswordModal() {
            const modalHtml = `
                <form onsubmit="changePassword(event)">
                    <div class="form-group">
                        <label class="form-label">كلمة المرور الحالية</label>
                        <input type="password" id="currentPassword" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">كلمة المرور الجديدة</label>
                        <input type="password" id="newPassword" class="form-input" required minlength="6">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">تأكيد كلمة المرور الجديدة</label>
                        <input type="password" id="confirmPassword" class="form-input" required>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline" onclick="closeModal()">إلغاء</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            تغيير كلمة المرور
                        </button>
                    </div>
                </form>
            `;
            
            showModal('تغيير كلمة المرور', modalHtml);
        }

        // تغيير كلمة المرور
        async function changePassword(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showNotification('كلمة المرور الجديدة وتأكيدها غير متطابقين', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('تم تغيير كلمة المرور بنجاح', 'success');
                    closeModal();
                } else {
                    showNotification(data.message || 'خطأ في تغيير كلمة المرور', 'error');
                }
            } catch (error) {
                console.error('خطأ في تغيير كلمة المرور:', error);
                showNotification('خطأ في الاتصال بالخادم', 'error');
            }
        }

        // عرض المهام والتنبيهات الخاصة بالمستخدم
        function showUserTasks() {
            showPage('notifications');
            closeModal();
        }

        function showUserMenu() {
            // دالة قديمة - تم استبدالها بـ toggleUserDropdown
            toggleUserDropdown();
        }

        function refreshObservations() {
            loadRecentObservations();
        }

        function exportObservations() {
            // تصدير الملاحظات إلى Excel
            try {
                // جمع البيانات المفلترة الحالية
                const filters = {
                    date_from: document.getElementById('filterDateFrom').value,
                    date_to: document.getElementById('filterDateTo').value,
                    observation_type: document.getElementById('filterObservationType').value,
                    status: document.getElementById('filterStatus').value,
                    observer: document.getElementById('filterObserver').value
                };
                
                // إنشاء URL مع المعاملات
                const params = new URLSearchParams();
                Object.keys(filters).forEach(key => {
                    if (filters[key]) {
                        params.append(key, filters[key]);
                    }
                });
                
                // تحميل الملف
                const url = `/api/observations/export?${params.toString()}`;
                const link = document.createElement('a');
                link.href = url;
                link.download = `observations_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('تم بدء تحميل ملف التصدير', 'success');
            } catch (error) {
                console.error('خطأ في تصدير الملاحظات:', error);
                showNotification('حدث خطأ في تصدير الملاحظات', 'error');
            }
        }

        function viewObservation(id) {
            // عرض تفاصيل الملاحظة في مودال
            fetch(`/api/observations/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const obs = data.observation;
                        const modalHtml = `
                            <div class="observation-details">
                                <div class="detail-row">
                                    <label>نوع الملاحظة:</label>
                                    <span>${obs.observation_type_name}</span>
                                </div>
                                <div class="detail-row">
                                    <label>رقم الآلية:</label>
                                    <span>${obs.vehicle_number}</span>
                                </div>
                                <div class="detail-row">
                                    <label>المكان:</label>
                                    <span>${obs.neighborhood} - ${obs.road}</span>
                                </div>
                                <div class="detail-row">
                                    <label>الراصد:</label>
                                    <span>${obs.observer_name} (${obs.observer_rank})</span>
                                </div>
                                <div class="detail-row">
                                    <label>الحالة:</label>
                                    <span class="badge badge-${getStatusBadgeClass(obs.status)}">${obs.status_text}</span>
                                </div>
                                <div class="detail-row">
                                    <label>المدة:</label>
                                    <span>${obs.duration ? obs.duration + ' دقيقة' : 'غير محدد'}</span>
                                </div>
                                <div class="detail-row">
                                    <label>تاريخ الرصد:</label>
                                    <span>${formatDateTime(obs.observed_at)}</span>
                                </div>
                                ${obs.notes ? `
                                    <div class="detail-row">
                                        <label>ملاحظات:</label>
                                        <span>${obs.notes}</span>
                                    </div>
                                ` : ''}
                                ${obs.supervisor_notes ? `
                                    <div class="detail-row supervisor-note">
                                        <label>ملاحظة المشرف:</label>
                                        <span>${obs.supervisor_notes}</span>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                        
                        showModal('تفاصيل الملاحظة', modalHtml);
                    } else {
                        showNotification('خطأ في جلب تفاصيل الملاحظة', 'error');
                    }
                })
                .catch(error => {
                    console.error('خطأ في جلب تفاصيل الملاحظة:', error);
                    showNotification('خطأ في الاتصال بالخادم', 'error');
                });
        }

        function editObservation(id) {
            // تعديل الملاحظة - جلب البيانات أولاً
            fetch(`/api/observations/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const obs = data.observation;
                        const modalHtml = `
                            <form onsubmit="updateObservation(event, ${id})">
                                <div class="form-group">
                                    <label class="form-label">نوع الملاحظة</label>
                                    <select id="editObservationType" class="form-select" required>
                                        ${observationTypes.map(type => 
                                            `<option value="${type.id}" ${type.id == obs.observation_type_id ? 'selected' : ''}>${type.name}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">رقم الآلية</label>
                                    <input type="text" id="editVehicleNumber" class="form-input" value="${obs.vehicle_number}" required>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">الحي</label>
                                        <input type="text" id="editNeighborhood" class="form-input" value="${obs.neighborhood}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">الشارع</label>
                                        <input type="text" id="editRoad" class="form-input" value="${obs.road}" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">المدة (بالدقائق)</label>
                                    <input type="number" id="editDuration" class="form-input" value="${obs.duration || ''}" min="1">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">الحالة</label>
                                    <select id="editStatus" class="form-select" required>
                                        <option value="active" ${obs.status === 'active' ? 'selected' : ''}>نشط</option>
                                        <option value="resolved" ${obs.status === 'resolved' ? 'selected' : ''}>تم الحل</option>
                                        <option value="pending" ${obs.status === 'pending' ? 'selected' : ''}>في الانتظار</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">ملاحظات إضافية</label>
                                    <textarea id="editNotes" class="form-textarea" rows="3">${obs.notes || ''}</textarea>
                                </div>
                                
                                <div class="modal-actions">
                                    <button type="button" class="btn btn-outline" onclick="closeModal()">إلغاء</button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i>
                                        حفظ التعديلات
                                    </button>
                                </div>
                            </form>
                        `;
                        
                        showModal('تعديل الملاحظة', modalHtml);
                    } else {
                        showNotification('خطأ في جلب بيانات الملاحظة', 'error');
                    }
                })
                .catch(error => {
                    console.error('خطأ في جلب بيانات الملاحظة:', error);
                    showNotification('خطأ في الاتصال بالخادم', 'error');
                });
        }

        // تحديث الملاحظة
        async function updateObservation(event, id) {
            event.preventDefault();
            
            const formData = {
                observation_type_id: document.getElementById('editObservationType').value,
                vehicle_number: document.getElementById('editVehicleNumber').value,
                neighborhood: document.getElementById('editNeighborhood').value,
                road: document.getElementById('editRoad').value,
                duration: document.getElementById('editDuration').value || null,
                status: document.getElementById('editStatus').value,
                notes: document.getElementById('editNotes').value
            };
            
            try {
                const response = await fetch(`/api/observations/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('تم تحديث الملاحظة بنجاح', 'success');
                    closeModal();
                    loadRecentObservations(); // إعادة تحميل الجدول
                } else {
                    showNotification(data.message || 'خطأ في تحديث الملاحظة', 'error');
                }
            } catch (error) {
                console.error('خطأ في تحديث الملاحظة:', error);
                showNotification('خطأ في الاتصال بالخادم', 'error');
            }
        }

        function showAddObservationTypeModal() {
            // عرض مودال إضافة نوع ملاحظة محسن ومطور
            showModal('إضافة نوع ملاحظة جديد', `
                <div class="modern-form-container">
                    <div class="form-header">
                        <div class="form-icon">
                            <i class="fas fa-plus-circle"></i>
                        </div>
                        <div class="form-title">
                            <h3>إضافة نوع ملاحظة جديد</h3>
                            <p>قم بتعبئة البيانات التالية لإضافة نوع ملاحظة جديد للنظام</p>
                        </div>
                    </div>
                    
                    <form id="addObservationTypeForm" class="enhanced-form modern-form">
                        <div class="form-section">
                            <div class="section-header">
                                <i class="fas fa-info-circle"></i>
                                <span>المعلومات الأساسية</span>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-tag"></i>
                                        اسم النوع *
                                    </label>
                                    <input type="text" id="observationTypeName" class="form-input modern-input" 
                                           placeholder="مثال: مخالفة سرعة، وقوف خاطئ، تجاوز الإشارة الحمراء" 
                                           maxlength="100" required
                                           title="أدخل اسم نوع الملاحظة (مطلوب)">
                                    <div class="form-help">
                                        <i class="fas fa-lightbulb"></i>
                                        اختر اسماً واضحاً ومختصراً يصف نوع الملاحظة بدقة
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-align-left"></i>
                                        الوصف التفصيلي
                                    </label>
                                    <textarea id="observationTypeDescription" class="form-textarea modern-textarea" 
                                              placeholder="اكتب وصفاً تفصيلياً لنوع الملاحظة، متى يُستخدم، وما يشمله من حالات..."
                                              maxlength="500" rows="4"
                                              title="وصف تفصيلي لنوع الملاحظة (اختياري)"></textarea>
                                    <div class="form-help">
                                        <i class="fas fa-info"></i>
                                        وصف يساعد الراصدين على فهم متى وكيف يستخدمون هذا النوع
                                    </div>
                                    <div class="char-counter">
                                        <span id="descriptionCounter">0</span>/500 حرف
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-header">
                                <i class="fas fa-cogs"></i>
                                <span>الإعدادات المتقدمة</span>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        مستوى الأولوية الافتراضي
                                    </label>
                                    <div class="priority-selector">
                                        <select id="observationTypeDefaultPriority" class="form-select modern-select"
                                                title="مستوى الأولوية الافتراضي لهذا النوع من الملاحظات">
                                            <option value="low" data-color="#28a745">منخفضة - للملاحظات العادية</option>
                                            <option value="medium" selected data-color="#ffc107">متوسطة - للملاحظات المهمة</option>
                                            <option value="high" data-color="#dc3545">عالية - للملاحظات العاجلة</option>
                                        </select>
                                        <div class="priority-indicator" id="priorityIndicator"></div>
                                    </div>
                                    <div class="form-help">
                                        <i class="fas fa-chart-line"></i>
                                        الأولوية التي ستظهر افتراضياً عند اختيار هذا النوع من الملاحظات
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-palette"></i>
                                        لون التمييز
                                    </label>
                                    <div class="color-picker-enhanced">
                                        <div class="color-input-container">
                                            <input type="color" id="observationTypeColor" class="form-color-input modern-color" 
                                                   value="#007bff" title="اختر لون لتمييز هذا النوع في التقارير والخرائط">
                                            <div class="color-preview-enhanced" id="colorPreview">
                                                <span class="color-value">#007bff</span>
                                            </div>
                                        </div>
                                        <div class="color-presets">
                                            <span class="preset-color" data-color="#007bff" title="أزرق افتراضي"></span>
                                            <span class="preset-color" data-color="#28a745" title="أخضر"></span>
                                            <span class="preset-color" data-color="#dc3545" title="أحمر"></span>
                                            <span class="preset-color" data-color="#ffc107" title="أصفر"></span>
                                            <span class="preset-color" data-color="#6f42c1" title="بنفسجي"></span>
                                            <span class="preset-color" data-color="#fd7e14" title="برتقالي"></span>
                                        </div>
                                    </div>
                                    <div class="form-help">
                                        <i class="fas fa-eye"></i>
                                        لون يساعد في تمييز هذا النوع بصرياً في الخرائط والتقارير والإحصائيات
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-toggle-on"></i>
                                        حالة النوع
                                    </label>
                                    <div class="status-toggle-container">
                                        <div class="form-switch-enhanced">
                                            <label class="form-switch modern-switch">
                                                <input type="checkbox" id="observationTypeActive" checked>
                                                <span class="form-switch-slider modern-slider"></span>
                                            </label>
                                            <div class="switch-labels">
                                                <span class="switch-label active" id="activeLabel">نشط</span>
                                                <span class="switch-label inactive" id="inactiveLabel">غير نشط</span>
                                            </div>
                                        </div>
                                        <div class="status-description">
                                            <span id="statusDescription">النوع متاح للاستخدام من قبل جميع الراصدين</span>
                                        </div>
                                    </div>
                                    <div class="form-help">
                                        <i class="fas fa-info-circle"></i>
                                        يمكن إلغاء تفعيل النوع مؤقتاً دون حذفه من النظام
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions modern-actions">
                            <button type="submit" class="btn btn-primary modern-btn primary-btn" title="حفظ نوع الملاحظة الجديد">
                                <i class="fas fa-save"></i>
                                <span>حفظ النوع</span>
                                <div class="btn-ripple"></div>
                            </button>
                            <button type="button" class="btn btn-outline modern-btn secondary-btn" onclick="closeModal()" title="إلغاء العملية وإغلاق النافذة">
                                <i class="fas fa-times"></i>
                                <span>إلغاء</span>
                                <div class="btn-ripple"></div>
                            </button>
                        </div>
                    </form>
                </div>
            `);
            
            // تحديث معاينة اللون المحسنة
            const colorInput = document.getElementById('observationTypeColor');
            const colorPreview = document.getElementById('colorPreview');
            const prioritySelect = document.getElementById('observationTypeDefaultPriority');
            const priorityIndicator = document.getElementById('priorityIndicator');
            const descriptionTextarea = document.getElementById('observationTypeDescription');
            const descriptionCounter = document.getElementById('descriptionCounter');
            const activeSwitch = document.getElementById('observationTypeActive');
            const statusDescription = document.getElementById('statusDescription');
            const activeLabel = document.getElementById('activeLabel');
            const inactiveLabel = document.getElementById('inactiveLabel');
            
            // تحديث معاينة اللون
            function updateColorPreview() {
                const color = colorInput.value;
                colorPreview.style.backgroundColor = color;
                colorPreview.querySelector('.color-value').textContent = color;
            }
            
            // تحديث مؤشر الأولوية
            function updatePriorityIndicator() {
                const selectedOption = prioritySelect.options[prioritySelect.selectedIndex];
                const color = selectedOption.getAttribute('data-color');
                priorityIndicator.style.backgroundColor = color;
            }
            
            // تحديث عداد الأحرف
            function updateCharCounter() {
                const length = descriptionTextarea.value.length;
                descriptionCounter.textContent = length;
                
                if (length > 450) {
                    descriptionCounter.style.color = '#dc3545';
                } else if (length > 350) {
                    descriptionCounter.style.color = '#ffc107';
                } else {
                    descriptionCounter.style.color = '#64748b';
                }
            }
            
            // تحديث وصف الحالة
            function updateStatusDescription() {
                if (activeSwitch.checked) {
                    statusDescription.textContent = 'النوع متاح للاستخدام من قبل جميع الراصدين';
                    activeLabel.style.opacity = '1';
                    inactiveLabel.style.opacity = '0.5';
                } else {
                    statusDescription.textContent = 'النوع غير متاح مؤقتاً ولن يظهر في قوائم الاختيار';
                    activeLabel.style.opacity = '0.5';
                    inactiveLabel.style.opacity = '1';
                }
            }
            
            // معالجة الألوان المسبقة
            document.querySelectorAll('.preset-color').forEach(preset => {
                preset.addEventListener('click', function() {
                    const color = this.getAttribute('data-color');
                    colorInput.value = color;
                    updateColorPreview();
                });
            });
            
            // إضافة تأثير الريبل للأزرار
            document.querySelectorAll('.modern-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const ripple = this.querySelector('.btn-ripple');
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';
                    ripple.style.transform = 'scale(0)';
                    ripple.style.animation = 'none';
                    
                    setTimeout(() => {
                        ripple.style.animation = 'ripple 0.6s linear';
                    }, 10);
                });
            });
            
            // ربط الأحداث
            colorInput.addEventListener('input', updateColorPreview);
            prioritySelect.addEventListener('change', updatePriorityIndicator);
            descriptionTextarea.addEventListener('input', updateCharCounter);
            activeSwitch.addEventListener('change', updateStatusDescription);
            
            // تهيئة القيم الافتراضية
            updateColorPreview();
            updatePriorityIndicator();
            updateCharCounter();
            updateStatusDescription();
            
            // معالجة إرسال النموذج
            document.getElementById('addObservationTypeForm').onsubmit = async function(e) {
                e.preventDefault();
                
                // جمع البيانات
                const name = document.getElementById('observationTypeName').value.trim();
                const description = document.getElementById('observationTypeDescription').value.trim();
                const defaultPriority = document.getElementById('observationTypeDefaultPriority').value;
                const color = document.getElementById('observationTypeColor').value;
                const isActive = document.getElementById('observationTypeActive').checked;
                
                // التحقق من صحة البيانات
                if (!name) {
                    showAlert('يرجى إدخال اسم النوع', 'error');
                    return;
                }
                
                if (name.length < 3) {
                    showAlert('اسم النوع يجب أن يكون 3 أحرف على الأقل', 'error');
                    return;
                }
                
                try {
                    const response = await fetch('/api/admin/observation-types', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            name, 
                            description, 
                            default_priority: defaultPriority,
                            color: color,
                            is_active: isActive
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        closeModal();
                        loadObservationTypes();
                        showAlert('تم إضافة نوع الملاحظة بنجاح', 'success');
                        
                        // تسجيل النشاط
                        logActivity('add_observation_type', `Added observation type: ${name}`);
                    } else {
                        showAlert(data.error || 'حدث خطأ في إضافة النوع', 'error');
                    }
                } catch (error) {
                    console.error('خطأ في إضافة نوع الملاحظة:', error);
                    showAlert('حدث خطأ في الاتصال بالخادم', 'error');
                }
            };
        }

        function showAddCenterModal() {
            // عرض مودال إضافة مركز محسن
            showModal('إضافة مركز/محافظة جديد', `
                <div class="modern-form-container">
                    <!-- رأس النموذج -->
                    <div class="form-header">
                        <div class="form-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="form-title">
                            <h3>إضافة مركز أو محافظة جديدة</h3>
                            <p>أدخل بيانات المركز أو المحافظة الجديدة لإضافتها للنظام</p>
                        </div>
                    </div>

                    <!-- النموذج الحديث -->
                    <form id="addCenterForm" class="modern-form">
                        <!-- القسم الأول: المعلومات الأساسية -->
                        <div class="form-section">
                            <div class="section-header">
                                <i class="fas fa-info-circle"></i>
                                <span>المعلومات الأساسية</span>
                            </div>
                            
                            <div class="form-row">
                                <label class="form-label required" for="centerName">
                                    <i class="fas fa-building"></i>
                                    اسم المركز/المحافظة
                                </label>
                                <input type="text" 
                                       id="centerName" 
                                       class="modern-input" 
                                       placeholder="أدخل اسم المركز أو المحافظة"
                                       maxlength="100"
                                       required>
                                <div class="form-help">
                                    <i class="fas fa-info-circle"></i>
                                    يجب أن يكون الاسم واضحاً ومميزاً
                                </div>
                                <div class="char-counter">
                                    <span id="centerNameCounter">0</span>/100 حرف
                                </div>
                            </div>

                            <div class="form-row">
                                <label class="form-label required" for="centerType">
                                    <i class="fas fa-tags"></i>
                                    نوع الموقع
                                </label>
                                <div class="priority-selector">
                                    <div class="priority-indicator" id="centerTypeIndicator"></div>
                                    <select id="centerType" class="modern-select" required>
                                        <option value="">اختر نوع الموقع</option>
                                        <option value="center" data-color="#007bff">مركز</option>
                                        <option value="province" data-color="#28a745">محافظة</option>
                                        <option value="district" data-color="#6f42c1">حي</option>
                                        <option value="area" data-color="#fd7e14">منطقة</option>
                                    </select>
                                </div>
                                <div class="form-help">
                                    <i class="fas fa-lightbulb"></i>
                                    حدد نوع الموقع الجغرافي المناسب
                                </div>
                            </div>
                        </div>

                        <!-- القسم الثاني: الموقع والتفاصيل -->
                        <div class="form-section">
                            <div class="section-header">
                                <i class="fas fa-map"></i>
                                <span>الموقع والتفاصيل</span>
                            </div>
                            
                            <div class="form-row">
                                <label class="form-label" for="centerRegion">
                                    <i class="fas fa-globe"></i>
                                    المنطقة الإدارية
                                </label>
                                <select id="centerRegion" class="modern-select">
                                    <option value="منطقة الرياض">منطقة الرياض</option>
                                    <option value="المنطقة الشرقية">المنطقة الشرقية</option>
                                    <option value="منطقة مكة المكرمة">منطقة مكة المكرمة</option>
                                    <option value="منطقة المدينة المنورة">منطقة المدينة المنورة</option>
                                    <option value="منطقة القصيم">منطقة القصيم</option>
                                    <option value="منطقة عسير">منطقة عسير</option>
                                    <option value="منطقة تبوك">منطقة تبوك</option>
                                    <option value="منطقة حائل">منطقة حائل</option>
                                    <option value="منطقة الحدود الشمالية">منطقة الحدود الشمالية</option>
                                    <option value="منطقة جازان">منطقة جازان</option>
                                    <option value="منطقة نجران">منطقة نجران</option>
                                    <option value="منطقة الباحة">منطقة الباحة</option>
                                    <option value="منطقة الجوف">منطقة الجوف</option>
                                </select>
                                <div class="form-help">
                                    <i class="fas fa-map-marked-alt"></i>
                                    اختر المنطقة الإدارية التي يتبع لها الموقع
                                </div>
                            </div>

                            <div class="form-row">
                                <label class="form-label" for="centerParent">
                                    <i class="fas fa-sitemap"></i>
                                    المركز الرئيسي (اختياري)
                                </label>
                                <select id="centerParent" class="modern-select">
                                    <option value="">لا يوجد مركز رئيسي</option>
                                    <!-- سيتم ملؤها ديناميكياً -->
                                </select>
                                <div class="form-help">
                                    <i class="fas fa-info-circle"></i>
                                    اختر المركز الرئيسي إذا كان هذا الموقع تابعاً لمركز آخر
                                </div>
                            </div>

                            <div class="form-row">
                                <label class="form-label" for="centerDescription">
                                    <i class="fas fa-align-left"></i>
                                    وصف إضافي (اختياري)
                                </label>
                                <textarea id="centerDescription" 
                                         class="modern-textarea" 
                                         placeholder="أدخل وصفاً إضافياً للموقع (معالم مميزة، حدود جغرافية، إلخ)"
                                         maxlength="300"
                                         rows="3"></textarea>
                                <div class="char-counter">
                                    <span id="centerDescriptionCounter">0</span>/300 حرف
                                </div>
                            </div>
                        </div>

                        <!-- القسم الثالث: الإعدادات -->
                        <div class="form-section">
                            <div class="section-header">
                                <i class="fas fa-cogs"></i>
                                <span>إعدادات الموقع</span>
                            </div>
                            
                            <div class="status-toggle-container">
                                <div class="form-switch-enhanced">
                                    <label class="modern-switch">
                                        <input type="checkbox" id="centerActive" checked>
                                        <span class="modern-slider"></span>
                                    </label>
                                    <div class="switch-labels">
                                        <span class="switch-label active" id="centerActiveLabel">نشط</span>
                                        <span class="switch-label inactive" id="centerInactiveLabel">غير نشط</span>
                                    </div>
                                </div>
                                <div class="status-description" id="centerStatusDescription">
                                    الموقع متاح للاستخدام من قبل جميع الراصدين
                                </div>
                            </div>
                        </div>

                        <!-- أزرار الإجراءات -->
                        <div class="modern-actions">
                            <button type="button" class="modern-btn secondary-btn" onclick="closeModal()">
                                <i class="fas fa-times"></i>
                                إلغاء
                                <span class="btn-ripple"></span>
                            </button>
                            <button type="submit" class="modern-btn primary-btn">
                                <i class="fas fa-plus"></i>
                                إضافة الموقع
                                <span class="btn-ripple"></span>
                            </button>
                        </div>
                    </form>
                </div>
            `);
            
            // تهيئة الميزات التفاعلية للنموذج المحسن
            const centerNameInput = document.getElementById('centerName');
            const centerNameCounter = document.getElementById('centerNameCounter');
            const centerTypeSelect = document.getElementById('centerType');
            const centerTypeIndicator = document.getElementById('centerTypeIndicator');
            const centerDescriptionTextarea = document.getElementById('centerDescription');
            const centerDescriptionCounter = document.getElementById('centerDescriptionCounter');
            const centerActiveSwitch = document.getElementById('centerActive');
            const centerStatusDescription = document.getElementById('centerStatusDescription');
            const centerActiveLabel = document.getElementById('centerActiveLabel');
            const centerInactiveLabel = document.getElementById('centerInactiveLabel');
            const centerParentSelect = document.getElementById('centerParent');
            
            // تحديث عداد أحرف الاسم
            function updateCenterNameCounter() {
                const length = centerNameInput.value.length;
                centerNameCounter.textContent = length;
                
                if (length > 80) {
                    centerNameCounter.style.color = '#dc3545';
                } else if (length > 60) {
                    centerNameCounter.style.color = '#ffc107';
                } else {
                    centerNameCounter.style.color = '#64748b';
                }
            }
            
            // تحديث مؤشر نوع المركز
            function updateCenterTypeIndicator() {
                const selectedOption = centerTypeSelect.options[centerTypeSelect.selectedIndex];
                const color = selectedOption.getAttribute('data-color');
                if (color) {
                    centerTypeIndicator.style.backgroundColor = color;
                    centerTypeIndicator.style.opacity = '1';
                } else {
                    centerTypeIndicator.style.opacity = '0.3';
                }
            }
            
            // تحديث عداد أحرف الوصف
            function updateCenterDescriptionCounter() {
                const length = centerDescriptionTextarea.value.length;
                centerDescriptionCounter.textContent = length;
                
                if (length > 250) {
                    centerDescriptionCounter.style.color = '#dc3545';
                } else if (length > 200) {
                    centerDescriptionCounter.style.color = '#ffc107';
                } else {
                    centerDescriptionCounter.style.color = '#64748b';
                }
            }
            
            // تحديث وصف حالة المركز
            function updateCenterStatusDescription() {
                if (centerActiveSwitch.checked) {
                    centerStatusDescription.textContent = 'الموقع متاح للاستخدام من قبل جميع الراصدين';
                    centerActiveLabel.style.opacity = '1';
                    centerInactiveLabel.style.opacity = '0.5';
                } else {
                    centerStatusDescription.textContent = 'الموقع غير متاح مؤقتاً ولن يظهر في قوائم الاختيار';
                    centerActiveLabel.style.opacity = '0.5';
                    centerInactiveLabel.style.opacity = '1';
                }
            }
            
            // تحميل المراكز الرئيسية للاختيار
            async function loadParentCenters() {
                try {
                    const response = await fetch('/api/admin/centers');
                    if (response.ok) {
                        const data = await response.json();
                        centerParentSelect.innerHTML = '<option value="">لا يوجد مركز رئيسي</option>';
                        
                        data.centers.forEach(center => {
                            const option = document.createElement('option');
                            option.value = center.id;
                            option.textContent = center.name;
                            centerParentSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('خطأ في تحميل المراكز الرئيسية:', error);
                }
            }
            
            // إضافة تأثير الريبل للأزرار
            document.querySelectorAll('.modern-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const ripple = this.querySelector('.btn-ripple');
                    if (ripple) {
                        const rect = this.getBoundingClientRect();
                        const size = Math.max(rect.width, rect.height);
                        const x = e.clientX - rect.left - size / 2;
                        const y = e.clientY - rect.top - size / 2;
                        
                        ripple.style.width = ripple.style.height = size + 'px';
                        ripple.style.left = x + 'px';
                        ripple.style.top = y + 'px';
                        ripple.style.transform = 'scale(0)';
                        ripple.style.animation = 'none';
                        
                        setTimeout(() => {
                            ripple.style.animation = 'ripple 0.6s linear';
                        }, 10);
                    }
                });
            });
            
            // ربط الأحداث
            centerNameInput.addEventListener('input', updateCenterNameCounter);
            centerTypeSelect.addEventListener('change', updateCenterTypeIndicator);
            centerDescriptionTextarea.addEventListener('input', updateCenterDescriptionCounter);
            centerActiveSwitch.addEventListener('change', updateCenterStatusDescription);
            
            // تهيئة القيم الافتراضية
            updateCenterNameCounter();
            updateCenterTypeIndicator();
            updateCenterDescriptionCounter();
            updateCenterStatusDescription();
            loadParentCenters();
            
            // معالجة إرسال النموذج
            document.getElementById('addCenterForm').onsubmit = async function(e) {
                e.preventDefault();
                
                // جمع البيانات
                const name = centerNameInput.value.trim();
                const type = centerTypeSelect.value;
                const region = document.getElementById('centerRegion').value;
                const parentId = centerParentSelect.value || null;
                const description = centerDescriptionTextarea.value.trim();
                const isActive = centerActiveSwitch.checked;
                
                // التحقق من صحة البيانات
                if (!name) {
                    showAlert('يرجى إدخال اسم المركز أو المحافظة', 'error');
                    return;
                }
                
                if (name.length < 3) {
                    showAlert('يجب أن يكون اسم المركز 3 أحرف على الأقل', 'error');
                    return;
                }
                
                if (!type) {
                    showAlert('يرجى اختيار نوع الموقع', 'error');
                    return;
                }
                
                try {
                    const response = await fetch('/api/admin/centers', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            name, 
                            type, 
                            region,
                            parent_id: parentId,
                            description,
                            is_active: isActive
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        closeModal();
                        loadCentersTable();
                        showAlert('تم إضافة المركز بنجاح', 'success');
                        
                        // تسجيل النشاط
                        logActivity('add_center', `Added center: ${name}`);
                    } else {
                        showAlert(data.error || 'حدث خطأ في إضافة المركز', 'error');
                    }
                } catch (error) {
                    console.error('خطأ في إضافة المركز:', error);
                    showAlert('حدث خطأ في الاتصال بالخادم', 'error');
                }
            };
        }

        function editObservationType(id) {
            // البحث عن النوع المحدد
            fetch(`/api/admin/observation-types/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const type = data.type;
                        
                        // ملء النموذج بالبيانات الحالية
                        document.getElementById('editObservationTypeName').value = type.name;
                        document.getElementById('editObservationTypeDescription').value = type.description || '';
                        document.getElementById('editObservationTypeColor').value = type.color_code;
                        document.getElementById('editObservationTypeRequiresDuration').checked = type.requires_duration;
                        document.getElementById('editObservationTypeActive').checked = type.is_active;
                        
                        // حفظ ID للتحديث
                        document.getElementById('editObservationTypeForm').dataset.typeId = id;
                        
                        // عرض المودال
                        document.getElementById('editObservationTypeModal').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('خطأ في تحميل بيانات النوع:', error);
                    showNotification('خطأ في تحميل بيانات النوع', 'error');
                });
        }

        // دالة حذف نوع الملاحظة
        function deleteObservationType(id) {
            if (confirm('هل أنت متأكد من حذف هذا النوع؟ سيتم حذف جميع الملاحظات المرتبطة به.')) {
                fetch(`/api/admin/observation-types/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('تم حذف نوع الملاحظة بنجاح', 'success');
                        loadObservationTypesTable();
                        
                        // تسجيل النشاط
                        logActivity('delete_observation_type', `Deleted observation type ID: ${id}`);
                    } else {
                        showNotification(data.message || 'خطأ في حذف نوع الملاحظة', 'error');
                    }
                })
                .catch(error => {
                    console.error('خطأ في حذف نوع الملاحظة:', error);
                    showNotification('خطأ في الاتصال بالخادم', 'error');
                });
            }
        }

        function editCenter(id) {
            // البحث عن المركز المحدد
            fetch(`/api/admin/centers/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const center = data.center;
                        
                        // ملء النموذج بالبيانات الحالية
                        document.getElementById('editCenterName').value = center.name;
                        document.getElementById('editCenterType').value = center.type;
                        document.getElementById('editCenterRegion').value = center.region || '';
                        document.getElementById('editCenterActive').checked = center.is_active;
                        
                        // حفظ ID للتحديث
                        document.getElementById('editCenterForm').dataset.centerId = id;
                        
                        // عرض المودال
                        document.getElementById('editCenterModal').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('خطأ في تحميل بيانات المركز:', error);
                    showNotification('خطأ في تحميل بيانات المركز', 'error');
                });
        }

        // دالة حذف المركز
        function deleteCenter(id) {
            if (confirm('هل أنت متأكد من حذف هذا المركز؟ سيتم حذف جميع الملاحظات المرتبطة به.')) {
                fetch(`/api/admin/centers/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('تم حذف المركز بنجاح', 'success');
                        loadCentersTable();
                        
                        // تسجيل النشاط
                        logActivity('delete_center', `Deleted center ID: ${id}`);
                    } else {
                        showNotification(data.message || 'خطأ في حذف المركز', 'error');
                    }
                })
                .catch(error => {
                    console.error('خطأ في حذف المركز:', error);
                    showNotification('خطأ في الاتصال بالخادم', 'error');
                });
            }
        }

        async function loadCentersForSelect() {
            try {
                const response = await fetch('/api/admin/centers');
                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('centerId');
                    select.innerHTML = '<option value="">اختر المركز</option>';
                    
                    data.data.forEach(center => {
                        const option = document.createElement('option');
                        option.value = center.id;
                        option.textContent = center.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('خطأ في تحميل المراكز:', error);
            }
        }

        // دالة تحديث نوع الملاحظة
        async function updateObservationType(event) {
            event.preventDefault();
            
            const form = event.target;
            const typeId = form.dataset.typeId;
            
            const formData = {
                name: document.getElementById('editObservationTypeName').value,
                description: document.getElementById('editObservationTypeDescription').value,
                color_code: document.getElementById('editObservationTypeColor').value,
                requires_duration: document.getElementById('editObservationTypeRequiresDuration').checked,
                is_active: document.getElementById('editObservationTypeActive').checked
            };
            
            try {
                const response = await fetch(`/api/admin/observation-types/${typeId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('تم تحديث نوع الملاحظة بنجاح', 'success');
                    closeModal('editObservationTypeModal');
                    loadObservationTypesTable();
                } else {
                    showNotification(data.message || 'خطأ في تحديث نوع الملاحظة', 'error');
                }
            } catch (error) {
                console.error('خطأ في تحديث نوع الملاحظة:', error);
                showNotification('خطأ في الاتصال بالخادم', 'error');
            }
        }

        // دالة تحديث المركز
        async function updateCenter(event) {
            event.preventDefault();
            
            const form = event.target;
            const centerId = form.dataset.centerId;
            
            const formData = {
                name: document.getElementById('editCenterName').value,
                type: document.getElementById('editCenterType').value,
                region: document.getElementById('editCenterRegion').value,
                description: document.getElementById('editCenterDescription').value,
                is_active: document.getElementById('editCenterActive').checked
            };
            
            try {
                const response = await fetch(`/api/admin/centers/${centerId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('تم تحديث المركز بنجاح', 'success');
                    closeModal('editCenterModal');
                    loadCentersTable();
                } else {
                    showNotification(data.message || 'خطأ في تحديث المركز', 'error');
                }
            } catch (error) {
                console.error('خطأ في تحديث المركز:', error);
                showNotification('خطأ في الاتصال بالخادم', 'error');
            }
        }

        function showModal(title, content) {
            const modal = document.getElementById('generalModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            modal.style.display = 'flex';
        }

        function showNotification(message, type = 'info') {
            // إنشاء إشعار
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;
            
            switch(type) {
                case 'success':
                    notification.style.backgroundColor = '#10b981';
                    break;
                case 'error':
                    notification.style.backgroundColor = '#ef4444';
                    break;
                case 'warning':
                    notification.style.backgroundColor = '#f59e0b';
                    break;
                default:
                    notification.style.backgroundColor = '#06b6d4';
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

         function deactivateAssistant() {
            // إلغاء تفعيل مساعد الرصد
            showNotification('تم إلغاء تفعيل مساعد الرصد', 'info');
        }

        // دوال إدارة المستخدمين
        function showAddUserModal() {
            showModal('إضافة مستخدم جديد', `
                <div class="modern-form-container">
                    <!-- رأس النموذج -->
                    <div class="form-header">
                        <div class="form-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="form-title">
                            <h3>إضافة مستخدم جديد للنظام</h3>
                            <p>أدخل بيانات المستخدم الجديد لإنشاء حساب في منصة الرصد التعاوني</p>
                        </div>
                    </div>

                    <!-- النموذج الحديث -->
                    <form id="addUserForm" class="modern-form">
                        <!-- القسم الأول: المعلومات الشخصية -->
                        <div class="form-section">
                            <div class="section-header">
                                <i class="fas fa-id-card"></i>
                                <span>المعلومات الشخصية</span>
                            </div>
                            
                            <div class="form-row">
                                <label class="form-label required" for="userFullName">
                                    <i class="fas fa-user"></i>
                                    الاسم الكامل
                                </label>
                                <input type="text" 
                                       id="userFullName" 
                                       class="modern-input" 
                                       placeholder="أدخل الاسم الكامل"
                                       maxlength="100"
                                       required>
                                <div class="form-help">
                                    <i class="fas fa-info-circle"></i>
                                    يجب إدخال الاسم الكامل كما هو في الهوية الوطنية
                                </div>
                                <div class="char-counter">
                                    <span id="userNameCounter">0</span>/100 حرف
                                </div>
                            </div>

                            <div class="form-row">
                                <label class="form-label required" for="userRank">
                                    <i class="fas fa-star"></i>
                                    الرتبة
                                </label>
                                <select id="userRank" class="modern-select" required>
                                    <option value="">اختر الرتبة</option>
                                    <option value="عقيد">عقيد</option>
                                    <option value="مقدم">مقدم</option>
                                    <option value="رائد">رائد</option>
                                    <option value="نقيب">نقيب</option>
                                    <option value="ملازم أول">ملازم أول</option>
                                    <option value="ملازم">ملازم</option>
                                    <option value="رقيب أول">رقيب أول</option>
                                    <option value="رقيب">رقيب</option>
                                    <option value="عريف">عريف</option>
                                    <option value="جندي أول">جندي أول</option>
                                    <option value="جندي">جندي</option>
                                    <option value="مدني">مدني</option>
                                </select>
                                <div class="form-help">
                                    <i class="fas fa-medal"></i>
                                    اختر الرتبة العسكرية أو مدني للموظفين المدنيين
                                </div>
                            </div>

                            <div class="form-row">
                                <label class="form-label required" for="userNationalId">
                                    <i class="fas fa-id-badge"></i>
                                    رقم الهوية الوطنية
                                </label>
                                <input type="text" 
                                       id="userNationalId" 
                                       class="modern-input" 
                                       placeholder="أدخل رقم الهوية (10 أرقام)"
                                       maxlength="10"
                                       pattern="[0-9]{10}"
                                       required>
                                <div class="form-help">
                                    <i class="fas fa-shield-alt"></i>
                                    رقم الهوية يجب أن يكون 10 أرقام بدون مسافات
                                </div>
                                <div class="validation-message" id="nationalIdValidation"></div>
                            </div>

                            <div class="form-row">
                                <label class="form-label required" for="userPhone">
                                    <i class="fas fa-mobile-alt"></i>
                                    رقم الجوال
                                </label>
                                <input type="tel" 
                                       id="userPhone" 
                                       class="modern-input" 
                                       placeholder="05xxxxxxxx"
                                       maxlength="10"
                                       pattern="05[0-9]{8}"
                                       required>
                                <div class="form-help">
                                    <i class="fas fa-phone"></i>
                                    رقم الجوال يجب أن يبدأ بـ 05 ويتكون من 10 أرقام
                                </div>
                                <div class="validation-message" id="phoneValidation"></div>
                            </div>
                        </div>

                        <!-- القسم الثاني: معلومات الحساب -->
                        <div class="form-section">
                            <div class="section-header">
                                <i class="fas fa-user-cog"></i>
                                <span>معلومات الحساب</span>
                            </div>
                            
                            <div class="form-row">
                                <label class="form-label required" for="userRole">
                                    <i class="fas fa-user-tag"></i>
                                    الدور في النظام
                                </label>
                                <div class="role-selector">
                                    <div class="role-indicator" id="roleIndicator"></div>
                                    <select id="userRole" class="modern-select" required onchange="toggleShiftField()">
                                        <option value="">اختر الدور</option>
                                        <option value="supervisor" data-color="#dc3545">مشرف</option>
                                        <option value="monitor" data-color="#28a745">راصد</option>
                                    </select>
                                </div>
                                <div class="form-help">
                                    <i class="fas fa-info-circle"></i>
                                    المشرف له صلاحيات كاملة، الراصد يمكنه إضافة الملاحظات فقط
                                </div>
                            </div>

                            <div class="form-row" id="shiftGroup" style="display: none;">
                                <label class="form-label" for="userShift">
                                    <i class="fas fa-clock"></i>
                                    الوردية
                                </label>
                                <select id="userShift" class="modern-select">
                                    <option value="">اختر الوردية</option>
                                    <option value="صباحية">الوردية الصباحية (6:00 ص - 2:00 م)</option>
                                    <option value="مسائية">الوردية المسائية (2:00 م - 10:00 م)</option>
                                    <option value="ليلية">الوردية الليلية (10:00 م - 6:00 ص)</option>
                                    <option value="24 ساعة">24 ساعة (مناوبة كاملة)</option>
                                </select>
                                <div class="form-help">
                                    <i class="fas fa-calendar-alt"></i>
                                    الوردية مطلوبة للراصدين فقط
                                </div>
                            </div>

                            <div class="form-row">
                                <label class="form-label" for="userCenter">
                                    <i class="fas fa-map-marker-alt"></i>
                                    المركز/المحافظة
                                </label>
                                <select id="userCenter" class="modern-select">
                                    <option value="">اختر المركز أو المحافظة</option>
                                    <!-- سيتم ملؤها ديناميكياً -->
                                </select>
                                <div class="form-help">
                                    <i class="fas fa-building"></i>
                                    اختر المركز أو المحافظة التي يتبع لها المستخدم
                                </div>
                            </div>
                        </div>

                        <!-- القسم الثالث: كلمة المرور -->
                        <div class="form-section">
                            <div class="section-header">
                                <i class="fas fa-lock"></i>
                                <span>كلمة المرور</span>
                            </div>
                            
                            <div class="form-row">
                                <label class="form-label required" for="userPassword">
                                    <i class="fas fa-key"></i>
                                    كلمة المرور
                                </label>
                                <div class="password-input-container">
                                    <input type="password" 
                                           id="userPassword" 
                                           class="modern-input" 
                                           placeholder="أدخل كلمة مرور قوية"
                                           minlength="8"
                                           required>
                                    <button type="button" class="password-toggle" onclick="togglePassword('userPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="password-strength" id="passwordStrength">
                                    <div class="strength-bar">
                                        <div class="strength-fill" id="strengthFill"></div>
                                    </div>
                                    <span class="strength-text" id="strengthText">أدخل كلمة المرور</span>
                                </div>
                                <div class="form-help">
                                    <i class="fas fa-shield-alt"></i>
                                    يجب أن تحتوي على 8 أحرف على الأقل مع أرقام وحروف
                                </div>
                            </div>

                            <div class="form-row">
                                <label class="form-label required" for="userPasswordConfirm">
                                    <i class="fas fa-check-double"></i>
                                    تأكيد كلمة المرور
                                </label>
                                <div class="password-input-container">
                                    <input type="password" 
                                           id="userPasswordConfirm" 
                                           class="modern-input" 
                                           placeholder="أعد إدخال كلمة المرور"
                                           required>
                                    <button type="button" class="password-toggle" onclick="togglePassword('userPasswordConfirm')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="validation-message" id="passwordMatchValidation"></div>
                            </div>
                        </div>

                        <!-- القسم الرابع: الإعدادات -->
                        <div class="form-section">
                            <div class="section-header">
                                <i class="fas fa-cogs"></i>
                                <span>إعدادات الحساب</span>
                            </div>
                            
                            <div class="status-toggle-container">
                                <div class="form-switch-enhanced">
                                    <label class="modern-switch">
                                        <input type="checkbox" id="userActive" checked>
                                        <span class="modern-slider"></span>
                                    </label>
                                    <div class="switch-labels">
                                        <span class="switch-label active" id="userActiveLabel">نشط</span>
                                        <span class="switch-label inactive" id="userInactiveLabel">غير نشط</span>
                                    </div>
                                </div>
                                <div class="status-description" id="userStatusDescription">
                                    الحساب نشط ويمكن للمستخدم تسجيل الدخول
                                </div>
                            </div>

                            <div class="notification-settings">
                                <label class="option-item">
                                    <input type="checkbox" id="sendWelcomeEmail" checked>
                                    <span class="checkmark"></span>
                                    <div class="option-text">
                                        <strong>إرسال رسالة ترحيب</strong>
                                        <small>إرسال بيانات الحساب عبر الجوال</small>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- أزرار الإجراءات -->
                        <div class="modern-actions">
                            <button type="button" class="modern-btn secondary-btn" onclick="closeModal()">
                                <i class="fas fa-times"></i>
                                إلغاء
                                <span class="btn-ripple"></span>
                            </button>
                            <button type="submit" class="modern-btn primary-btn">
                                <i class="fas fa-user-plus"></i>
                                إنشاء الحساب
                                <span class="btn-ripple"></span>
                            </button>
                        </div>
                    </form>
                </div>
            `);
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">إضافة المستخدم</button>
                        <button type="button" class="btn btn-outline" onclick="closeModal()">إلغاء</button>
                    </div>
                </form>
            `);
            
            loadShiftsForSelect();
            
            document.getElementById('addUserForm').onsubmit = async function(e) {
                e.preventDefault();
                
                const formData = {
                    full_name: document.getElementById('userFullName').value,
                    rank: document.getElementById('userRank').value,
                    national_id: document.getElementById('userNationalId').value,
                    phone_number: document.getElementById('userPhone').value,
                    role: document.getElementById('userRole').value,
                    shift_id: document.getElementById('userShift').value || null
                };
                
                try {
                    const response = await fetch('/api/admin/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        closeModal();
                        loadUsers();
                        showNotification(`تم إنشاء المستخدم بنجاح. كلمة المرور المؤقتة: ${result.temp_password}`, 'success');
                    } else {
                        const error = await response.json();
                        showNotification(error.error || 'حدث خطأ في الإضافة', 'error');
                    }
                } catch (error) {
                    showNotification('حدث خطأ في الاتصال', 'error');
                }
            };
        }

        function toggleShiftField() {
            const role = document.getElementById('userRole').value;
            const shiftGroup = document.getElementById('shiftGroup');
            if (role === 'monitor') {
                shiftGroup.style.display = 'block';
                document.getElementById('userShift').required = true;
            } else {
                shiftGroup.style.display = 'none';
                document.getElementById('userShift').required = false;
            }
        }

        async function loadShiftsForSelect() {
            try {
                const response = await fetch('/api/admin/shifts');
                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('userShift');
                    if (select) {
                        select.innerHTML = '<option value="">اختر الوردية</option>';
                        data.shifts.forEach(shift => {
                            const option = document.createElement('option');
                            option.value = shift.id;
                            option.textContent = shift.name;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('خطأ في تحميل الورديات:', error);
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                if (response.ok) {
                    const data = await response.json();
                    displayUsersTable(data.users);
                    updateUsersStats(data.users);
                }
            } catch (error) {
                console.error('خطأ في تحميل المستخدمين:', error);
            }
        }

        function displayUsersTable(users) {
            const tableContainer = document.getElementById('usersTable');
            if (!tableContainer) return;

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>الرتبة</th>
                            <th>رقم الهوية</th>
                            <th>الدور</th>
                            <th>الوردية</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            users.forEach(user => {
                html += `
                    <tr>
                        <td>${user.full_name}</td>
                        <td>${user.rank}</td>
                        <td>${user.national_id}</td>
                        <td>${user.role === 'supervisor' ? 'مشرف' : 'راصد'}</td>
                        <td>${user.shift_name || '-'}</td>
                        <td>
                            <span class="status-badge ${user.is_active ? 'active' : 'inactive'}">
                                ${user.is_active ? 'نشط' : 'غير نشط'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="editUser(${user.id})" title="تعديل بيانات المستخدم">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="resetUserPassword(${user.id})" title="إعادة تعيين كلمة المرور">
                                <i class="fas fa-key"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            tableContainer.innerHTML = html;
        }

        function updateUsersStats(users) {
            const statsContainer = document.getElementById('usersStats');
            if (!statsContainer) return;

            const totalUsers = users.length;
            const supervisors = users.filter(u => u.role === 'supervisor').length;
            const monitors = users.filter(u => u.role === 'monitor').length;
            const activeUsers = users.filter(u => u.is_active).length;

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">${totalUsers}</div>
                        <div class="stat-label">إجمالي المستخدمين</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">${supervisors}</div>
                        <div class="stat-label">المشرفين</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">${monitors}</div>
                        <div class="stat-label">الراصدين</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">${activeUsers}</div>
                        <div class="stat-label">المستخدمين النشطين</div>
                    </div>
                </div>
            `;
        }

        function filterUsers() {
            loadUsers();
        }

        function exportUsers() {
            console.log('تصدير المستخدمين');
        }

        function editUser(id) {
            console.log('تعديل المستخدم:', id);
        }

        async function resetUserPassword(id) {
            if (confirm('هل أنت متأكد من إعادة تعيين كلمة المرور؟')) {
                try {
                    const response = await fetch(`/api/admin/users/${id}/reset-password`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        showNotification(`تم إعادة تعيين كلمة المرور. كلمة المرور الجديدة: ${result.new_password}`, 'success');
                    } else {
                        showNotification('حدث خطأ في إعادة تعيين كلمة المرور', 'error');
                    }
                } catch (error) {
                    showNotification('حدث خطأ في الاتصال', 'error');
                }
            }
        }

        // دوال إدارة الورديات
        function showAddShiftModal() {
            showModal('إضافة وردية جديدة', `
                <form id="addShiftForm">
                    <div class="form-group">
                        <label>اسم الوردية:</label>
                        <input type="text" id="shiftName" required>
                    </div>
                    <div class="form-group">
                        <label>وقت البداية:</label>
                        <input type="time" id="shiftStartTime" required>
                    </div>
                    <div class="form-group">
                        <label>وقت النهاية:</label>
                        <input type="time" id="shiftEndTime" required>
                    </div>
                    <div class="form-group">
                        <label>الوصف:</label>
                        <textarea id="shiftDescription"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">إضافة الوردية</button>
                        <button type="button" class="btn btn-outline" onclick="closeModal()">إلغاء</button>
                    </div>
                </form>
            `);
            
            document.getElementById('addShiftForm').onsubmit = async function(e) {
                e.preventDefault();
                
                const formData = {
                    name: document.getElementById('shiftName').value,
                    start_time: document.getElementById('shiftStartTime').value,
                    end_time: document.getElementById('shiftEndTime').value,
                    description: document.getElementById('shiftDescription').value
                };
                
                try {
                    const response = await fetch('/api/admin/shifts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    
                    if (response.ok) {
                        closeModal();
                        loadShifts();
                        showNotification('تم إضافة الوردية بنجاح', 'success');
                    } else {
                        const error = await response.json();
                        showNotification(error.error || 'حدث خطأ في الإضافة', 'error');
                    }
                } catch (error) {
                    showNotification('حدث خطأ في الاتصال', 'error');
                }
            };
        }

        async function loadShifts() {
            try {
                const response = await fetch('/api/admin/shifts');
                if (response.ok) {
                    const data = await response.json();
                    displayShiftsTable(data.shifts);
                    updateShiftsStats(data.shifts);
                }
            } catch (error) {
                console.error('خطأ في تحميل الورديات:', error);
            }
        }

        function displayShiftsTable(shifts) {
            const tableContainer = document.getElementById('shiftsTable');
            if (!tableContainer) return;

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>اسم الوردية</th>
                            <th>وقت البداية</th>
                            <th>وقت النهاية</th>
                            <th>عدد الراصدين</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            shifts.forEach(shift => {
                html += `
                    <tr>
                        <td>${shift.name}</td>
                        <td>${shift.start_time}</td>
                        <td>${shift.end_time}</td>
                        <td>${shift.monitors_count || 0}</td>
                        <td>
                            <span class="status-badge ${shift.is_active ? 'active' : 'inactive'}">
                                ${shift.is_active ? 'نشطة' : 'غير نشطة'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="editShift(${shift.id})" title="تعديل بيانات الوردية">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            tableContainer.innerHTML = html;
        }

        function updateShiftsStats(shifts) {
            const statsContainer = document.getElementById('shiftsStats');
            if (!statsContainer) return;

            const totalShifts = shifts.length;
            const activeShifts = shifts.filter(s => s.is_active).length;
            const totalMonitors = shifts.reduce((sum, s) => sum + (s.monitors_count || 0), 0);

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">${totalShifts}</div>
                        <div class="stat-label">إجمالي الورديات</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-play-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">${activeShifts}</div>
                        <div class="stat-label">الورديات النشطة</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">${totalMonitors}</div>
                        <div class="stat-label">إجمالي الراصدين</div>
                    </div>
                </div>
            `;
        }

        function generateShiftSchedule() {
            console.log('إنشاء جدول أسبوعي');
        }

        function loadAttendance() {
            console.log('تحميل الحضور');
        }

        function markAllPresent() {
            console.log('تسجيل حضور الجميع');
        }

        function editShift(id) {
            console.log('تعديل الوردية:', id);
        }

        // دوال نظام التنبيهات والمهام
        function showNotificationTab(tabName) {
            // إخفاء جميع التبويبات
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // عرض التبويب المحدد
            document.getElementById(tabName + 'Notifications').classList.add('active');
            event.target.classList.add('active');
        }

        async function loadNotificationsData() {
            try {
                // تحميل جميع التنبيهات
                const response = await fetch('/api/notifications');
                const data = await response.json();
                
                if (data.success) {
                    updateNotificationsList(data.notifications);
                    updateTasksList(data.tasks || []);
                    updateAlertsList(data.alerts || []);
                }
            } catch (error) {
                console.error('خطأ في تحميل التنبيهات:', error);
            }
        }

        function updateNotificationsList(notifications) {
            const container = document.getElementById('notificationsList');
            if (!container) return;
            
            if (notifications.length === 0) {
                container.innerHTML = '<div class="empty-state">لا توجد تنبيهات</div>';
                return;
            }
            
            container.innerHTML = notifications.map(notification => `
                <div class="notification-item ${notification.is_read ? '' : 'unread'}" data-id="${notification.id}">
                    <div class="notification-icon">
                        <i class="fas ${getNotificationIcon(notification.type)}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${formatHijriDateTime(notification.created_at)}</div>
                    </div>
                    <div class="notification-actions">
                        ${!notification.is_read ? `
                            <button class="btn btn-outline btn-sm" onclick="markAsRead(${notification.id})">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-outline btn-sm" onclick="deleteNotification(${notification.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // تحديث قائمة المهام
        function updateTasksList(tasks) {
            const container = document.getElementById('tasksList');
            if (!container) return;
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state">لا توجد مهام</div>';
                return;
            }
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            container.innerHTML = tasks.map(task => `
                <div class="task-item ${task.status}" data-id="${task.id}">
                    <div class="task-header">
                        <div class="task-title">${task.title}</div>
                        <div class="task-meta">
                            <span class="task-priority priority-${task.priority}">${getPriorityText(task.priority)}</span>
                            <span class="task-type">${task.target_type === 'general' ? 'عام' : 'شخصي'}</span>
                        </div>
                    </div>
                    
                    <div class="task-content">
                        <p class="task-description">${task.description || ''}</p>
                        ${task.due_date ? `<div class="task-due-date">تاريخ الاستحقاق: ${formatHijriDate(task.due_date)}</div>` : ''}
                        <div class="task-creator">من: ${task.creator_name}</div>
                    </div>
                    
                    <div class="task-status">
                        <span class="status-badge status-${task.status}">${getStatusText(task.status)}</span>
                        <span class="task-time">${formatHijriDateTime(task.created_at)}</span>
                    </div>
                    
                    ${task.reply ? `
                        <div class="task-reply">
                            <strong>الرد:</strong> ${task.reply}
                            <small>(${formatHijriDateTime(task.reply_date)})</small>
                        </div>
                    ` : ''}
                    
                    <div class="task-actions">
                        ${task.can_reply && task.target_type === 'specific' && task.target_user_id === currentUser.national_id && !task.reply ? `
                            <button class="btn btn-primary btn-sm" onclick="showTaskReplyModal(${task.id}, '${task.title}')">
                                <i class="fas fa-reply"></i>
                                رد على المهمة
                            </button>
                        ` : ''}
                        ${task.status === 'pending' && task.can_reply ? `
                            <button class="btn btn-success btn-sm" onclick="updateTaskStatus(${task.id}, 'in_progress')">
                                <i class="fas fa-play"></i>
                                بدء العمل
                            </button>
                        ` : ''}
                        ${task.status === 'in_progress' && task.can_reply ? `
                            <button class="btn btn-success btn-sm" onclick="updateTaskStatus(${task.id}, 'completed')">
                                <i class="fas fa-check"></i>
                                إكمال المهمة
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // دوال مساعدة للمهام
        function getPriorityText(priority) {
            const priorities = {
                'low': 'منخفضة',
                'medium': 'متوسطة', 
                'high': 'عالية',
                'urgent': 'عاجلة'
            };
            return priorities[priority] || priority;
        }

        function getStatusText(status) {
            const statuses = {
                'pending': 'في الانتظار',
                'in_progress': 'قيد التنفيذ',
                'completed': 'مكتملة',
                'cancelled': 'ملغية'
            };
            return statuses[status] || status;
        }

        // عرض مودال الرد على المهمة
        function showTaskReplyModal(taskId, taskTitle) {
            const modalHtml = `
                <form onsubmit="replyToTask(event, ${taskId})">
                    <div class="form-group">
                        <label class="form-label">الرد على المهمة: ${taskTitle}</label>
                        <textarea id="taskReply" class="form-textarea" rows="4" placeholder="اكتب ردك على المهمة..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">حالة المهمة</label>
                        <select id="taskStatus" class="form-select" required>
                            <option value="in_progress">قيد التنفيذ</option>
                            <option value="completed">مكتملة</option>
                            <option value="cancelled">تعذر التنفيذ</option>
                        </select>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline" onclick="closeModal()" title="إغلاق النافذة بدون حفظ">إلغاء</button>
                        <button type="submit" class="btn btn-primary" title="إرسال الرد على المهمة">
                            <i class="fas fa-paper-plane"></i>
                            إرسال الرد
                        </button>
                    </div>
                </form>
            `;
            
            showModal('الرد على المهمة', modalHtml);
        }

        // إرسال رد على المهمة
        async function replyToTask(event, taskId) {
            event.preventDefault();
            
            const formData = {
                reply: document.getElementById('taskReply').value,
                status: document.getElementById('taskStatus').value
            };
            
            try {
                const response = await fetch(`/api/tasks/${taskId}/reply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('تم إرسال الرد بنجاح', 'success');
                    closeModal();
                    loadNotificationsData();
                } else {
                    showNotification(data.message || 'خطأ في إرسال الرد', 'error');
                }
            } catch (error) {
                console.error('خطأ في إرسال الرد:', error);
                showNotification('خطأ في الاتصال بالخادم', 'error');
            }
        }

        // تحديث حالة المهمة
        async function updateTaskStatus(taskId, status) {
            try {
                const response = await fetch(`/api/tasks/${taskId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('تم تحديث حالة المهمة بنجاح', 'success');
                    loadNotificationsData();
                } else {
                    showNotification(data.message || 'خطأ في تحديث حالة المهمة', 'error');
                }
            } catch (error) {
                console.error('خطأ في تحديث حالة المهمة:', error);
                showNotification('خطأ في الاتصال بالخادم', 'error');
            }
        }

        // دوال مساعدة
        function getNotificationIcon(type) {
            const icons = {
                'info': 'fa-info-circle',
                'warning': 'fa-exclamation-triangle',
                'error': 'fa-times-circle',
                'success': 'fa-check-circle',
                'task': 'fa-tasks'
            };
            return icons[type] || 'fa-bell';
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'الآن';
            if (diff < 3600000) return Math.floor(diff / 60000) + ' دقيقة';
            if (diff < 86400000) return Math.floor(diff / 3600000) + ' ساعة';
            return Math.floor(diff / 86400000) + ' يوم';
        }

        // دوال الإجراءات
        async function markAsRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/read`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    loadNotificationsData();
                    updateNotificationCount();
                }
            } catch (error) {
                console.error('خطأ في تحديد التنبيه كمقروء:', error);
            }
        }

        async function markAllAsRead() {
            try {
                const response = await fetch('/api/notifications/mark-all-read', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    loadNotificationsData();
                    updateNotificationCount();
                    showNotification('تم تحديد جميع التنبيهات كمقروءة', 'success');
                }
            } catch (error) {
                console.error('خطأ في تحديد جميع التنبيهات كمقروءة:', error);
            }
        }

        function showAddTaskModal() {
            const taskModalHtml = `
                <form onsubmit="addTask(event)">
                    <div class="form-group">
                        <label class="form-label">عنوان المهمة</label>
                        <input type="text" id="taskTitle" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">الوصف</label>
                        <textarea id="taskDescription" class="form-textarea" rows="3"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">نوع الاستهداف</label>
                            <select id="taskTargetType" class="form-select" onchange="toggleTargetInput()">
                                <option value="general">عام - لجميع المستخدمين</option>
                                <option value="specific">محدد - لشخص معين</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="targetUserGroup" style="display: none;">
                            <label class="form-label">رقم هوية المستخدم المستهدف</label>
                            <input type="text" id="targetUserId" class="form-input" placeholder="أدخل رقم الهوية">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">الأولوية</label>
                            <select id="taskPriority" class="form-select">
                                <option value="low">منخفضة</option>
                                <option value="medium" selected>متوسطة</option>
                                <option value="high">عالية</option>
                                <option value="urgent">عاجلة</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">تاريخ الاستحقاق (هجري)</label>
                            <input type="text" id="taskDueDate" class="form-input" placeholder="مثال: 1446/02/15">
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline" onclick="closeModal()" title="إغلاق النافذة بدون حفظ">إلغاء</button>
                        <button type="submit" class="btn btn-primary" title="إضافة المهمة الجديدة">
                            <i class="fas fa-plus"></i>
                            إضافة المهمة
                        </button>
                    </div>
                </form>
            `;
            
            showModal('إضافة مهمة جديدة', taskModalHtml);
        }

        function toggleTargetInput() {
            const targetType = document.getElementById('taskTargetType').value;
            const targetUserGroup = document.getElementById('targetUserGroup');
            
            if (targetType === 'specific') {
                targetUserGroup.style.display = 'block';
                document.getElementById('targetUserId').required = true;
            } else {
                targetUserGroup.style.display = 'none';
                document.getElementById('targetUserId').required = false;
                document.getElementById('targetUserId').value = '';
            }
        }

        async function addTask(event) {
            event.preventDefault();
            
            const targetType = document.getElementById('taskTargetType').value;
            const formData = {
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                priority: document.getElementById('taskPriority').value,
                due_date: document.getElementById('taskDueDate').value,
                target_type: targetType,
                target_user_id: targetType === 'specific' ? document.getElementById('targetUserId').value : null
            };
            
            try {
                const response = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const targetMsg = targetType === 'general' ? 'لجميع المستخدمين' : `للمستخدم: ${formData.target_user_id}`;
                    showNotification(`تم إضافة المهمة بنجاح ${targetMsg}`, 'success');
                    closeModal();
                    loadNotificationsData();
                } else {
                    showNotification(data.message || 'خطأ في إضافة المهمة', 'error');
                }
            } catch (error) {
                console.error('خطأ في إضافة المهمة:', error);
                showNotification('خطأ في الاتصال بالخادم', 'error');
            }
        }
        
        // التحقق من صلاحيات المشرف
        function isSupervisor() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            return currentUser.role === 'supervisor';
        }
        
        // عرض مودال ملاحظة المشرف
        function showSupervisorNoteModal(observationId, observerName) {
            const modalHtml = `
                <form onsubmit="sendSupervisorNote(event, ${observationId})">
                    <div class="form-group">
                        <label class="form-label">ملاحظة للراصد: ${observerName}</label>
                        <textarea id="supervisorNote" class="form-textarea" rows="4" placeholder="اكتب ملاحظتك هنا..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">نوع الملاحظة</label>
                        <select id="noteType" class="form-select">
                            <option value="correction">تصحيح</option>
                            <option value="improvement">تحسين</option>
                            <option value="warning">تحذير</option>
                            <option value="appreciation">تقدير</option>
                        </select>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline" onclick="closeModal()" title="إغلاق النافذة بدون إرسال">إلغاء</button>
                        <button type="submit" class="btn btn-warning" title="إرسال الملاحظة للراصد">
                            <i class="fas fa-paper-plane"></i>
                            إرسال الملاحظة
                        </button>
                    </div>
                </form>
            `;
            
            showModal('ملاحظة المشرف', modalHtml);
        }
        
        // إرسال ملاحظة المشرف
        async function sendSupervisorNote(event, observationId) {
            event.preventDefault();
            
            const formData = {
                observation_id: observationId,
                note: document.getElementById('supervisorNote').value,
                note_type: document.getElementById('noteType').value
            };
            
            try {
                const response = await fetch('/api/observations/supervisor-note', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('تم إرسال الملاحظة للراصد بنجاح', 'success');
                    closeModal();
                } else {
                    showNotification(data.message || 'خطأ في إرسال الملاحظة', 'error');
                }
            } catch (error) {
                console.error('خطأ في إرسال الملاحظة:', error);
                showNotification('خطأ في الاتصال بالخادم', 'error');
            }
        }
        
        function closeModal() {
            document.getElementById('generalModal').style.display = 'none';
        }

        // ===== دوال التحويل للتقويم الهجري =====
        
        // تحويل التاريخ الميلادي إلى هجري
        function toHijri(gregorianDate) {
            if (!gregorianDate) return '';
            
            try {
                const hijriDate = moment(gregorianDate).format('iYYYY/iMM/iDD');
                const hijriMonths = [
                    'محرم', 'صفر', 'ربيع الأول', 'ربيع الثاني', 'جمادى الأولى', 'جمادى الثانية',
                    'رجب', 'شعبان', 'رمضان', 'شوال', 'ذو القعدة', 'ذو الحجة'
                ];
                
                const parts = hijriDate.split('/');
                const year = parts[0];
                const month = hijriMonths[parseInt(parts[1]) - 1];
                const day = parts[2];
                
                return `${day} ${month} ${year}هـ`;
            } catch (error) {
                console.error('خطأ في تحويل التاريخ:', error);
                return gregorianDate;
            }
        }
        
        // تحويل التاريخ الهجري إلى ميلادي
        function toGregorian(hijriDate) {
            if (!hijriDate) return '';
            
            try {
                // إذا كان التاريخ بصيغة YYYY/MM/DD
                if (hijriDate.includes('/')) {
                    const gregorianDate = moment(hijriDate, 'iYYYY/iMM/iDD').format('YYYY-MM-DD');
                    return gregorianDate;
                }
                return hijriDate;
            } catch (error) {
                console.error('خطأ في تحويل التاريخ:', error);
                return hijriDate;
            }
        }
        
        // تنسيق التاريخ الهجري للعرض
        function formatHijriDate(date) {
            if (!date) return '';
            
            try {
                const hijriDate = moment(date).format('iYYYY/iMM/iDD');
                const hijriMonths = [
                    'محرم', 'صفر', 'ربيع الأول', 'ربيع الثاني', 'جمادى الأولى', 'جمادى الثانية',
                    'رجب', 'شعبان', 'رمضان', 'شوال', 'ذو القعدة', 'ذو الحجة'
                ];
                
                const parts = hijriDate.split('/');
                const year = parts[0];
                const month = hijriMonths[parseInt(parts[1]) - 1];
                const day = parts[2];
                
                return `${day} ${month} ${year}هـ`;
            } catch (error) {
                console.error('خطأ في تنسيق التاريخ:', error);
                return date;
            }
        }
        
        // تنسيق التاريخ والوقت الهجري
        function formatHijriDateTime(datetime) {
            if (!datetime) return '';
            
            try {
                const date = moment(datetime);
                const hijriDate = date.format('iYYYY/iMM/iDD');
                const time = date.format('HH:mm');
                
                const hijriMonths = [
                    'محرم', 'صفر', 'ربيع الأول', 'ربيع الثاني', 'جمادى الأولى', 'جمادى الثانية',
                    'رجب', 'شعبان', 'رمضان', 'شوال', 'ذو القعدة', 'ذو الحجة'
                ];
                
                const parts = hijriDate.split('/');
                const year = parts[0];
                const month = hijriMonths[parseInt(parts[1]) - 1];
                const day = parts[2];
                
                return `${day} ${month} ${year}هـ - ${time}`;
            } catch (error) {
                console.error('خطأ في تنسيق التاريخ والوقت:', error);
                return datetime;
            }
        }
        
        // الحصول على التاريخ الهجري الحالي
        function getCurrentHijriDate() {
            return moment().format('iYYYY/iMM/iDD');
        }
        
        // تحويل جميع التواريخ في الصفحة إلى هجري
        function convertAllDatesToHijri() {
            // تحويل التواريخ في الجداول
            document.querySelectorAll('.date-cell, .datetime-cell').forEach(cell => {
                const originalDate = cell.textContent.trim();
                if (originalDate && originalDate !== '-') {
                    cell.textContent = formatHijriDate(originalDate);
                }
            });
            
            // تحويل التواريخ في الإحصائيات
            document.querySelectorAll('.stat-date').forEach(element => {
                const originalDate = element.textContent.trim();
                if (originalDate && originalDate !== '-') {
                    element.textContent = formatHijriDate(originalDate);
                }
            });
        }
        
        // تحديث حقول التاريخ لتدعم الهجري
        function updateDateInputsForHijri() {
            // تحديث حقول التاريخ في الفلاتر
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                input.setAttribute('placeholder', 'مثال: 1446/02/15');
                input.setAttribute('title', 'أدخل التاريخ بالتقويم الهجري (سنة/شهر/يوم)');
            });
            
            // تحديث حقول التاريخ والوقت
            const datetimeInputs = document.querySelectorAll('input[type="datetime-local"]');
            datetimeInputs.forEach(input => {
                input.setAttribute('placeholder', 'مثال: 1446/02/15 14:30');
                input.setAttribute('title', 'أدخل التاريخ والوقت بالتقويم الهجري');
            });
        }

        // متغيرات الخريطة
        let riyadhMap = null;
        let mapMarkers = [];
        let mapObservations = [];

        // تحميل صفحة الخريطة
        async function loadMapPage() {
            try {
                // تحميل البيانات الأساسية
                await loadMapFilters();
                
                // إنشاء الخريطة إذا لم تكن موجودة
                if (!riyadhMap) {
                    initializeMap();
                }
                
                // تحميل بيانات الملاحظات
                await updateMapData();
                
            } catch (error) {
                console.error('خطأ في تحميل صفحة الخريطة:', error);
                showNotification('خطأ في تحميل صفحة الخريطة', 'error');
            }
        }

        // إنشاء الخريطة
        function initializeMap() {
            // إحداثيات مدينة الرياض
            const riyadhCenter = [24.7136, 46.6753];
            
            // إنشاء الخريطة
            riyadhMap = L.map('riyadhMap').setView(riyadhCenter, 11);
            
            // إضافة طبقة الخريطة
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(riyadhMap);
            
            // إضافة حدود مدينة الرياض (تقريبية)
            const riyadhBounds = [
                [24.4, 46.3],  // الجنوب الغربي
                [25.0, 47.0]   // الشمال الشرقي
            ];
            
            // تحديد حدود الخريطة
            riyadhMap.setMaxBounds(riyadhBounds);
            riyadhMap.on('drag', function() {
                riyadhMap.panInsideBounds(riyadhBounds, { animate: false });
            });
        }

        // تحميل فلاتر الخريطة
        async function loadMapFilters() {
            try {
                // تحميل أنواع الملاحظات
                const typesResponse = await fetch('/api/admin/observation-types');
                const typesData = await typesResponse.json();
                
                if (typesData.success) {
                    const typeSelect = document.getElementById('mapObservationType');
                    typeSelect.innerHTML = '<option value="">جميع الأنواع</option>';
                    typesData.types.forEach(type => {
                        typeSelect.innerHTML += `<option value="${type.id}">${type.name}</option>`;
                    });
                }
                
                // تحميل المراكز
                const centersResponse = await fetch('/api/centers');
                const centersData = await centersResponse.json();
                
                if (centersData.success) {
                    const centerSelect = document.getElementById('mapCenter');
                    centerSelect.innerHTML = '<option value="">جميع المراكز</option>';
                    centersData.centers.forEach(center => {
                        centerSelect.innerHTML += `<option value="${center.id}">${center.name}</option>`;
                    });
                }
                
            } catch (error) {
                console.error('خطأ في تحميل فلاتر الخريطة:', error);
            }
        }

        // تحديث بيانات الخريطة
        async function updateMapData() {
            try {
                // جمع معايير الفلترة
                const filters = {
                    observation_type_id: document.getElementById('mapObservationType').value,
                    center_id: document.getElementById('mapCenter').value,
                    time_range: document.getElementById('mapTimeRange').value
                };
                
                // إرسال طلب للحصول على الملاحظات
                const response = await fetch('/api/observations/map-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(filters)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    mapObservations = data.observations;
                    updateMapMarkers();
                    updateMapStats(data.stats);
                } else {
                    showNotification('خطأ في تحميل بيانات الخريطة', 'error');
                }
                
            } catch (error) {
                console.error('خطأ في تحديث بيانات الخريطة:', error);
                showNotification('خطأ في الاتصال بالخادم', 'error');
            }
        }

        // تحديث علامات الخريطة
        function updateMapMarkers() {
            // حذف العلامات الموجودة
            mapMarkers.forEach(marker => {
                riyadhMap.removeLayer(marker);
            });
            mapMarkers = [];
            
            // إضافة علامات جديدة
            mapObservations.forEach(obs => {
                // تحديد موقع تقريبي بناءً على الحي والطريق
                const coordinates = generateCoordinatesForLocation(obs.neighborhood, obs.road);
                
                if (coordinates) {
                    const marker = L.circleMarker(coordinates, {
                        radius: 8,
                        fillColor: getMarkerColor(obs.priority),
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                    
                    // إضافة popup للعلامة
                    const popupContent = `
                        <div class="marker-popup">
                            <h4>${obs.observation_type_name}</h4>
                            <p><strong>الآلية:</strong> ${obs.vehicle_number}</p>
                            <p><strong>الموقع:</strong> ${obs.neighborhood} - ${obs.road}</p>
                            <p><strong>التاريخ:</strong> ${formatHijriDateTime(obs.observed_at)}</p>
                            <p><strong>الراصد:</strong> ${obs.observer_name}</p>
                            <button class="btn btn-sm btn-primary" onclick="showObservationDetails(${obs.id})">
                                عرض التفاصيل
                            </button>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    marker.addTo(riyadhMap);
                    mapMarkers.push(marker);
                }
            });
        }

        // تحديث إحصائيات الخريطة
        function updateMapStats(stats) {
            document.getElementById('mapTotalObservations').textContent = stats.total || 0;
            document.getElementById('mapHighPriorityObservations').textContent = stats.high_priority || 0;
            document.getElementById('mapPendingObservations').textContent = stats.pending || 0;
            document.getElementById('mapResolvedObservations').textContent = stats.resolved || 0;
        }

        // تحديد لون العلامة حسب الأولوية
        function getMarkerColor(priority) {
            switch (priority) {
                case 'high': return '#dc3545';
                case 'medium': return '#ffc107';
                case 'low': return '#28a745';
                default: return '#007bff';
            }
        }

        // توليد إحداثيات تقريبية للموقع
        function generateCoordinatesForLocation(neighborhood, road) {
            // قاعدة بيانات تقريبية لأحياء الرياض
            const riyadhNeighborhoods = {
                'العليا': [24.7136, 46.6753],
                'الملز': [24.6877, 46.7219],
                'النخيل': [24.7461, 46.6289],
                'الروضة': [24.7731, 46.6289],
                'السليمانية': [24.7136, 46.6753],
                'المروج': [24.6877, 46.7219],
                'الياسمين': [24.7461, 46.6289],
                'النرجس': [24.7731, 46.6289],
                'الورود': [24.7136, 46.6753],
                'الربيع': [24.6877, 46.7219]
            };
            
            // البحث عن الحي في القاعدة
            let baseCoords = riyadhNeighborhoods[neighborhood];
            
            // إذا لم يوجد الحي، استخدم إحداثيات وسط الرياض
            if (!baseCoords) {
                baseCoords = [24.7136, 46.6753];
            }
            
            // إضافة تشويش عشوائي صغير لتجنب تداخل العلامات
            const randomOffset = 0.01;
            const lat = baseCoords[0] + (Math.random() - 0.5) * randomOffset;
            const lng = baseCoords[1] + (Math.random() - 0.5) * randomOffset;
            
            return [lat, lng];
        }

        // عرض تفاصيل الملاحظة
        function showObservationDetails(observationId) {
            const obs = mapObservations.find(o => o.id === observationId);
            if (!obs) return;
            
            const infoContainer = document.getElementById('selectedObservationInfo');
            const contentContainer = document.getElementById('observationInfoContent');
            
            contentContainer.innerHTML = `
                <div class="observation-detail">
                    <span class="observation-detail-label">نوع الملاحظة:</span>
                    <span class="observation-detail-value">${obs.observation_type_name}</span>
                </div>
                <div class="observation-detail">
                    <span class="observation-detail-label">رقم الآلية:</span>
                    <span class="observation-detail-value">${obs.vehicle_number}</span>
                </div>
                <div class="observation-detail">
                    <span class="observation-detail-label">المركز:</span>
                    <span class="observation-detail-value">${obs.center_name}</span>
                </div>
                <div class="observation-detail">
                    <span class="observation-detail-label">الموقع:</span>
                    <span class="observation-detail-value">${obs.neighborhood} - ${obs.road}</span>
                </div>
                <div class="observation-detail">
                    <span class="observation-detail-label">وقت الملاحظة:</span>
                    <span class="observation-detail-value">${formatHijriDateTime(obs.observed_at)}</span>
                </div>
                <div class="observation-detail">
                    <span class="observation-detail-label">المدة:</span>
                    <span class="observation-detail-value">${obs.duration_minutes || 'غير محدد'} دقيقة</span>
                </div>
                <div class="observation-detail">
                    <span class="observation-detail-label">الراصد:</span>
                    <span class="observation-detail-value">${obs.observer_name}</span>
                </div>
                <div class="observation-detail">
                    <span class="observation-detail-label">الأولوية:</span>
                    <span class="observation-detail-value">
                        <span class="badge badge-${obs.priority === 'high' ? 'danger' : obs.priority === 'medium' ? 'warning' : 'success'}">
                            ${obs.priority === 'high' ? 'عالية' : obs.priority === 'medium' ? 'متوسطة' : 'منخفضة'}
                        </span>
                    </span>
                </div>
                <div class="observation-detail">
                    <span class="observation-detail-label">الحالة:</span>
                    <span class="observation-detail-value">
                        <span class="badge badge-${obs.status === 'resolved' ? 'success' : obs.status === 'in_progress' ? 'warning' : 'secondary'}">
                            ${obs.status === 'resolved' ? 'محلولة' : obs.status === 'in_progress' ? 'قيد المعالجة' : 'معلقة'}
                        </span>
                    </span>
                </div>
                ${obs.action_taken ? `
                <div class="observation-detail">
                    <span class="observation-detail-label">الإجراء المتخذ:</span>
                    <span class="observation-detail-value">${obs.action_taken}</span>
                </div>
                ` : ''}
            `;
            
            infoContainer.style.display = 'block';
        }

        // إغلاق معلومات الملاحظة
        function closeObservationInfo() {
            document.getElementById('selectedObservationInfo').style.display = 'none';
        }

        // ===== دوال التقارير والتصدير =====

        // إنشاء تقرير مخصص
        async function generateReport() {
            try {
                const period = document.getElementById('reportPeriod').value;
                const center = document.getElementById('reportCenter').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                const filters = {
                    period: period,
                    center_id: center || null,
                    start_date: startDate || null,
                    end_date: endDate || null
                };

                const response = await fetch('/api/reports/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(filters)
                });

                const data = await response.json();
                
                if (data.success) {
                    // تحديث الإحصائيات
                    updateAdvancedStats(data.statistics);
                    
                    // تحديث الرسوم البيانية
                    drawTypeChart(data.statistics.by_type || []);
                    drawPerformanceChart(data.statistics.by_user || []);
                    drawTimelineChart(data.statistics.timeline || []);
                    drawCentersChart(data.statistics.by_center || []);
                    
                    // تحديث الجداول
                    updateTopObserversTable(data.statistics.top_observers || []);
                    updateTopTypesTable(data.statistics.by_type || []);
                    
                    showAlert('تم إنشاء التقرير بنجاح', 'success');
                } else {
                    showAlert('خطأ في إنشاء التقرير: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('خطأ في إنشاء التقرير:', error);
                showAlert('خطأ في الاتصال بالخادم', 'error');
            }
        }

        // تصدير مخطط بياني
        function exportChart(chartId) {
            try {
                const canvas = document.getElementById(chartId);
                if (!canvas) {
                    showAlert('لم يتم العثور على المخطط', 'error');
                    return;
                }

                // إنشاء رابط التحميل
                const link = document.createElement('a');
                link.download = `${chartId}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png');
                
                // تحميل الملف
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert('تم تصدير المخطط بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في تصدير المخطط:', error);
                showAlert('خطأ في تصدير المخطط', 'error');
            }
        }

        // تصدير جدول إلى Excel
        async function exportTableToExcel(tableId) {
            try {
                const table = document.getElementById(tableId);
                if (!table) {
                    showAlert('لم يتم العثور على الجدول', 'error');
                    return;
                }

                // جمع بيانات الجدول
                const headers = [];
                const rows = [];
                
                // استخراج العناوين
                const headerCells = table.querySelectorAll('thead th');
                headerCells.forEach(cell => headers.push(cell.textContent.trim()));
                
                // استخراج الصفوف
                const bodyRows = table.querySelectorAll('tbody tr');
                bodyRows.forEach(row => {
                    const rowData = [];
                    const cells = row.querySelectorAll('td');
                    cells.forEach(cell => rowData.push(cell.textContent.trim()));
                    rows.push(rowData);
                });

                const data = {
                    table_name: tableId,
                    headers: headers,
                    rows: rows
                };

                const response = await fetch('/api/reports/export-table', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${tableId}_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    showAlert('تم تصدير الجدول بنجاح', 'success');
                } else {
                    showAlert('خطأ في تصدير الجدول', 'error');
                }
            } catch (error) {
                console.error('خطأ في تصدير الجدول:', error);
                showAlert('خطأ في تصدير الجدول', 'error');
            }
        }

        // تصدير تقرير شامل
        async function exportFullReport(format) {
            try {
                const period = document.getElementById('reportPeriod').value;
                const center = document.getElementById('reportCenter').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                const filters = {
                    period: period,
                    center_id: center || null,
                    start_date: startDate || null,
                    end_date: endDate || null,
                    format: format
                };

                const response = await fetch('/api/reports/export-full', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(filters)
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    
                    const extension = format === 'pdf' ? 'pdf' : 'xlsx';
                    link.download = `تقرير_شامل_${new Date().toISOString().split('T')[0]}.${extension}`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    showAlert(`تم تصدير التقرير الشامل بصيغة ${format.toUpperCase()} بنجاح`, 'success');
                } else {
                    showAlert('خطأ في تصدير التقرير الشامل', 'error');
                }
            } catch (error) {
                console.error('خطأ في تصدير التقرير الشامل:', error);
                showAlert('خطأ في تصدير التقرير الشامل', 'error');
            }
        }

        // طباعة التقرير
        function printReport() {
            try {
                // إخفاء العناصر غير المرغوب في طباعتها
                const sidebar = document.querySelector('.sidebar');
                const header = document.querySelector('.header');
                const exportTools = document.querySelector('.export-tools');
                
                const originalSidebarDisplay = sidebar.style.display;
                const originalHeaderDisplay = header.style.display;
                const originalExportDisplay = exportTools.style.display;
                
                sidebar.style.display = 'none';
                header.style.display = 'none';
                exportTools.style.display = 'none';
                
                // طباعة الصفحة
                window.print();
                
                // إعادة إظهار العناصر
                sidebar.style.display = originalSidebarDisplay;
                header.style.display = originalHeaderDisplay;
                exportTools.style.display = originalExportDisplay;
                
            } catch (error) {
                console.error('خطأ في طباعة التقرير:', error);
                showAlert('خطأ في طباعة التقرير', 'error');
            }
        }

        // تحديث جدول أفضل الراصدين
        function updateTopObserversTable(observers) {
            const tbody = document.getElementById('topObserversTableBody');
            tbody.innerHTML = '';
            
            observers.forEach((observer, index) => {
                const row = document.createElement('tr');
                const performance = observer.resolved_count > 0 ? 
                    Math.round((observer.resolved_count / observer.total_count) * 100) : 0;
                
                let rating = 'ممتاز';
                if (performance < 50) rating = 'ضعيف';
                else if (performance < 70) rating = 'مقبول';
                else if (performance < 85) rating = 'جيد';
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${observer.name}</td>
                    <td>${observer.total_count}</td>
                    <td>${observer.resolved_count}</td>
                    <td>${performance}%</td>
                    <td>
                        <span class="badge badge-${performance >= 85 ? 'success' : performance >= 70 ? 'warning' : 'danger'}">
                            ${rating}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // تحديث جدول أنواع الملاحظات
        function updateTopTypesTable(types) {
            const tbody = document.getElementById('topTypesTableBody');
            tbody.innerHTML = '';
            
            const total = types.reduce((sum, type) => sum + type.count, 0);
            
            types.forEach((type, index) => {
                const row = document.createElement('tr');
                const percentage = total > 0 ? Math.round((type.count / total) * 100) : 0;
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${type.name}</td>
                    <td>${type.count}</td>
                    <td>${percentage}%</td>
                    <td>
                        <i class="fas fa-arrow-up text-success" title="متزايد"></i>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // رسم مخطط الملاحظات عبر الوقت
        function drawTimelineChart(timelineData) {
            const canvas = document.getElementById('timelineChart');
            const ctx = canvas.getContext('2d');
            
            // مسح المخطط السابق
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!timelineData || timelineData.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('لا توجد بيانات للعرض', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // رسم مخطط خطي بسيط
            const padding = 40;
            const chartWidth = canvas.width - (padding * 2);
            const chartHeight = canvas.height - (padding * 2);
            
            const maxValue = Math.max(...timelineData.map(d => d.count));
            const stepX = chartWidth / (timelineData.length - 1);
            
            // رسم المحاور
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
            
            // رسم الخط
            ctx.strokeStyle = '#007bff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            timelineData.forEach((point, index) => {
                const x = padding + (index * stepX);
                const y = canvas.height - padding - ((point.count / maxValue) * chartHeight);
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
        }

        // رسم مخطط توزيع المراكز
        function drawCentersChart(centersData) {
            const canvas = document.getElementById('centersChart');
            const ctx = canvas.getContext('2d');
            
            // مسح المخطط السابق
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!centersData || centersData.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('لا توجد بيانات للعرض', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // رسم مخطط أعمدة
            const padding = 40;
            const chartWidth = canvas.width - (padding * 2);
            const chartHeight = canvas.height - (padding * 2);
            
            const maxValue = Math.max(...centersData.map(d => d.count));
            const barWidth = chartWidth / centersData.length - 10;
            
            const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1'];
            
            centersData.forEach((center, index) => {
                const barHeight = (center.count / maxValue) * chartHeight;
                const x = padding + (index * (barWidth + 10));
                const y = canvas.height - padding - barHeight;
                
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // عرض القيمة
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(center.count, x + barWidth/2, y - 5);
            });
        }

        // تحديث التقارير عند تغيير الفلاتر
        function updateReports() {
            const period = document.getElementById('reportPeriod').value;
            const customRange1 = document.getElementById('customDateRange');
            const customRange2 = document.getElementById('customDateRange2');
            
            if (period === 'custom') {
                customRange1.style.display = 'block';
                customRange2.style.display = 'block';
            } else {
                customRange1.style.display = 'none';
                customRange2.style.display = 'none';
            }
            
            // إعادة إنشاء التقرير تلقائياً
            generateReport();
        }
    </script>
    
    <script>
        // ربط مباشر لنموذج تسجيل الدخول
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up login form...');
            
            // فحص إذا كان هناك auto_login من صفحة تسجيل الدخول
            const urlParams = new URLSearchParams(window.location.search);
            const autoLogin = urlParams.get('auto_login');
            
            if (autoLogin === 'true') {
                console.log('Auto login detected, showing app...');
                // التأكد من وجود بيانات المستخدم
                const userData = localStorage.getItem('currentUser');
                if (userData) {
                    currentUser = JSON.parse(userData);
                    console.log('User data loaded:', currentUser);
                    
                    // تشغيل showApp
                    if (typeof showApp === 'function') {
                        showApp();
                    } else {
                        console.log('showApp function not found, applying permissions manually');
                        // إخفاء نموذج تسجيل الدخول
                        const loginContainer = document.querySelector('.login-container');
                        if (loginContainer) {
                            loginContainer.style.display = 'none';
                        }
                        
                        // إظهار المنصة الرئيسية
                        const appContainer = document.querySelector('.app-container');
                        if (appContainer) {
                            appContainer.style.display = 'block';
                        }
                        
                        // تطبيق الصلاحيات
                        if (currentUser.role === 'supervisor') {
                            const supervisorElements = document.querySelectorAll('.supervisor-only');
                            supervisorElements.forEach(element => {
                                element.style.display = 'block';
                            });
                            
                            const userNameElements = document.querySelectorAll('.user-name');
                            userNameElements.forEach(element => {
                                element.textContent = currentUser.full_name || 'مشرف النظام';
                            });
                            
                            const userRoleElements = document.querySelectorAll('.user-role');
                            userRoleElements.forEach(element => {
                                element.textContent = 'مشرف';
                            });
                        }
                    }
                    
                    // إزالة auto_login من URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
            
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                console.log('Login form found, attaching event listener...');
                
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    console.log('Login form submitted');
                    
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    
                    console.log('Username:', username);
                    
                    if (!username || !password) {
                        showError('يرجى إدخال اسم المستخدم وكلمة المرور');
                        return;
                    }
                    
                    try {
                        console.log('Sending login request...');
                        const response = await fetch('/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ username, password })
                        });
                        
                        const data = await response.json();
                        console.log('Login response:', data);
                        
                        if (data.success) {
                            console.log('Login successful, showing app...');
                            currentUser = data.user;
                            localStorage.setItem('currentUser', JSON.stringify(data.user));
                            localStorage.setItem('token', 'authenticated');
                            
                            // إخفاء نموذج تسجيل الدخول
                            const loginContainer = document.querySelector('.login-container');
                            if (loginContainer) {
                                loginContainer.style.display = 'none';
                            }
                            
                            // إظهار المنصة
                            const appContainer = document.querySelector('.app-container');
                            if (appContainer) {
                                appContainer.style.display = 'block';
                            }
                            
                            // تطبيق صلاحيات المستخدم
                            if (data.user.role === 'monitor') {
                                if (typeof applyObserverPermissions === 'function') {
                                    applyObserverPermissions();
                                } else {
                                    console.error('applyObserverPermissions function not found');
                                }
                            } else if (data.user.role === 'supervisor') {
                                // إظهار الخيارات الإدارية للمشرف
                                if (typeof applySupervisorPermissions === 'function') {
                                    applySupervisorPermissions();
                                } else {
                                    console.log('Applying supervisor permissions...');
                                    // إظهار العناصر الإدارية
                                    document.querySelectorAll('.supervisor-only').forEach(element => {
                                        element.style.display = 'block';
                                    });
                                }
                            }
                            
                            // تحديث اسم المستخدم في الواجهة
                            const userNameElement = document.querySelector('.user-name');
                            if (userNameElement) {
                                userNameElement.textContent = data.user.full_name || data.user.username;
                            }
                            
                            // تحديث اسم المستخدم في العنصر الصحيح
                            const userNameDisplay = document.getElementById('userName');
                            if (userNameDisplay) {
                                userNameDisplay.textContent = data.user.full_name || data.user.username;
                            }
                            
                            // تحديث دور المستخدم
                            const userRoleDisplay = document.getElementById('userRole');
                            if (userRoleDisplay) {
                                userRoleDisplay.textContent = data.user.role === 'supervisor' ? 'مشرف' : 'راصد';
                            }
                            
                            // تحميل البيانات الأولية
                            if (typeof loadInitialData === 'function') {
                                loadInitialData();
                            }
                            
                            // إعداد event listeners للتنقل
                            setupEventListeners();
                        } else {
                            console.log('Login failed:', data.error);
                            showError(data.error || 'فشل في تسجيل الدخول');
                        }
                    } catch (error) {
                        console.error('خطأ في تسجيل الدخول:', error);
                        showError('حدث خطأ في الاتصال بالخادم');
                    }
                });
                
                console.log('Login form event listener attached successfully!');
            } else {
                console.error('Login form not found!');
            }
         }
        
        // تطبيق صلاحيات المشرف
        function applySupervisorPermissions() {
            console.log('Applying supervisor permissions...');
            
            // إظهار جميع العناصر الإدارية
            document.querySelectorAll('.supervisor-only').forEach(element => {
                element.style.display = 'block';
            });
            
            // إظهار عناصر التنقل الإدارية
            const adminNavItems = document.querySelectorAll('[data-page="admin"], [data-page="users"], [data-page="shifts"], [data-page="centers"], [data-page="vehicles"]');
            adminNavItems.forEach(item => {
                if (item.parentElement) {
                    item.parentElement.style.display = 'block';
                }
                item.style.display = 'block';
            });
            
            // إضافة مؤشر للمشرف في الواجهة
            addSupervisorIndicators();
        }
        
        // إضافة مؤشرات للمشرف في الواجهة
        function addSupervisorIndicators() {
            // إضافة تنبيه في لوحة التحكم
            const dashboardPage = document.getElementById('dashboardPage');
            if (dashboardPage) {
                const existingAlert = dashboardPage.querySelector('.supervisor-alert');
                if (!existingAlert) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'supervisor-alert';
                    alertDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-crown"></i>
                            <strong>صلاحيات المشرف:</strong> لديك وصول كامل لجميع ميزات النظام.
                        </div>
                    `;
                    dashboardPage.insertBefore(alertDiv, dashboardPage.firstChild.nextSibling);
                }
            }
        }
        
        // إعداد event listeners للتنقل
        function setupEventListeners() {
            // التنقل
            document.querySelectorAll('.nav-item, .sidebar-link').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    if (page) {
                        showPage(page);
                    }
                });
            });
        }
        
        // دالة إظهار المنصة الرئيسية
        function showApp() {
            // إخفاء نموذج تسجيل الدخول
            const loginContainer = document.querySelector('.login-container');
            if (loginContainer) {
                loginContainer.style.display = 'none';
            }
            
            // إظهار المنصة الرئيسية
            const appContainer = document.querySelector('.app-container');
            if (appContainer) {
                appContainer.style.display = 'block';
            }
            
            // تطبيق الصلاحيات حسب دور المستخدم
            if (currentUser) {
                if (currentUser.role === 'supervisor') {
                    applySupervisorPermissions();
                } else if (currentUser.role === 'monitor') {
                    applyObserverPermissions();
                }
            }
            
            console.log('تم إظهار المنصة الرئيسية');
        }
        
        // دالة تطبيق صلاحيات المشرف
        function applySupervisorPermissions() {
            // إظهار جميع العناصر الإدارية
            const supervisorElements = document.querySelectorAll('.supervisor-only');
            supervisorElements.forEach(element => {
                element.style.display = 'block';
            });
            
            // تحديث اسم المستخدم
            const userNameElements = document.querySelectorAll('.user-name');
            userNameElements.forEach(element => {
                element.textContent = currentUser.full_name || 'مشرف النظام';
            });
            
            // تحديث دور المستخدم
            const userRoleElements = document.querySelectorAll('.user-role');
            userRoleElements.forEach(element => {
                element.textContent = 'مشرف';
            });
            
            console.log('تم تطبيق صلاحيات المشرف');
        }
        
        // دالة تسجيل الخروج
        function logout() {
            // مسح البيانات المحفوظة
            localStorage.clear();
            sessionStorage.clear();
            currentUser = null;
            
            // إخفاء المنصة
            const appContainer = document.querySelector('.app-container');
            if (appContainer) {
                appContainer.style.display = 'none';
            }
            
            // إظهار نموذج تسجيل الدخول
            const loginContainer = document.querySelector('.login-container');
            if (loginContainer) {
                loginContainer.style.display = 'flex';
            }
            
            // مسح الحقول
            const usernameField = document.getElementById('username');
            const passwordField = document.getElementById('password');
            if (usernameField) usernameField.value = '';
            if (passwordField) passwordField.value = '';
            
            console.log('تم تسجيل الخروج بنجاح');
        }
    </script>
</body>
</html>
